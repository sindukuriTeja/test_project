<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>PestiVid - Agricultural Blockchain Platform (Web3 Demo)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- Tailwind CSS -->
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <!-- Font Awesome -->
  <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.5.2/css/all.min.css" rel="stylesheet">
  <!-- Google Fonts (Inter) -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">

  <!-- Vue.js -->
  <script src="https://cdn.jsdelivr.net/npm/vue@2.6.14/dist/vue.min.js"></script>
  <!-- Axios, Buffer, Marked.js (for Markdown) -->
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/buffer@6.0.3/index.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

  <!-- Component/Page Scripts (Order: Vue -> Components -> App Logic) -->
  <!-- These files (ChatInterface.js, MessagingPage.js, app.js) are not provided,
       so their functionality is assumed or placeholder.
       If they define global Vue components, they should be loaded after Vue.js
       and before the main Vue instance script.
  -->
  <!-- <script src="js/components/ChatInterface.js"></script> -->
  <!-- <script src="js/pages/MessagingPage.js"></script> -->
  <!-- <script src="js/app.js"></script> --> <!-- This might be redundant if the main Vue instance is inline below -->

  <!-- Styling -->
  <style>
    body { font-family: 'Inter', system-ui, sans-serif; background: #f9fafb; }
    html { scroll-behavior: smooth; overflow-x: hidden; }
    ::-webkit-scrollbar { width: 5px; height: 5px; }
    ::-webkit-scrollbar-track { background: #f1f1f1; }
    ::-webkit-scrollbar-thumb { background: #ccc; border-radius: 5px; }
    ::-webkit-scrollbar-thumb:hover { background: #aaa; }
    * { scrollbar-width: thin; scrollbar-color: #ccc #f1f1f1; -ms-overflow-style: -ms-autohiding-scrollbar; }
    .progress-bar { height: 8px; border-radius: 4px; background: #e5e7eb; overflow: hidden; }
    .progress-fill { height: 100%; border-radius: 4px; transition: width 0.5s ease; }
    .modal-scrollable { max-height: 85vh; overflow-y: auto; }
    .project-updates-list { max-height: 150px; overflow-y: auto; border: 1px solid #e5e7eb; border-radius: 0.375rem; padding: 0.75rem; background-color: #f9fafb; }
    .project-update-item { padding-bottom: 0.5rem; margin-bottom: 0.5rem; border-bottom: 1px solid #f3f4f6; }
    .project-update-item:last-child { border-bottom: none; margin-bottom: 0; }
    .message-view-container { scroll-behavior: smooth; }
    .notification-badge { position: absolute; top: -5px; right: -8px; min-width: 18px; height: 18px; background-color: #ef4444; border-radius: 9px; color: white; font-size: 10px; font-weight: 600; line-height: 18px; text-align: center; padding: 0 4px; box-shadow: 0 1px 3px rgba(0,0,0,0.2); }
    .mobile-notification-badge { display: inline-block; background-color: #ef4444; color: white; border-radius: 50%; width: 16px; height: 16px; font-size: 9px; line-height: 16px; text-align: center; vertical-align: top; margin-left: 4px; }
    .notification-toast-container { position: fixed; bottom: 20px; right: 20px; z-index: 1000; display: flex; flex-direction: column-reverse; gap: 10px; align-items: flex-end; }
    .notification-toast { min-width: 250px; max-width: 350px; background-color: #fff; color: #333; padding: 1rem; border-radius: 0.5rem; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15); display: flex; align-items: center; opacity: 0; transform: translateX(100%); transition: all 0.4s cubic-bezier(0.68, -0.55, 0.27, 1.55); }
    .notification-toast.show { opacity: 1; transform: translateX(0); }
    .notification-toast .icon { margin-right: 0.75rem; font-size: 1.25rem; }
    .notification-toast .icon-info { color: #3b82f6; } .notification-toast .icon-success { color: #10b981; } .notification-toast .icon-warning { color: #f59e0b; } .notification-toast .icon-error { color: #ef4444; }
    .notification-toast .message { font-size: 0.875rem; line-height: 1.3; }
    .notification-toast .close-btn { margin-left: auto; padding-left: 0.75rem; color: #9ca3af; cursor: pointer; background: none; border: none; font-size: 1rem; }
    .notification-toast .close-btn:hover { color: #6b7280; }
    .new-badge { position: absolute; top: -8px; right: -8px; background-color: #3b82f6; color: white; font-size: 10px; font-weight: bold; padding: 2px 6px; border-radius: 10px; box-shadow: 0 1px 2px rgba(0,0,0,0.2); }
    .loading-modal { position: fixed; inset: 0; background-color: rgba(0, 0, 0, 0.6); display: flex; justify-content: center; align-items: center; z-index: 9999; }
    .loading-content { background-color: white; padding: 2rem; border-radius: 0.5rem; text-align: center; box-shadow: 0 10px 25px rgba(0,0,0,0.1); }
    .loading-content .fa-spinner { font-size: 2rem; color: #10b981; margin-bottom: 1rem; }

    /* Chatbot Styles */
    .chatbot-container { display: flex; flex-direction: column; height: calc(100vh - 230px); max-height: 700px; border: 1px solid #e5e7eb; border-radius: 0.5rem; overflow: hidden; }
    .chatbot-messages { flex-grow: 1; padding: 1rem; overflow-y: auto; background-color: #f9fafb; space-y-4; }
    .chat-message { display: flex; max-width: 80%; margin-bottom: 0.5rem;}
    .chat-message.user { margin-left: auto; flex-direction: row-reverse; }
    .chat-message .message-content { display: flex; align-items: flex-end; }
    .chat-message.user .message-content { flex-direction: row-reverse; }
    .chat-message .message-bubble { padding: 0.75rem 1rem; border-radius: 1rem; line-height: 1.5; word-wrap: break-word; max-width: calc(100% - 3.5rem); /* Account for avatar */ }
    .chat-message.user .message-bubble { background-color: #10b981; color: white; border-bottom-right-radius: 0.25rem; }
    .chat-message.bot .message-bubble { background-color: #e5e7eb; color: #1f2937; border-bottom-left-radius: 0.25rem; }
    .chat-message .avatar { width: 2.5rem; height: 2.5rem; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 600; margin: 0 0.5rem; flex-shrink: 0; align-self: flex-end; }
    .chat-message.user .avatar { background-color: #059669; color: white; }
    .chat-message.bot .avatar { background-color: #d1d5db; color: #4b5563; }
    .chatbot-input-area { border-top: 1px solid #e5e7eb; padding: 1rem; background-color: #fff; display: flex; gap: 0.75rem; }
    .chatbot-input-area input { flex-grow: 1; padding: 0.75rem 1rem; border: 1px solid #d1d5db; border-radius: 0.375rem; font-size: 0.875rem; }
    .chatbot-input-area input:focus { outline: none; border-color: #10b981; box-shadow: 0 0 0 2px rgba(16, 185, 129, 0.2); }
    .chatbot-input-area button { background-color: #10b981; color: white; padding: 0.75rem 1.25rem; border-radius: 0.375rem; font-weight: 600; font-size: 0.875rem; }
    .chatbot-input-area button:hover { background-color: #059669; }
    .chatbot-input-area button:disabled { background-color: #9ca3af; cursor: not-allowed; }
    .typing-indicator span { height: 8px; width: 8px; margin: 0 2px; background-color: #9ca3af; border-radius: 50%; display: inline-block; animation: bounce 1.4s infinite ease-in-out both; }
    .typing-indicator span:nth-child(1) { animation-delay: -0.32s; }
    .typing-indicator span:nth-child(2) { animation-delay: -0.16s; }
    @keyframes bounce { 0%, 80%, 100% { transform: scale(0); } 40% { transform: scale(1.0); } }
    .message-bubble ul, .message-bubble ol { margin-left: 1.5rem; margin-top: 0.5rem; margin-bottom: 0.5rem; }
    .message-bubble li { margin-bottom: 0.25rem; }
    .message-bubble p { margin-bottom: 0.5rem; }
    .message-bubble p:last-child { margin-bottom: 0; }
    .message-bubble strong, .message-bubble b { font-weight: 600; }
    .message-bubble em, .message-bubble i { font-style: italic; }
    .message-bubble pre { background-color: #f3f4f6; padding: 0.5rem; border-radius: 0.25rem; overflow-x: auto; font-family: monospace; font-size: 0.875em; margin: 0.5rem 0; }
    .message-bubble code { background-color: #f3f4f6; padding: 0.1em 0.3em; border-radius: 0.25rem; font-family: monospace; font-size: 0.875em; }
    .message-bubble pre code { padding: 0; background-color: transparent; }

    /* Avatar Assistant Styles */
    @keyframes pulse-slow {
      0%, 100% { opacity: 1; transform: scale(1); }
      50% { opacity: 0.8; transform: scale(1.05); }
    }
    .animate-pulse-slow {
      animation: pulse-slow 2s infinite ease-in-out;
    }
    .avatar-input-mic-btn.listening i {
        animation: pulse-red 1.5s infinite;
    }
    @keyframes pulse-red {
      0%, 100% { color: #ef4444; transform: scale(1); }
      50% { color: #f87171; transform: scale(1.1); }
    }

    /* NEW Authentication Screen Styles (from first example) */
    .auth-container {
        min-height: 100vh;
        background-color: #e5f7ed;
    }
    .auth-card {
        backdrop-filter: blur(10px);
        background: rgba(255, 255, 255, 0.98);
    }
    /* End NEW Authentication Screen Styles */
  </style>
</head>
<body class="text-gray-900">
<div id="app" class="flex flex-col min-h-screen">

  <!-- NEW Authentication Screen (Login/Signup) -->
  <div v-if="!isAuthenticated" class="auth-container flex items-center justify-center p-4">
      <div class="auth-card rounded-2xl shadow-2xl p-8 max-w-md w-full">
          <!-- Logo -->
          <div class="text-center mb-8">
              <div class="inline-flex items-center justify-center w-16 h-16 bg-green-100 rounded-full mb-4">
                  <i class="fas fa-seedling text-green-600 text-2xl"></i>
              </div>
              <h1 class="text-3xl font-bold text-gray-900 mb-2">PestiVid</h1>
              <p class="text-gray-600">Agricultural Blockchain Platform</p>
          </div>

          <!-- Login Form -->
          <div v-if="!showSignup">
              <h2 class="text-2xl font-bold text-gray-900 mb-6 text-center">Welcome Back</h2>
              <form @submit.prevent="login" class="space-y-4">
                  <div>
                      <label class="block text-sm font-medium text-gray-700 mb-1">Email</label>
                      <input v-model="loginForm.email" type="email" required
                             class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-green-500 focus:border-green-500"
                             placeholder="Enter your email">
                  </div>
                  <div>
                      <label class="block text-sm font-medium text-gray-700 mb-1">Password</label>
                      <input v-model="loginForm.password" type="password" required
                             class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-green-500 focus:border-green-500"
                             placeholder="Enter your password">
                  </div>
                  <div class="flex items-center justify-between">
                      <label class="flex items-center">
                          <input v-model="loginForm.remember" type="checkbox" class="form-checkbox mr-2 text-green-600">
                          <span class="text-sm text-gray-600">Remember me</span>
                      </label>
                      <a href="#" @click.prevent="forgotPassword" class="text-sm text-green-600 hover:text-green-500">
                          Forgot password?
                      </a>
                  </div>
                  <button type="submit" class="w-full bg-green-600 hover:bg-green-700 text-white py-2 px-4 rounded-md font-medium transition-colors">
                      <i class="fas fa-sign-in-alt mr-2"></i>Sign In
                  </button>
              </form>
              <div class="mt-6 text-center">
                  <p class="text-gray-600">Don't have an account?
                      <a href="#" @click.prevent="showSignup = true" class="text-green-600 hover:text-green-500 font-medium">Sign up</a>
                  </p>
              </div>
          </div>

          <!-- Signup Form -->
          <div v-if="showSignup">
              <h2 class="text-2xl font-bold text-gray-900 mb-6 text-center">Create Account</h2>
              <form @submit.prevent="signup" class="space-y-4">
                  <div>
                      <label class="block text-sm font-medium text-gray-700 mb-1">Full Name</label>
                      <input v-model="signupForm.name" type="text" required
                             class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-green-500 focus:border-green-500"
                             placeholder="Enter your full name">
                  </div>
                  <div>
                      <label class="block text-sm font-medium text-gray-700 mb-1">Email</label>
                      <input v-model="signupForm.email" type="email" required
                             class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-green-500 focus:border-green-500"
                             placeholder="Enter your email">
                  </div>
                  <div>
                      <label class="block text-sm font-medium text-gray-700 mb-1">Role</label>
                      <select v-model="signupForm.role" required
                              class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-green-500 focus:border-green-500 bg-white">
                          <option value="">Select your role</option>
                          <option value="farmer">Farmer</option>
                          <option value="buyer">Buyer</option>
                          <option value="investor">Investor</option>
                      </select>
                  </div>
                  <div>
                      <label class="block text-sm font-medium text-gray-700 mb-1">Password</label>
                      <input v-model="signupForm.password" type="password" required
                             class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-green-500 focus:border-green-500"
                             placeholder="Create a password">
                      <p class="text-xs text-gray-500 mt-1">At least 6 characters.</p>
                  </div>
                  <div>
                      <label class="block text-sm font-medium text-gray-700 mb-1">Confirm Password</label>
                      <input v-model="signupForm.confirmPassword" type="password" required
                             class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-green-500 focus:border-green-500"
                             placeholder="Confirm your password">
                  </div>
                  <div class="flex items-center">
                      <input v-model="signupForm.acceptTerms" type="checkbox" required class="form-checkbox mr-2 text-green-600">
                      <span class="text-sm text-gray-600">I agree to the
                          <a href="#" @click.prevent class="text-green-600 hover:text-green-500">Terms and Conditions</a>
                      </span>
                  </div>
                  <button type="submit" class="w-full bg-green-600 hover:bg-green-700 text-white py-2 px-4 rounded-md font-medium transition-colors">
                      <i class="fas fa-user-plus mr-2"></i>Create Account
                  </button>
              </form>
              <div class="mt-6 text-center">
                  <p class="text-gray-600">Already have an account?
                      <a href="#" @click.prevent="showSignup = false" class="text-green-600 hover:text-green-500 font-medium">Sign in</a>
                  </p>
              </div>
          </div>
      </div>
  </div>

  <!-- This wrapper for authenticated content ensures flex-grow applies correctly -->
  <template v-if="isAuthenticated">
    <!-- Chat Interface -->
    <!--
    <div class="chat-interface-container p-4">
        <chat-interface></chat-interface>
    </div>
    -->

    <div class="flex-grow">
        <!-- Header/Navbar (Shown if authenticated) -->
        <header class="bg-white shadow sticky top-0 z-30">
            <div class="max-w-7xl mx-auto px-5 py-4 flex justify-between items-center">
                <div class="flex items-center space-x-2">
                    <span class="text-2xl text-green-700 font-semibold"><i class="fas fa-seedling mr-1"></i>PestiVid</span>
                </div>
                <nav class="hidden md:flex space-x-5 items-center">
                    <a href="#" @click.prevent="switchPage('landing')" :class="{'font-bold text-green-700': current==='landing'}" class="hover:text-green-600">Home</a>
                    <a href="#" @click.prevent="switchPage('messaging')" :class="{'font-bold text-green-700': current==='messaging'}" class="hover:text-green-600 relative">
                        <i class="fas fa-comments mr-1"></i>Messages
                        <span v-if="unreadMessageCount > 0" class="notification-badge">{{ unreadMessageCount }}</span>
                    </a>
                    <!-- Farmer Menu -->
                    <template v-if="role==='farmer'">
                        <a href="#" @click.prevent="switchPage('farmerPestiVid')" :class="{'font-bold text-green-700': current==='farmerPestiVid'}" class="hover:text-green-600">PestiVid</a>
                        <a href="#" @click.prevent="switchPage('farmerAgriStream')" :class="{'font-bold text-green-700': current==='farmerAgriStream'}" class="hover:text-green-600">AgriStream</a>
                        <a href="#" @click.prevent="switchPage('farmerSell')" :class="{'font-bold text-green-700': current==='farmerSell'}" class="hover:text-green-600">Sell</a>
                        <a href="#" @click.prevent="switchPage('farmerFunding')" :class="{'font-bold text-green-700': current==='farmerFunding'}" class="hover:text-green-600">Get Funding</a>
                        <a href="#" @click.prevent="switchPage('plantRecommendation')" :class="{'font-bold text-green-700': current==='plantRecommendation'}" class="hover:text-green-600">PlantRecommend</a>
                        <a href="#" @click.prevent="switchPage('farmerChatbot')" :class="{'font-bold text-green-700': current==='farmerChatbot'}" class="hover:text-green-600"><i class="fas fa-robot mr-1"></i>AgriBot</a>
                    </template>
                    <!-- Buyer Menu -->
                    <template v-if="role==='buyer'">
                        <a href="#" @click.prevent="switchPage('buyerAgriSell')" :class="{'font-bold text-green-700': current==='buyerAgriSell'}" class="hover:text-green-600">AgriSell</a>
                    </template>
                    <!-- Investor Menu -->
                    <template v-if="role==='investor'">
                        <a href="#" @click.prevent="switchPage('investorProjects')" :class="{'font-bold text-green-700': current==='investorProjects'}" class="hover:text-green-600">Projects</a>
                        <a href="#" @click.prevent="switchPage('investorPortfolio')" :class="{'font-bold text-green-700': current==='investorPortfolio'}" class="hover:text-green-600">Portfolio</a>
                    </template>
                    <a href="#" @click.prevent="switchPage('userProfile')" :class="{'font-bold text-green-700': current==='userProfile'}" class="bg-green-600 text-white text-xs rounded-full px-3 py-1 select-none ml-2 hover:bg-green-700 flex items-center">
                        <i class="fas fa-user-circle mr-1"></i> {{ userNameDisplay }}
                    </a>
                    <!-- Logout Button -->
                    <button @click="logout" class="text-gray-500 hover:text-red-600 text-xs px-2 py-1 rounded border border-gray-300 hover:border-red-400">
                        <i class="fas fa-sign-out-alt mr-1"></i>Logout
                    </button>
                </nav>
                <button class="md:hidden text-gray-500 focus:outline-none" @click="showMobileMenu = !showMobileMenu">
                    <i class="fas fa-bars text-2xl"></i>
                </button>
            </div>
            <!-- Mobile Dropdown -->
            <div v-show="showMobileMenu" class="md:hidden bg-white border-t z-40">
                <div class="py-2 flex flex-col space-y-1 px-4">
                    <a href="#" @click.prevent="switchPage('landing');showMobileMenu=false" :class="{'font-bold text-green-700': current==='landing'}">Home</a>
                    <a href="#" @click.prevent="switchPage('messaging');showMobileMenu=false" :class="{'font-bold text-green-700': current==='messaging'}" class="flex items-center">
                        <i class="fas fa-comments mr-1"></i>Messages
                        <span v-if="unreadMessageCount > 0" class="mobile-notification-badge">{{ unreadMessageCount }}</span>
                    </a>
                    <!-- Farmer Menu -->
                    <template v-if="role==='farmer'">
                        <a href="#" @click.prevent="switchPage('farmerPestiVid');showMobileMenu=false" :class="{'font-bold text-green-700': current==='farmerPestiVid'}">PestiVid</a>
                        <a href="#" @click.prevent="switchPage('farmerAgriStream');showMobileMenu=false" :class="{'font-bold text-green-700': current==='farmerAgriStream'}">AgriStream</a>
                        <a href="#" @click.prevent="switchPage('farmerSell');showMobileMenu=false" :class="{'font-bold text-green-700': current==='farmerSell'}">Sell</a>
                        <a href="#" @click.prevent="switchPage('farmerFunding');showMobileMenu=false" :class="{'font-bold text-green-700': current==='farmerFunding'}">Get Funding</a>
                        <a href="#" @click.prevent="switchPage('plantRecommendation');showMobileMenu=false" :class="{'font-bold text-green-700': current==='plantRecommendation'}">PlantRecommend</a>
                        <a href="#" @click.prevent="switchPage('farmerChatbot');showMobileMenu=false" :class="{'font-bold text-green-700': current==='farmerChatbot'}"><i class="fas fa-robot mr-1"></i>AgriBot</a>
                    </template>
                    <!-- Buyer Menu -->
                    <template v-if="role==='buyer'">
                        <a href="#" @click.prevent="switchPage('buyerAgriSell');showMobileMenu=false" :class="{'font-bold text-green-700': current==='buyerAgriSell'}">AgriSell</a>
                    </template>
                    <!-- Investor Menu -->
                    <template v-if="role==='investor'">
                        <a href="#" @click.prevent="switchPage('investorProjects');showMobileMenu=false" :class="{'font-bold text-green-700': current==='investorProjects'}">Projects</a>
                        <a href="#" @click.prevent="switchPage('investorPortfolio');showMobileMenu=false" :class="{'font-bold text-green-700': current==='investorPortfolio'}">Portfolio</a>
                    </template>
                    <div class="border-t mt-2 pt-2 flex justify-between items-center">
                        <a href="#" @click.prevent="switchPage('userProfile');showMobileMenu=false" :class="{'font-bold text-green-700': current==='userProfile'}" class="inline-block bg-green-600 text-white text-xs rounded px-2 py-1 ml-1 flex items-center">
                            <i class="fas fa-user-circle mr-1"></i> {{ userNameDisplay }}
                        </a>
                        <!-- Logout Button Mobile -->
                        <button @click="logout(); showMobileMenu=false;" class="text-red-500 hover:text-red-700 text-xs px-2 py-1 rounded border border-red-300 hover:bg-red-50">
                            <i class="fas fa-sign-out-alt mr-1"></i>Logout
                        </button>
                    </div>
                </div>
            </div>
        </header>

        <!-- Main Content (Shown if authenticated) -->
        <main class="flex-1 max-w-7xl mx-auto w-full px-4 pt-8 pb-8">
            <!-- Main Content Sections (Conditional on current page) -->
            <div>
                <!-- Landing Section -->
                <section v-if="current==='landing'">
                    <div class="flex flex-col md:flex-row items-center mb-12 pt-2">
                        <div class="md:w-1/2 md:pr-8">
                        <h1 class="text-4xl font-bold text-green-800 mb-4">PestiVid: Blockchain Transparency in Agriculture</h1>
                        <p class="mb-5 text-gray-800 text-lg leading-relaxed">A secure, video-verified agricultural marketplace with investment opportunities. Farmers prove quality and safety via field recordings stored on decentralized storage (IPFS Simulated) and linked via a simulated blockchain. Buyers purchase crops with complete confidence and traceability. Investors fund projects with transparent returns.</p>
                        <ul class="text-gray-700 mb-7 space-y-1 text-base">
                            <li><i class="fas fa-link text-green-500 mr-2"></i>Solana blockchain-simulated transactions</li>
                            <li><i class="fas fa-cloud-upload-alt text-green-400 mr-2"></i>Decentralized video storage (IPFS via Pinata Gateway)</li>
                            <li><i class="fas fa-search-dollar text-green-400 mr-2"></i>Full traceability for buyers</li>
                            <li><i class="fas fa-handshake text-green-500 mr-2"></i>Direct, transparent marketplace transactions</li>
                            <li><i class="fas fa-chart-line text-green-500 mr-2"></i>Investment opportunities for funders</li>
                            <li><i class="fas fa-comments text-green-500 mr-2"></i>Secure messaging between users</li>
                            <li><i class="fas fa-bell text-green-500 mr-2"></i>Real-time notifications</li>
                        </ul>
                        <div class="mt-4 space-x-2">
                            <button class="bg-green-600 hover:bg-green-700 text-white px-6 py-2 rounded transition" @click="getStarted">Get Started</button>
                            <button class="bg-white border border-green-600 text-green-600 px-6 py-2 rounded transition" @click="switchPage('buyerAgriSell')">Browse Marketplace</button>
                        </div>
                        </div>
                        <div class="md:w-1/2 mt-10 md:mt-0 flex flex-col items-center">
                        <video controls playsinline webkit-playsinline class="rounded-lg shadow-md border w-full max-w-md mx-auto">
                            <source src="https://www.w3schools.com/html/mov_bbb.mp4" type="video/mp4">
                            Demo video: your browser does not support video.
                        </video>
                        </div>
                    </div>
                    <div class="mt-10">
                        <h2 class="text-2xl text-green-700 font-semibold mb-3">How It Works</h2>
                        <div class="grid grid-cols-1 md:grid-cols-4 gap-5">
                        <div class="bg-white rounded-lg shadow p-5 flex flex-col items-center">
                            <i class="fas fa-video text-2xl text-green-500 mb-3"></i>
                            <span class="font-bold mb-1">1. Video Recording</span>
                            <p class="text-sm text-gray-600 text-center">Farmers film direct evidence of their crop and practices.</p>
                        </div>
                        <div class="bg-white rounded-lg shadow p-5 flex flex-col items-center">
                            <i class="fas fa-cloud-upload-alt text-2xl text-green-500 mb-3"></i>
                            <span class="font-bold mb-1">2. Upload to IPFS</span>
                            <p class="text-sm text-gray-600 text-center">Videos & info are securely uploaded and stored decentrally.</p>
                        </div>
                        <div class="bg-white rounded-lg shadow p-5 flex flex-col items-center">
                            <i class="fas fa-search-dollar text-2xl text-green-500 mb-3"></i>
                            <span class="font-bold mb-1">3. Verification</span>
                            <p class="text-sm text-gray-600 text-center">Buyers view blockchain-linked video before any purchase.</p>
                        </div>
                        <div class="bg-white rounded-lg shadow p-5 flex flex-col items-center">
                            <i class="fas fa-handshake text-2xl text-green-500 mb-3"></i>
                            <span class="font-bold mb-1">4. Marketplace</span>
                            <p class="text-sm text-gray-600 text-center">Login provides access to buying, selling, or investing.</p>
                        </div>
                        </div>
                    </div>

                    <div class="mt-16 bg-green-50 rounded-lg p-8">
                        <h2 class="text-2xl text-green-700 font-semibold mb-3">Agricultural Investment Platform</h2>
                        <div class="flex flex-col md:flex-row items-center">
                        <div class="w-full">
                            <p class="mb-4 text-gray-700">Invest in verified agricultural projects with full transparency. Track your investments through simulated Solana blockchain technology and share in the harvest profits.</p>
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 my-6">
                            <div class="bg-white rounded p-4 shadow-sm">
                                <i class="fas fa-seedling text-green-600 text-2xl mb-2"></i>
                                <h3 class="font-bold mb-1">Fund Crops</h3>
                                <p class="text-sm">Invest in specific crops with transparent land use and practices.</p>
                            </div>
                            <div class="bg-white rounded p-4 shadow-sm">
                                <i class="fas fa-coins text-green-600 text-2xl mb-2"></i>
                                <h3 class="font-bold mb-1">Share Returns</h3>
                                <p class="text-sm">Receive dividends based on harvest yields and market prices.</p>
                            </div>
                            <div class="bg-white rounded p-4 shadow-sm">
                                <i class="fas fa-shield-alt text-green-600 text-2xl mb-2"></i>
                                <h3 class="font-bold mb-1">Secure Blockchain</h3>
                                <p class="text-sm">All investments and harvests recorded on immutable ledger (Simulated).</p>
                            </div>
                            </div>
                            <button class="bg-green-600 hover:bg-green-700 text-white px-6 py-2 rounded transition mt-2" @click="switchPage('investorProjects')">Become an Investor</button>
                        </div>
                        </div>
                    </div>
                </section>

                <!-- Farmer PestiVid Section -->
                <section v-if="current==='farmerPestiVid'" class="max-w-3xl mx-auto mt-6">
                <h2 class="text-2xl font-bold text-green-700 mb-4"><i class="fas fa-video mr-2"></i>PestiVid: Record Crop Video</h2>
                <div class="bg-yellow-100 border-l-4 border-yellow-500 text-yellow-700 p-4 mb-4" role="alert">
                    <p class="font-bold">Security Notice:</p>
                    <p class="text-sm">Direct browser uploads are for DEMO ONLY. For production, use a backend to handle uploads securely via a pinning service API (like Pinata).</p>
                </div>
                <div class="bg-blue-100 border-l-4 border-blue-500 text-blue-700 p-4 mb-4" role="alert">
                    <p class="font-bold">User: {{ currentUser ? currentUser.name : 'Farmer' }} (Role: Farmer)</p>
                    <p class="text-sm">You are logged in as a Farmer. You can upload videos and manage farmer features.</p>
                </div>
                <div class="bg-white rounded shadow-md p-6 space-y-6">
                    <form @submit.prevent>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-4">
                        <div> <label class="block text-gray-600 mb-1 text-sm">Crop Type</label> <input v-model="recordForm.crop" class="w-full px-2 py-2 border rounded text-sm" required placeholder="e.g., Tomatoes"> </div>
                        <div> <label class="block text-gray-600 mb-1 text-sm">Field Location</label> <input v-model="recordForm.location" class="w-full px-2 py-2 border rounded text-sm" required placeholder="e.g., South Field"> </div>
                        <div> <label class="block text-gray-600 mb-1 text-sm">Pesticide Used</label> <input v-model="recordForm.pesticide" class="w-full px-2 py-2 border rounded text-sm" required placeholder="e.g., Neem Oil"> </div>
                        <div> <label class="block text-gray-600 mb-1 text-sm">Pesticide Company</label> <input v-model="recordForm.pesticideCompany" class="w-full px-2 py-2 border rounded text-sm" required placeholder="e.g., AgriChem"> </div>
                    </div>
                    <div class="mb-4">
                        <label class="block text-gray-600 mb-1 text-sm">Purpose of this Video:</label>
                        <div class="flex flex-col sm:flex-row sm:space-x-4 space-y-2 sm:space-y-0">
                            <label class="flex items-center"> <input type="radio" v-model="recordForm.purpose" value="agristream" class="form-radio text-green-600"> <span class="ml-2 text-sm text-gray-700">For AgriStream (General)</span> </label>
                            <label class="flex items-center"> <input type="radio" v-model="recordForm.purpose" value="sell" class="form-radio text-green-600"> <span class="ml-2 text-sm text-gray-700">To List for Sale</span> </label>
                            <label class="flex items-center"> <input type="radio" v-model="recordForm.purpose" value="funding" class="form-radio text-green-600"> <span class="ml-2 text-sm text-gray-700">For Funding Request</span> </label>
                        </div>
                    </div>
                    </form>
                    <div>
                    <div class="aspect-w-16 aspect-h-9 bg-black rounded mb-3 relative" style="min-height:200px">
                        <video ref="liveVideo" v-show="showLive" class="w-full h-full rounded absolute inset-0 object-cover" autoplay muted playsinline webkit-playsinline style="background:#111"></video>
                        <video v-if="recordBlobUrl" :src="recordBlobUrl" controls playsinline webkit-playsinline class="w-full h-full rounded absolute inset-0 object-cover" style="background:#181818"></video>
                        <div v-if="!showLive && !recordBlobUrl" class="absolute inset-0 flex justify-center items-center h-full text-gray-400"><i class="fas fa-video-slash fa-2x"></i></div>
                    </div>
                    <div class="flex flex-wrap gap-3 mb-2 items-center">
                        <button type="button" :disabled="recording" @click="startVideo" :class="{'opacity-50 cursor-not-allowed': recording}" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded text-sm">
                        <i :class="recording ? 'fas fa-spinner fa-spin' : (recordBlobUrl ? 'fas fa-redo' : 'fas fa-record-vinyl')" class="mr-1"></i>
                        {{ recordBlobUrl ? 'Re-Record' : (recording ? 'Starting...' : 'Start Recording') }}
                        </button>
                        <button v-if="recording" type="button" @click="stopVideo" class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded text-sm"> <i class="fas fa-stop mr-1"></i>Stop </button>
                        <button v-if="recordBlobUrl && !uploading" type="button" @click="uploadVideo" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded text-sm"> <i class="fas fa-upload mr-1"></i>Upload to IPFS (Simulated) </button>
                        <div v-if="uploading && !showLoadingModal" class="flex items-center text-blue-600 text-sm ml-3"> <i class="fas fa-spinner fa-spin mr-2"></i> Uploading... Please wait. </div>
                    </div>
                    <p class="text-xs mt-2 text-gray-500">Allow camera access. Video file is stored locally until upload.</p>
                    <div v-if="uploadCid" class="text-green-600 mt-3 bg-green-50 p-3 rounded border border-green-200 text-sm">
                        <div class="flex items-center mb-2"> <i class="fas fa-check-circle mr-2"></i> Uploaded to IPFS! (Simulated) CID: <span class="font-mono bg-green-100 px-1 py-0.5 rounded break-all ml-1">{{ uploadCid }}</span> </div>
                        <div v-if="lastUploadedVideoFileHash" class="flex items-center mb-2 text-xs"> <i class="fas fa-fingerprint mr-2 text-gray-500"></i> Video File Hash (SHA256): <span class="font-mono bg-green-100 px-1 py-0.5 rounded break-all ml-1 text-gray-700">{{ lastUploadedVideoFileHash }}</span> </div>
                        <p v-if="lastUploadedVideoPurpose === 'agristream'" class="mt-1 text-gray-700"> This video is now available in your AgriStream. <a href="#" @click.prevent="navigateToPageWithParam('farmerAgriStream', 'highlightCid', uploadCid)" class="text-blue-700 underline font-medium hover:text-blue-800 ml-1">View in AgriStream</a>. <br>You can also use it later to: <a href="#" @click.prevent="goToListing(uploadCid)" class="text-green-700 underline font-medium hover:text-green-800">Create a Listing</a>, or <a href="#" @click.prevent="navigateToPageWithParam('farmerFunding', 'cid', uploadCid)" class="text-purple-700 underline font-medium hover:text-purple-800 ml-1">Use for Funding Request</a>. </p>
                        <p v-if="lastUploadedVideoPurpose === 'sell'" class="mt-1 text-gray-700"> Video uploaded for selling! You should be redirected to create a listing. If not, <a href="#" @click.prevent="navigateToPageWithParam('farmerSell', 'cid', uploadCid)" class="text-green-700 underline font-medium hover:text-green-800">click here to complete the listing</a>. </p>
                        <p v-if="lastUploadedVideoPurpose === 'funding'" class="mt-1 text-gray-700"> Video uploaded for a funding request! You should be redirected to create the request. If not, <a href="#" @click.prevent="navigateToPageWithParam('farmerFunding', 'cid', uploadCid)" class="text-purple-700 underline font-medium hover:text-purple-800">click here to complete the funding request</a>. </p>
                    </div>
                    <div v-if="uploadError" class="text-red-600 mt-3 bg-red-50 p-2 rounded border border-red-200 text-sm"> <i class="fas fa-exclamation-triangle mr-1"></i> {{ uploadError }} </div>
                    </div>
                </div>
                </section>
                <!-- Farmer AgriStream Section -->
                <section v-if="current==='farmerAgriStream'" class="max-w-4xl mx-auto mt-6">
                    <h2 class="text-2xl font-bold text-green-700 mb-5"><i class="fas fa-stream mr-2"></i>AgriStream: My Crop Videos</h2>
                    <div class="bg-blue-100 border-l-4 border-blue-500 text-blue-700 p-4 mb-4" role="alert">
                        <p class="font-bold">User: {{ currentUser ? currentUser.name : 'Farmer' }} (Role: Farmer)</p>
                        <p class="text-sm">Viewing videos uploaded by you. Demo videos from other sample users may also appear if they exist in the shared data.</p>
                    </div>
                    <div class="bg-white rounded shadow-md p-6">
                        <div v-if="farmerVideos.length===0" class="text-gray-600 text-center p-6 bg-gray-50 rounded"> <i class="fas fa-film text-4xl text-gray-400 mb-3"></i><br> No uploads yet. Go to <a href="#" class="text-green-700 underline" @click.prevent="switchPage('farmerPestiVid')">PestiVid</a> to upload. </div>
                        <div v-else class="space-y-6">
                        <div v-for="vid in farmerVideos" :key="vid.cid + '-' + vid.farmerWallet" class="flex flex-col md:flex-row items-start border-b last:border-b-0 pb-6 gap-6 transition-all duration-500" :ref="'videoCard-' + vid.cid" :class="{'bg-yellow-50 border-l-4 border-yellow-400 shadow-lg transform scale-102': vid.cid === highlightedAgriStreamVideoCid}">
                            <div class="w-full md:w-60 flex-shrink-0"> <video :src="getVideoUrl(vid.cid, vid.storageType)" controls playsinline webkit-playsinline class="rounded shadow w-full bg-black"></video> </div>
                            <div class="flex-1">
                            <div class="font-bold text-lg">{{ vid.crop }}</div>
                            <div class="text-xs mb-1" :class="{ 'text-blue-700': vid.purpose === 'sell', 'text-purple-700': vid.purpose === 'funding', 'text-gray-600': vid.purpose === 'agristream' || !vid.purpose }"> Intended for: <span class="font-semibold"> {{ vid.purpose === 'sell' ? 'Listing for Sale' : (vid.purpose === 'funding' ? 'Funding Request' : (vid.purpose === 'agristream' ? 'AgriStream (General)' : 'N/A')) }} </span> </div>
                            <div class="text-sm mb-1">Location: <span class="font-mono text-gray-700">{{ vid.location }}</span></div>
                            <div class="text-sm mb-1">Pesticide: <span class="font-mono text-gray-700">{{ vid.pesticide }}</span></div>
                            <div class="text-sm mb-1">Pesticide Co.: <span class="font-mono text-gray-700">{{ vid.pesticideCompany || 'N/A' }}</span></div>
                            <div class="text-xs text-gray-500 mb-2">CID ({{vid.storageType}}): <span class="font-mono break-all">{{ vid.cid }}</span></div>
                            <div class="text-xs text-gray-400 mb-1">File Hash (SHA256): <span class="font-mono break-all" :title="vid.videoFileHash || 'N/A'">{{ vid.videoFileHash ? vid.videoFileHash.substring(0,10) + '...' : 'N/A' }}</span></div>
                            <a :href="getVideoUrl(vid.cid, vid.storageType)" target="_blank" class="text-blue-600 hover:underline text-xs mr-3"><i class="fas fa-external-link-alt mr-1"></i>View on IPFS Gateway</a>
                            <button v-if="!isListed(vid.cid) && vid.farmerWallet === currentUserIdentifier" @click="goToListing(vid.cid)" class="text-green-600 hover:underline text-xs"> <i class="fas fa-tags mr-1"></i> {{ (vid.purpose === 'sell' && !isListed(vid.cid)) ? 'Complete Listing' : 'Create Listing' }} </button>
                            <span v-else-if="isListed(vid.cid) && vid.farmerWallet === currentUserIdentifier" class="text-gray-500 text-xs"><i class="fas fa-check mr-1"></i>Already Listed</span>
                            <button v-if="!isUsedInFunding(vid.cid) && (vid.purpose === 'funding' || vid.purpose === 'agristream') && vid.farmerWallet === currentUserIdentifier" @click="navigateToPageWithParam('farmerFunding', 'cid', vid.cid)" class="text-purple-600 hover:underline text-xs ml-2"> <i class="fas fa-hand-holding-usd mr-1"></i> {{ (vid.purpose === 'funding' && !isUsedInFunding(vid.cid)) ? 'Complete Funding Request' : 'Use for Funding' }} </button>
                            <span v-if="isUsedInFunding(vid.cid) && vid.farmerWallet === currentUserIdentifier" class="text-gray-500 text-xs ml-2"><i class="fas fa-check mr-1"></i>Used for Funding</span>
                            </div>
                        </div>
                        </div>
                    </div>
                </section>
                <!-- Farmer Sell Section -->
                <section v-if="current==='farmerSell'" class="max-w-2xl mx-auto mt-6">
                    <h2 class="text-2xl font-bold text-green-700 mb-4"><i class="fas fa-tags mr-2"></i>Sell Farm Crop on Marketplace</h2>
                    <div class="bg-blue-100 border-l-4 border-blue-500 text-blue-700 p-4 mb-4" role="alert">
                        <p class="font-bold">User: {{ currentUser ? currentUser.name : 'Farmer' }} (Role: Farmer)</p>
                        <p class="text-sm">Create and manage listings for your own uploaded videos.</p>
                    </div>
                    <div class="bg-white rounded shadow-md p-6">
                        <form @submit.prevent="createListing">
                        <div class="mb-4">
                            <label class="block text-gray-600 mb-1">Select Uploaded Video (Unlisted only)</label>
                            <select v-model="listingForm.cid" class="w-full px-3 py-2 border rounded bg-white mb-2" required>
                            <option value="" disabled>Select video...</option>
                            <option v-for="vid in availableVideosForListing" :key="vid.cid" :value="vid.cid"> {{ vid.crop }} ({{ vid.location }}) - Pest: {{ vid.pesticide }} by {{ vid.pesticideCompany || 'N/A' }} ({{vid.storageType}}) </option>
                            <option v-if="availableVideosForListing.length === 0" disabled>No unlisted videos available</option>
                            </select>
                            <p v-if="farmerVideos.length === 0" class="text-xs text-red-500">You need to upload a video first via PestiVid.</p>
                            <p v-if="farmerVideos.length > 0 && availableVideosForListing.length === 0" class="text-xs text-yellow-600">All your eligible videos are already listed or not marked for sale.</p>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-5">
                            <div> <label class="block text-gray-600 mb-1">Min Price (SOL)</label> <input type="number" v-model="listingForm.minPrice" class="w-full px-3 py-2 border rounded" min="0.01" step="0.01" required placeholder="e.g., 0.5"> </div>
                            <div> <label class="block text-gray-600 mb-1">Max Price (SOL)</label> <input type="number" v-model="listingForm.maxPrice" class="w-full px-3 py-2 border rounded" :min="listingForm.minPrice || 0.01" step="0.01" required placeholder="e.g., 1.5"> </div>
                        </div>
                        <div class="mb-4"> <label class="flex items-center"> <input type="checkbox" v-model="listingForm.notifyBuyers" class="form-checkbox h-4 w-4 text-green-600"> <span class="ml-2 text-sm text-gray-700">Notify potential buyers about this listing</span> </label> </div>
                        <button type="submit" class="bg-green-600 hover:bg-green-700 text-white px-6 py-2 rounded w-full" :disabled="!listingForm.cid"> <i class="fas fa-plus-circle mr-1"></i>Create Listing </button>
                        </form>
                        <div v-if="createdListingId" class="bg-green-100 text-green-700 px-4 py-3 mt-4 rounded font-medium text-sm"> <i class="fas fa-check mr-1"></i> Listing created successfully! Listing ID/Tx: <span class="font-mono text-xs">{{ createdListingId.substring(0,10) }}...</span> <div v-if="listingNotificationSent" class="mt-1 text-sm"> <i class="fas fa-bell mr-1"></i> Buyers have been notified about your new listing. </div> </div>
                        <div class="mt-8">
                        <h3 class="font-semibold mb-2 text-gray-700">Your Active Listings</h3>
                        <div v-if="farmerListings.length===0" class="text-gray-600 text-sm bg-gray-50 p-4 rounded text-center">You have no active listings.</div>
                        <ul v-else class="space-y-3">
                            <li v-for="l in farmerListings" :key="l._id" class="py-3 px-4 border rounded flex flex-col sm:flex-row justify-between sm:items-center text-sm bg-white shadow-sm">
                            <div> <span class="font-medium">{{ l.crop }}</span> <span class="text-xs text-gray-500 ml-1"> ({{l.location}})</span> <br> <span class="text-xs text-gray-500"> CID: {{l.cid.substring(0, 8)}}... ({{l.storageType}})</span> | <span class="text-xs text-gray-500"> Pest. Co: {{ l.pesticideCompany || 'N/A' }}</span> <div v-if="l.notificationSent" class="text-xs text-green-600 mt-1"> <i class="fas fa-bell mr-1"></i> Buyers notified </div> </div>
                            <div class="mt-2 sm:mt-0 text-right"> <span>Min: <span class="font-mono font-semibold">{{ l.minPrice }}</span> SOL</span><br> <span>Max: <span class="font-mono font-semibold">{{ l.maxPrice }}</span> SOL</span> <button v-if="!l.notificationSent" @click="notifyBuyersAboutListing(l, true)" class="ml-2 text-xs text-blue-600 border border-blue-300 rounded px-2 py-1 hover:bg-blue-50"> <i class="fas fa-bell-slash mr-1"></i> Notify </button> </div>
                            </li>
                        </ul>
                        </div>
                    </div>
                </section>
                <!-- Farmer Funding Section -->
                <section v-if="current==='farmerFunding'" class="max-w-3xl mx-auto mt-6">
                    <h2 class="text-2xl font-bold text-green-700 mb-4"><i class="fas fa-money-bill-wave mr-2"></i>Request Funding for Your Farm</h2>
                    <div class="bg-blue-100 border-l-4 border-blue-500 text-blue-700 p-4 mb-4" role="alert">
                        <p class="font-bold">User: {{ currentUser ? currentUser.name : 'Farmer' }} (Role: Farmer)</p>
                        <p class="text-sm">Create and manage funding requests for your own projects.</p>
                    </div>
                    <div class="bg-white rounded shadow-md p-6">
                        <form @submit.prevent="createFundingRequest_V1">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                            <div> <label class="block text-gray-600 mb-1 text-sm">Project Title</label> <input v-model="fundingForm.title" class="w-full px-3 py-2 border rounded text-sm" required placeholder="e.g., Organic Tomato Expansion"> </div>
                            <div> <label class="block text-gray-600 mb-1 text-sm">Crop Type</label> <input v-model="fundingForm.crop" class="w-full px-3 py-2 border rounded text-sm" required placeholder="e.g., Roma Tomatoes"> </div>
                            <div> <label class="block text-gray-600 mb-1 text-sm">Land Size (Acres)</label> <input type="number" v-model.number="fundingForm.acres" class="w-full px-3 py-2 border rounded text-sm" min="0.1" step="0.1" required placeholder="e.g., 5.5"> </div>
                            <div> <label class="block text-gray-600 mb-1 text-sm">Funding Required (SOL)</label> <input type="number" v-model.number="fundingForm.amount" class="w-full px-3 py-2 border rounded text-sm" min="1" step="0.1" required placeholder="e.g., 50"> </div>
                            <div> <label class="block text-gray-600 mb-1 text-sm">Growing Method</label> <select v-model="fundingForm.method" class="w-full px-3 py-2 border rounded bg-white text-sm" required> <option value="">Select method...</option> <option value="organic">Organic</option> <option value="conventional">Conventional</option> <option value="hydroponic">Hydroponic</option> <option value="aquaponic">Aquaponic</option> <option value="regenerative">Regenerative</option> </select> </div>
                            <div> <label class="block text-gray-600 mb-1 text-sm">Expected ROI (%)</label> <input type="number" v-model.number="fundingForm.roi" class="w-full px-3 py-2 border rounded text-sm" min="1" max="100" required placeholder="e.g., 15"> </div>
                        </div>
                        <div class="mb-4"> <label class="block text-gray-600 mb-1 text-sm">Select Video Evidence</label> <select v-model="fundingForm.cid" class="w-full px-3 py-2 border rounded bg-white mb-2 text-sm" required> <option value="" disabled>Select video...</option> <option v-for="vid in availableVideosForFunding" :key="vid.cid" :value="vid.cid"> {{ vid.crop }} ({{ vid.location }}) - {{ vid.pesticideCompany || 'N/A' }} ({{vid.storageType}}) </option> <option v-if="availableVideosForFunding.length === 0" disabled>No videos suitable for funding available</option> </select> <p v-if="farmerVideos.length === 0" class="text-xs text-red-500">You need to upload a video first via PestiVid.</p> <p v-if="farmerVideos.length > 0 && availableVideosForFunding.length === 0" class="text-xs text-yellow-600">All your eligible videos are already used for funding or not marked for funding.</p> </div>
                        <div class="mb-4"> <label class="block text-gray-600 mb-1 text-sm">Project Description</label> <textarea v-model="fundingForm.description" class="w-full px-3 py-2 border rounded text-sm" rows="4" required placeholder="Describe your project, growing practices, and how funds will be used..."></textarea> </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6"> <div> <label class="block text-gray-600 mb-1 text-sm">Timeline (Months)</label> <input type="number" v-model.number="fundingForm.timeline" class="w-full px-3 py-2 border rounded text-sm" min="1" max="36" required placeholder="How many months until harvest?"> </div> <div> <label class="block text-gray-600 mb-1 text-sm">Investor Share (%)</label> <input type="number" v-model.number="fundingForm.investorShare" class="w-full px-3 py-2 border rounded text-sm" min="1" max="80" required placeholder="Percentage of harvest profit for investors"> </div> </div>
                        <button type="submit" class="bg-green-600 hover:bg-green-700 text-white px-6 py-2 rounded w-full" :disabled="!fundingForm.cid"> <i class="fas fa-paper-plane mr-1"></i> Create Funding Request </button>
                        </form>
                        <div v-if="createdFundingRequest" class="bg-green-100 text-green-700 px-4 py-2 mt-4 rounded font-medium text-sm"> <i class="fas fa-check mr-1"></i> Funding request created and is now visible to investors! </div>
                        <div class="mt-8">
                        <h3 class="font-semibold mb-2 text-gray-700">Your Active Funding Requests</h3>
                        <div v-if="farmerFundingRequests.length===0" class="text-gray-600 text-sm bg-gray-50 p-4 rounded text-center">You have no active funding requests.</div>
                        <div v-else class="space-y-4">
                            <div v-for="req in farmerFundingRequests" :key="req._id" class="border rounded-lg overflow-hidden shadow-sm bg-white">
                            <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center p-4 bg-gray-50 border-b"> <h4 class="font-bold mb-2 sm:mb-0">{{ req.title }}</h4> <div class="flex items-center space-x-2"> <span :class="{'bg-yellow-100 text-yellow-800': req.status === 'pending', 'bg-green-100 text-green-800': req.status === 'funded', 'bg-blue-100 text-blue-800': req.status === 'partially_funded'}" class="px-2 py-1 rounded text-xs font-medium"> {{ req.status === 'pending' ? 'Pending' : req.status === 'funded' ? 'Fully Funded' : (req.status === 'partially_funded' ? 'Partially Funded' : req.status) }} </span> </div> </div>
                            <div class="p-4">
                                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-4 text-sm"> <div> <div class="text-xs text-gray-500">Crop</div> <div>{{ req.crop }}</div> </div> <div> <div class="text-xs text-gray-500">Land Size</div> <div>{{ req.acres }} acres</div> </div> <div> <div class="text-xs text-gray-500">Required</div> <div>{{ req.amount }} SOL</div> </div> <div> <div class="text-xs text-gray-500">Investor Share</div> <div>{{ req.investorShare }}%</div> </div> </div>
                                <div class="mb-4"> <div class="text-xs text-gray-500 mb-1">Funding Progress</div> <div class="progress-bar"> <div class="progress-fill bg-green-500" :style="{width: fundingProgressPercent(req) + '%'}"></div> </div> <div class="flex justify-between text-xs mt-1"> <span>{{ req.fundedAmount || 0 }} SOL raised</span> <span>{{ fundingProgressPercent(req) }}% Complete</span> </div> </div>
                                <div v-if="req.fundedAmount > 0 && req.investors && req.investors.length > 0" class="mb-4"> <div class="text-xs text-gray-500 mb-2">Investors ({{req.investors.length}})</div> <div class="text-sm max-h-24 overflow-y-auto border rounded p-2 bg-gray-50 space-y-1"> <div v-for="investor in req.investors" :key="investor.investorId || investor._id" class="flex justify-between items-center py-1 text-xs"> <span><i class="fas fa-user text-gray-400 mr-1"></i>{{ getFarmerDisplayIdentifier(investor.investorId, 6) }}</span> <span class="font-mono bg-blue-100 text-blue-800 px-1 rounded">{{ investor.amount }} SOL</span> </div> </div> </div>
                                <div class="flex justify-end mt-4"> <button v-if="req.status !== 'funded'" class="px-3 py-1 text-xs bg-red-100 text-red-700 rounded hover:bg-red-200" @click="cancelFundingRequest_V1(req._id)"> <i class="fas fa-times mr-1"></i>Cancel Request </button> <span v-if="req.status === 'funded'" class="text-xs text-green-600"><i class="fas fa-check-circle mr-1"></i>Fully Funded!</span> </div>
                            </div>
                            </div>
                        </div>
                        </div>
                    </div>
                </section>
                <!-- Buyer AgriSell Section -->
                <section v-if="current==='buyerAgriSell'" class="max-w-6xl mx-auto mt-6">
                    <h2 class="text-2xl font-bold text-green-700 mb-3"><i class="fas fa-shopping-basket mr-2"></i>AgriSell: Marketplace</h2>
                    <div class="bg-blue-100 border-l-4 border-blue-500 text-blue-700 p-4 mb-4" role="alert">
                        <p class="font-bold">User: {{ currentUser ? currentUser.name : 'Buyer' }} (Role: Buyer)</p>
                        <p class="text-sm">Browse listings from farmers and simulate purchases.</p>
                    </div>
                <div class="bg-white rounded shadow-md p-6 mb-7">
                    <div class="flex flex-col md:flex-row md:items-end gap-5">
                    <div class="w-full md:w-48"> <label class="text-gray-600 text-sm">Crop Type</label> <select v-model="buyerFilters.crop" class="w-full px-2 py-1 border rounded bg-white text-sm"> <option value="">All</option> <option v-for="c in uniqueCrops" :key="c">{{c}}</option> </select> </div>
                    <div class="flex-1"> <label class="text-gray-600 text-sm">Location</label> <input v-model="buyerFilters.location" class="w-full px-2 py-1 border rounded text-sm" placeholder="Search by location..."> </div>
                    <div class="flex-1"> <label class="text-gray-600 text-sm">Pesticide Co.</label> <input v-model="buyerFilters.pesticideCompany" class="w-full px-2 py-1 border rounded text-sm" placeholder="Search by pesticide company..."> </div>
                    <button type="button" class="bg-gray-100 hover:bg-gray-200 text-gray-700 px-4 py-1 rounded text-sm mt-2 md:mt-0" @click="resetBuyerFilters"> <i class="fas fa-undo mr-1"></i> Reset Filters </button>
                    </div>
                </div>
                <div v-if="filteredListings.length === 0" class="text-gray-600 bg-gray-50 p-8 text-center rounded"> <i class="fas fa-search text-4xl text-gray-400 mb-3"></i><br> No listings found matching your criteria. Try adjusting your filters. </div>
                <div v-else class="grid gap-8 grid-cols-1 md:grid-cols-2 lg:grid-cols-3">
                    <div v-for="l in filteredListings" :key="l._id" class="bg-white rounded shadow p-4 flex flex-col relative">
                        <div v-if="l.isNew" class="new-badge">NEW</div>
                    <div class="mb-3 flex justify-center"> <video :src="getVideoUrl(l.cid, l.storageType)" controls playsinline webkit-playsinline class="rounded w-full max-h-52 bg-black object-cover"></video> </div>
                    <div class="mb-1 font-bold text-lg">{{ l.crop }}</div>
                    <div class="text-xs text-gray-500 mb-1">Location: <span class="font-mono">{{ l.location }}</span></div>
                    <div class="text-xs text-gray-500 mb-1">Pesticide: <span class="font-mono">{{ l.pesticide }}</span></div>
                    <div class="text-xs text-gray-500 mb-2">Pesticide Co.: <span class="font-mono">{{ l.pesticideCompany || 'N/A' }}</span></div>
                    <div class="text-sm my-2">Price Range: <br><span class="font-mono text-base font-semibold">{{ l.minPrice }}</span> - <span class="font-mono text-base font-semibold">{{ l.maxPrice }}</span> SOL</div>
                    <div class="flex items-center text-xs text-gray-600 mb-2"> <span class="mr-1">Sold by: {{ getSellerDisplayIdentifier(l.farmerWallet) }}</span> <button @click="showFarmerProfile(l.farmerWallet)" class="text-blue-500 hover:text-blue-700 focus:outline-none" title="View Farmer Info"> <i class="fas fa-info-circle"></i> </button> </div>
                    <button class="mt-auto bg-green-600 hover:bg-green-700 text-white py-2 px-4 rounded text-sm" @click="buyListing(l)" :disabled="role !== 'buyer' || currentUserIdentifier === l.farmerWallet"> <i class="fas fa-shopping-cart mr-1"></i> {{ currentUserIdentifier === l.farmerWallet ? 'Your Listing' : (role === 'buyer' ? 'Initiate Purchase' : 'Switch to Buyer Role') }} </button>
                    <button @click="startOrGoToConversation(l.farmerWallet)" v-if="currentUserIdentifier !== l.farmerWallet" class="mt-2 text-xs text-blue-600 hover:text-blue-700 border border-blue-400 rounded-full px-3 py-1 hover:bg-blue-50 flex items-center justify-center"> <i class="fas fa-envelope mr-1"></i> Message Seller </button>
                    </div>
                </div>
                </section>
                <!-- Investor Projects Section -->
                <section v-if="current==='investorProjects'" class="max-w-6xl mx-auto mt-6">
                    <h2 class="text-2xl font-bold text-green-700 mb-3"><i class="fas fa-project-diagram mr-2"></i>Investment Opportunities</h2>
                    <div class="bg-blue-100 border-l-4 border-blue-500 text-blue-700 p-4 mb-4" role="alert">
                        <p class="font-bold">User: {{ currentUser ? currentUser.name : 'Investor' }} (Role: Investor)</p>
                        <p class="text-sm">Browse funding requests from farmers and simulate investments.</p>
                    </div>
                <div class="bg-white rounded shadow-md p-6 mb-7">
                    <div class="flex flex-col md:flex-row md:items-end gap-5">
                    <div class="w-full md:w-48"> <label class="text-gray-600 text-sm">Crop Type</label> <select v-model="investorFilters.crop" class="w-full px-2 py-1 border rounded bg-white text-sm"> <option value="">All Crops</option> <option v-for="c in uniqueFundingCrops" :key="c">{{c}}</option> </select> </div>
                    <div class="w-full md:w-48"> <label class="text-gray-600 text-sm">Growing Method</label> <select v-model="investorFilters.method" class="w-full px-2 py-1 border rounded bg-white text-sm"> <option value="">All Methods</option> <option value="organic">Organic</option> <option value="conventional">Conventional</option> <option value="hydroponic">Hydroponic</option> <option value="aquaponic">Aquaponic</option> <option value="regenerative">Regenerative</option> </select> </div>
                    <div class="w-full md:w-48"> <label class="text-gray-600 text-sm">Min ROI (%)</label> <input type="number" v-model.number="investorFilters.minRoi" class="w-full px-2 py-1 border rounded text-sm" placeholder="e.g., 10"> </div>
                    <div class="w-full md:w-48"> <label class="text-gray-600 text-sm">Max Funding Needed (SOL)</label> <input type="number" v-model.number="investorFilters.maxAmount" class="w-full px-2 py-1 border rounded text-sm" placeholder="e.g., 100"> </div>
                    <button type="button" class="bg-gray-100 hover:bg-gray-200 text-gray-700 px-4 py-1 rounded text-sm mt-2 md:mt-0" @click="resetInvestorFilters"> <i class="fas fa-undo mr-1"></i> Reset Filters </button>
                    </div>
                </div>
                <div v-if="filteredFundingRequests.length === 0" class="text-gray-600 bg-gray-50 p-8 text-center rounded"> <i class="fas fa-search text-4xl text-gray-400 mb-3"></i><br> No listings found matching your criteria. Try adjusting your filters. </div>
                <div v-else class="grid gap-6 grid-cols-1 lg:grid-cols-2">
                    <div v-for="project in filteredFundingRequests" :key="project._id" class="bg-white rounded-lg shadow overflow-hidden relative">
                    <div v-if="project.isNew" class="new-badge">NEW</div>
                    <div class="p-5 bg-gray-50 border-b flex flex-col sm:flex-row justify-between sm:items-center"> <h3 class="font-bold text-lg text-green-800 mb-2 sm:mb-0">{{ project.title }}</h3> <span :class="{'bg-yellow-100 text-yellow-800': project.status === 'pending', 'bg-green-100 text-green-800': project.status === 'funded', 'bg-blue-100 text-blue-800': project.status === 'partially_funded'}" class="px-2 py-1 rounded text-xs font-medium self-start sm:self-center"> {{ project.status === 'pending' ? 'Seeking Funding' : project.status === 'funded' ? 'Fully Funded' : 'Partially Funded' }} </span> </div>
                    <div class="p-5">
                        <div class="flex flex-col md:flex-row gap-6">
                        <div class="md:w-1/3">
                            <video :src="getVideoUrl(project.cid, project.videoStorageType)" controls playsinline webkit-playsinline class="rounded w-full h-40 object-cover bg-black mb-3"></video>
                            <div class="grid grid-cols-2 gap-2 text-sm"> <div> <div class="text-xs text-gray-500">Farmer</div> <div class="font-medium truncate flex items-center"> <span>{{ getFarmerDisplayIdentifier(project.farmerWallet) }}</span> <button @click="showFarmerProfile(project.farmerWallet)" class="ml-2 text-blue-500 hover:text-blue-700 text-xs focus:outline-none" title="View Farmer Info"> <i class="fas fa-info-circle"></i> </button> </div> </div> <div> <div class="text-xs text-gray-500">Land Size</div> <div class="font-medium">{{ project.acres }} acres</div> </div> <div> <div class="text-xs text-gray-500">Timeline</div> <div class="font-medium">{{ project.timeline }} months</div> </div> <div> <div class="text-xs text-gray-500">Expected ROI</div> <div class="font-medium text-green-700">{{ project.roi }}%</div> </div> </div>
                            <button @click="startOrGoToConversation(project.farmerWallet)" v-if="currentUserIdentifier !== project.farmerWallet" class="mt-3 w-full text-xs text-blue-600 hover:text-blue-700 border border-blue-400 rounded-full px-3 py-1 hover:bg-blue-50 flex items-center justify-center"> <i class="fas fa-envelope mr-1"></i> Message Farmer </button>
                        </div>
                        <div class="md:w-2/3">
                            <div class="mb-4"> <div class="text-sm font-medium mb-1">{{ project.crop }} ({{ project.method }})</div> <p class="text-sm text-gray-700 max-h-20 overflow-y-auto">{{ project.description }}</p> </div>
                            <div class="mb-4"> <div class="text-xs text-gray-500 mb-1">Funding Progress</div> <div class="progress-bar"> <div class="progress-fill bg-green-500" :style="{width: fundingProgressPercent(project) + '%'}"></div> </div> <div class="flex justify-between text-xs mt-1"> <span>{{ project.fundedAmount || 0 }} / {{ project.amount }} SOL</span> <span>{{ fundingProgressPercent(project) }}% Complete</span> </div> </div>
                            <div v-if="project.updates && project.updates.length > 0" class="mb-4"> <h4 class="text-sm font-semibold text-gray-700 mb-2">Recent Farmer Updates</h4> <div class="project-updates-list text-xs" style="max-height: 70px;"> <div v-for="update in project.updates.slice().reverse().slice(0,2)" :key="update._id" class="project-update-item"> <span class="font-medium text-gray-500">{{ formatTimestamp(update.date, true) }}:</span> {{ update.text }} </div> </div> </div>
                            <div class="mb-4"> <div class="flex justify-between items-center mb-2"> <div class="text-sm font-medium">Investment Terms</div> <div class="text-xs text-gray-500">Investor Share: {{ project.investorShare }}% of profit</div> </div> <div class="p-3 bg-yellow-50 rounded text-sm border border-yellow-200"> <p>Invest to receive {{ project.investorShare }}% of the profits, proportional to your investment. Expected return is {{ project.roi }}% over {{ project.timeline }} months.</p> </div> </div>
                            <div class="flex flex-col sm:flex-row justify-between items-center mt-4 pt-4 border-t"> <div class="mb-3 sm:mb-0"> <label :for="'investment-amount-'+project._id" class="text-xs text-gray-500 block mb-1">Your Investment (SOL)</label> <input v-model.number="investmentAmounts[project._id]" type="number" :id="'investment-amount-'+project._id" class="px-3 py-1 border rounded w-full sm:w-32 text-sm" min="0.1" :max="maxInvestmentAmount(project)" step="0.1" :disabled="project.status === 'funded' || role !== 'investor'" :placeholder="maxInvestmentAmount(project) > 0 ? `Max ${maxInvestmentAmount(project)}` : 'Funded'"> </div> <button @click="investInProject(project)" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded text-sm w-full sm:w-auto" :disabled="project.status === 'funded' || role !== 'investor' || !investmentAmounts[project._id] || investmentAmounts[project._id] <= 0 || investmentAmounts[project._id] > maxInvestmentAmount(project)"> <i class="fas fa-coins mr-1"></i> {{ project.status === 'funded' ? 'Fully Funded' : (role !== 'investor' ? 'Switch to Investor Role' : 'Invest Now') }} </button> </div>
                            <div v-if="investmentErrors[project._id]" class="text-red-500 text-xs mt-2">{{ investmentErrors[project._id] }}</div>
                        </div>
                        </div>
                    </div>
                    </div>
                </div>
                <div v-if="filteredFundingRequests.length === 0" class="bg-gray-50 p-8 text-center rounded-lg mt-4"> <i class="fas fa-seedling text-gray-300 text-4xl mb-3"></i> <h3 class="text-gray-600 text-lg mb-2">No Projects Found</h3> <p class="text-gray-500">Try adjusting your filters or check back later for new investment opportunities.</p> </div>
                </section>
                <!-- Investor Portfolio Section -->
                <section v-if="current==='investorPortfolio'" class="max-w-6xl mx-auto mt-6">
                    <h2 class="text-2xl font-bold text-green-700 mb-4"><i class="fas fa-chart-pie mr-2"></i>Investment Portfolio</h2>
                    <div class="bg-blue-100 border-l-4 border-blue-500 text-blue-700 p-4 mb-4" role="alert">
                        <p class="font-bold">User: {{ currentUser ? currentUser.name : 'Investor' }} (Role: Investor)</p>
                        <p class="text-sm">View your simulated investments and transaction history.</p>
                    </div>
                    <div class="bg-white rounded-lg shadow p-6 mb-8">
                        <h3 class="text-lg font-semibold text-gray-800 mb-4">Portfolio Overview</h3>
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-6"> <div class="mb-4 md:mb-0"> <div class="text-xs text-gray-500">Total Invested</div> <div class="text-2xl font-bold text-green-700">{{ totalInvestedAmount }} SOL</div> </div> <div> <div class="text-xs text-gray-500">Active Projects</div> <div class="text-xl font-bold">{{ investorActiveProjects }}</div> </div> <div> <div class="text-xs text-gray-500">Completed</div> <div class="text-xl font-bold">{{ investorCompletedProjects }}</div> </div> <div> <div class="text-xs text-gray-500">Avg. ROI</div> <div class="text-xl font-bold text-green-700">{{ investorAvgRoi }}%</div> </div> </div>
                    </div>
                    <div class="bg-white rounded-lg shadow overflow-hidden mb-8">
                        <div class="px-6 py-4 bg-gray-50 border-b"> <h3 class="text-lg font-semibold text-gray-800">Your Active Investments</h3> </div>
                        <div v-if="investorInvestments.length === 0" class="p-8 text-center"> <i class="fas fa-chart-line text-gray-300 text-4xl mb-3"></i> <h4 class="text-gray-600 text-lg mb-2">No Active Investments</h4> <p class="text-gray-500 mb-4">You haven't invested in any agricultural projects yet.</p> <button @click="switchPage('investorProjects')" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded text-sm"> <i class="fas fa-search mr-1"></i>Browse Projects </button> </div>
                        <div v-else class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50"> <tr> <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Project</th> <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Farmer</th> <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Invested (SOL)</th> <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Progress</th> <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Expected Return (SOL)</th> <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th> <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Details</th> </tr> </thead>
                            <tbody class="bg-white divide-y divide-gray-200">
                            <tr v-for="investment in investorInvestments" :key="investment._id">
                                <td class="px-6 py-4 whitespace-nowrap"> <div class="text-sm font-medium text-gray-900">{{ investment.projectTitle }}</div> <div class="text-xs text-gray-500">{{ investment.crop }}</div> </td>
                                <td class="px-6 py-4 whitespace-nowrap"> <div class="text-sm text-gray-900">{{ getFarmerDisplayIdentifier(investment.farmerWallet, 10) }}</div> <button @click="showFarmerProfile(investment.farmerWallet)" class="ml-2 text-blue-500 hover:text-blue-700 text-xs focus:outline-none mr-2" title="View Farmer Info"> <i class="fas fa-info-circle"></i>View Info </button> <button @click="startOrGoToConversation(investment.farmerWallet)" v-if="currentUserIdentifier !== investment.farmerWallet" class="text-green-600 hover:text-green-700 text-xs focus:outline-none" title="Message Farmer"> <i class="fas fa-envelope mr-1"></i>Message </button> </td>
                                <td class="px-6 py-4 whitespace-nowrap"> <div class="text-sm font-mono text-gray-900">{{ investment.amount }}</div> <div class="text-xs text-gray-500">{{ formatTimestamp(investment.investmentDate, true) }}</div> </td>
                                <td class="px-6 py-4 whitespace-nowrap"> <div class="w-24 bg-gray-200 rounded-full h-2.5"> <div class="bg-green-600 h-2.5 rounded-full" :style="{width: investment.progress+'%'}"></div> </div> <div class="text-xs text-gray-500 mt-1">{{ investment.progress }}% Complete</div> </td>
                                <td class="px-6 py-4 whitespace-nowrap"> <div class="text-sm text-gray-900 font-mono">{{ calculateExpectedReturn(investment) }}</div> <div class="text-xs text-gray-500">{{ investment.roi }}% ROI</div> </td>
                                <td class="px-6 py-4 whitespace-nowrap"> <span :class="{ 'px-2 inline-flex text-xs leading-5 font-semibold rounded-full': true, 'bg-blue-100 text-blue-800': investment.status === 'active', 'bg-green-100 text-green-800': investment.status === 'harvested', 'bg-yellow-100 text-yellow-800': investment.status === 'growing' }"> {{ investment.status.charAt(0).toUpperCase() + investment.status.slice(1) }} </span> </td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-blue-600"> <a href="#" @click.prevent="viewInvestmentDetails(investment)" class="hover:underline">View</a> </td>
                            </tr>
                            </tbody>
                        </table>
                        </div>
                    </div>
                    <div class="bg-white rounded-lg shadow overflow-hidden">
                        <div class="px-6 py-4 bg-gray-50 border-b flex justify-between items-center"> <h3 class="text-lg font-semibold text-gray-800">Platform Transaction History (Simulated)</h3> <span class="bg-purple-100 text-purple-800 text-xs px-2 py-1 rounded-full flex items-center"> <svg class="w-3 h-3 mr-1" fill="currentColor" viewBox="0 0 16 15"><path d="m7.81 0-1.78 3.69L1.88 4.2l2.92 2.52L4.04 10 7.8 7.97 11.55 10l-.77-3.28 2.92 2.52-4.15-.51L7.82 0h-.01Zm0 15-1.78-3.69-4.15-.51 2.92-2.52L4.04 5 7.8 7.03 11.55 5l-.77 3.28 2.92 2.52-4.15-.51L7.82 15h-.01Z"></path></svg> PestiVid Platform (Simulated Ledger) </span> </div>
                        <div v-if="investorTransactions.length === 0" class="p-8 text-center"> <i class="fas fa-cubes text-gray-300 text-4xl mb-3"></i> <h4 class="text-gray-600 text-lg mb-2">No Transactions Yet</h4> <p class="text-gray-500">Your investment and payout transactions on the platform will appear here.</p> </div>
                        <div v-else class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50"> <tr> <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Transaction ID</th> <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Type</th> <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Amount (SOL)</th> <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th> <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date</th> </tr> </thead>
                            <tbody class="bg-white divide-y divide-gray-200">
                            <tr v-for="tx in investorTransactions" :key="tx._id">
                                <td class="px-6 py-4 whitespace-nowrap"> <div class="flex items-center"> <div class="text-sm font-mono text-gray-900 truncate max-w-[150px] sm:max-w-[250px]" :title="tx.txHash">{{ tx.txHash.substring(0,10) }}...{{ tx.txHash.substring(tx.txHash.length-10) }}</div> <a :href="solanaExplorerUrl(tx.txHash)" target="_blank" class="ml-1 text-blue-500 hover:text-blue-700" title="View on Solana Explorer (Demo Link)"> <i class="fas fa-external-link-alt text-xs"></i> </a> </div> </td>
                                <td class="px-6 py-4 whitespace-nowrap"> <span :class="{ 'px-2 inline-flex text-xs leading-5 font-semibold rounded-full': true, 'bg-green-100 text-green-800': tx.type === 'investment', 'bg-blue-100 text-blue-800': tx.type === 'payout' }"> {{ tx.type === 'investment' ? 'Investment' : 'Harvest Payout' }} </span> </td>
                                <td class="px-6 py-4 whitespace-nowrap"> <div class="text-sm font-mono text-gray-900">{{ tx.amount }}</div> </td>
                                <td class="px-6 py-4 whitespace-nowrap"> <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-green-100 text-green-800"> Confirmed (Sim.) </span> </td>
                                <td class="px-6 py-4 whitespace-nowrap"> <div class="text-sm text-gray-900">{{ formatTimestamp(tx.date, true) }}</div> </td>
                            </tr>
                            </tbody>
                        </table>
                        </div>
                    </div>
                </section>
                <!-- User Profile Section -->
                <section v-if="current==='userProfile'" class="max-w-6xl mx-auto mt-6">
                    <div class="bg-blue-100 border-l-4 border-blue-500 text-blue-700 p-4 mb-4" role="alert">
                        <p class="font-bold">User Profile: {{ currentUser ? currentUser.name : 'User' }}</p>
                        <p class="text-sm">This shows your PestiVid profile information.</p>
                    </div>
                <div class="bg-white rounded-lg shadow-md overflow-hidden">
                    <div class="bg-gradient-to-r from-green-700 to-green-500 p-6 text-white">
                    <div class="flex flex-col md:flex-row justify-between items-center">
                        <div class="flex items-center mb-4 md:mb-0">
                        <div class="bg-white rounded-full w-16 h-16 flex items-center justify-center mr-4 text-green-600 shadow overflow-hidden">
                            <i :class="role === 'farmer' ? 'fas fa-tractor' : (role === 'buyer' ? 'fas fa-shopping-cart' : 'fas fa-chart-line')" class="text-3xl"></i>
                        </div>
                        <div> <h2 class="text-2xl font-bold">{{ userNameDisplay }}</h2> <p class="text-green-100 capitalize"> {{ role === 'farmer' ? 'Agricultural Producer' : role === 'buyer' ? 'Crop Buyer' : 'Agricultural Investor' }} </p> </div>
                        </div>
                        <div class="bg-white bg-opacity-20 rounded-lg px-4 py-2 flex items-center text-sm"> <i class="fas fa-certificate mr-2"></i> <span>{{ role === 'farmer' ? 'Verified Farmer' : role === 'buyer' ? 'Verified Buyer' : 'Verified Investor' }} (PestiVid Status)</span> </div>
                    </div>
                    </div>
                    <div class="p-6">
                    <div class="mb-8">
                        <h3 class="text-xl font-bold text-green-700 mb-4 border-b pb-2 flex items-center"> <i class="fas fa-id-card mr-2"></i>Account Information </h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 text-sm">
                        <div>
                            <div class="mb-4"> <p class="text-gray-600">Full Name (PestiVid)</p> <p class="font-medium">{{ userNameDisplay }}</p> </div>
                            <div> <p class="text-gray-600">PestiVid Account Type</p> <p class="font-medium capitalize">{{ role || "Not Set" }}</p> </div>
                        </div>
                        <div>
                            <div class="mb-4"> <p class="text-gray-600">Email (PestiVid)</p> <p class="font-medium">{{ userEmailDisplay }}</p> </div>
                            <div class="mb-4"> <p class="text-gray-600">Phone (PestiVid)</p> <p class="font-medium">{{ userPhoneDisplay }}</p> </div>
                            <div> <p class="text-gray-600">PestiVid Member Since</p> <p class="font-medium">{{ memberSinceDisplay }}</p> </div>
                        </div>
                        </div>
                    </div>

                    <div v-if="role === 'farmer'" class="mb-8">
                        <h3 class="text-xl font-bold text-green-700 mb-4 border-b pb-2 flex items-center"> <i class="fas fa-map-marker-alt mr-2"></i>Farm Information </h3>
                        <p class="text-sm text-gray-600">General farm information can be displayed here (e.g., location, size, certifications if any). This section is a placeholder for the demo farmer.</p>
                    </div>

                    <div v-if="role === 'farmer'">
                            <div class="mb-8"> <h3 class="text-xl font-bold text-green-700 mb-4 border-b pb-2 flex items-center"> <i class="fas fa-video mr-2"></i>Your Uploaded Videos ({{ farmerVideos.length }}) </h3> <div v-if="farmerVideos.length === 0" class="bg-gray-100 rounded p-4 text-gray-600 text-center"> <i class="fas fa-film text-gray-400 text-2xl mb-2"></i> <p>You haven't uploaded any videos yet.</p> <button @click="switchPage('farmerPestiVid')" class="text-green-600 hover:text-green-700 underline mt-2 text-sm">Upload your first video</button> </div> <div v-else class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"> <div v-for="vid in farmerVideos" :key="vid.cid" class="bg-gray-50 rounded-lg p-4 shadow-sm"> <video :src="getVideoUrl(vid.cid, vid.storageType)" controls playsinline webkit-playsinline class="w-full h-40 object-cover bg-black rounded mb-3"></video> <h4 class="font-bold">{{ vid.crop }}</h4> <div class="text-xs mb-1" :class="{ 'text-blue-700': vid.purpose === 'sell', 'text-purple-700': vid.purpose === 'funding', 'text-gray-600': vid.purpose === 'agristream' || !vid.purpose }"> Purpose: <span class="font-semibold"> {{ vid.purpose === 'sell' ? 'Sale' : (vid.purpose === 'funding' ? 'Funding' : (vid.purpose === 'agristream' ? 'General' : 'N/A')) }} </span> </div> <div class="text-sm mb-1">Location: {{ vid.location }}</div> <div class="text-sm mb-1">Pesticide: {{ vid.pesticide }}</div> <div class="text-sm mb-2">Pesticide Co.: {{ vid.pesticideCompany || 'N/A' }}</div> <div class="flex justify-between items-center mt-2 text-xs text-gray-500"> <span class="font-mono truncate" :title="vid.cid">CID: {{ vid.cid.substring(0, 10) }}...</span> <a :href="getVideoUrl(vid.cid, vid.storageType)" target="_blank" class="text-blue-600 hover:underline">View</a> </div> <div class="text-xs text-gray-400 mt-1">File Hash: <span class="font-mono break-all" :title="vid.videoFileHash || 'N/A'">{{ vid.videoFileHash ? vid.videoFileHash.substring(0,10) + '...' : 'N/A' }}</span></div> </div> </div> </div>
                            <div class="mb-8"> <h3 class="text-xl font-bold text-green-700 mb-4 border-b pb-2 flex items-center"> <i class="fas fa-tags mr-2"></i>Your Active Listings ({{ farmerListings.length }}) </h3> <div v-if="farmerListings.length === 0" class="bg-gray-100 rounded p-4 text-gray-600 text-center"> <i class="fas fa-store text-gray-400 text-2xl mb-2"></i> <p>You don't have any active listings.</p> <button @click="switchPage('farmerSell')" class="text-green-600 hover:text-green-700 underline mt-2 text-sm">Create your first listing</button> </div> <div v-else> <div class="overflow-x-auto"> <table class="min-w-full border divide-y divide-gray-200"> <thead class="bg-gray-50"> <tr> <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Crop</th> <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Location</th> <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Pesticide Co.</th> <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Price Range (SOL)</th> <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th> </tr> </thead> <tbody class="bg-white divide-y divide-gray-200"> <tr v-for="listing in farmerListings" :key="listing._id"> <td class="px-6 py-4 whitespace-nowrap"> <div class="text-sm font-medium text-gray-900">{{ listing.crop }}</div> <div class="text-xs text-gray-500" :title="listing.cid">CID: {{ listing.cid.substring(0, 8) }}... ({{listing.storageType}})</div> </td> <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500"> {{ listing.location }} </td> <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500"> {{ listing.pesticideCompany || 'N/A' }} </td> <td class="px-6 py-4 whitespace-nowrap"> <div class="text-sm text-gray-900 font-mono">{{ listing.minPrice }} - {{ listing.maxPrice }}</div> </td> <td class="px-6 py-4 whitespace-nowrap"> <span class="px-2 py-1 inline-flex text-xs leading-5 font-semibold rounded-full bg-green-100 text-green-800"> Active </span> </td> </tr> </tbody> </table> </div> </div> </div>
                            <div> <h3 class="text-xl font-bold text-green-700 mb-4 border-b pb-2 flex items-center"> <i class="fas fa-hand-holding-usd mr-2"></i>Your Funding Requests ({{ farmerFundingRequests.length }}) </h3> <div v-if="farmerFundingRequests.length === 0" class="bg-gray-100 rounded p-4 text-gray-600 text-center"> <i class="fas fa-money-bill-wave text-gray-400 text-2xl mb-2"></i> <p>You haven't created any funding requests yet.</p> <button @click="switchPage('farmerFunding')" class="text-green-600 hover:text-green-700 underline mt-2 text-sm">Request funding for your farm</button> </div> <div v-else class="space-y-4"> <div v-for="req in farmerFundingRequests" :key="req._id" class="border rounded-lg overflow-hidden bg-white shadow-sm"> <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center p-4 bg-green-50 border-b"> <h4 class="font-bold mb-1 sm:mb-0">{{ req.title }}</h4> <span :class="{'bg-yellow-100 text-yellow-800': req.status === 'pending', 'bg-green-100 text-green-800': req.status === 'funded', 'bg-blue-100 text-blue-800': req.status === 'partially_funded'}" class="px-2 py-1 rounded text-xs font-medium"> {{ req.status === 'pending' ? 'Pending' : req.status === 'funded' ? 'Fully Funded' : (req.status === 'partially_funded' ? 'Partially Funded' : req.status) }} </span> </div> <div class="p-4 text-sm"> <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-4"> <div> <div class="text-xs text-gray-500">Crop</div> <div>{{ req.crop }}</div> </div> <div> <div class="text-xs text-gray-500">Land Size</div> <div>{{ req.acres }} acres</div> </div> <div> <div class="text-xs text-gray-500">Required</div> <div class="font-mono">{{ req.amount }} SOL</div> </div> <div> <div class="text-xs text-gray-500">Raised</div> <div class="font-mono">{{ req.fundedAmount || 0 }} SOL</div> </div> </div> <div class="mb-4"> <div class="text-xs text-gray-500 mb-1">Funding Progress</div> <div class="progress-bar"> <div class="progress-fill bg-green-500" :style="{width: fundingProgressPercent(req) + '%'}"></div> </div> <div class="text-xs mt-1">{{ fundingProgressPercent(req) }}% Complete</div> </div> <div class="flex justify-end mt-4"> <button v-if="req.status !== 'funded'" class="px-3 py-1 text-xs bg-red-100 text-red-700 rounded hover:bg-red-200" @click="cancelFundingRequest_V1(req._id)"> <i class="fas fa-times mr-1"></i>Cancel Request </button> <span v-if="req.status === 'funded'" class="text-xs text-green-600"><i class="fas fa-check-circle mr-1"></i>Fully Funded!</span> </div> </div> </div> </div> </div>
                        </div>
                    <div v-if="role === 'buyer'"> <div> <h3 class="text-xl font-bold text-green-700 mb-4 border-b pb-2 flex items-center"> <i class="fas fa-shopping-basket mr-2"></i>Your Purchase History ({{ buyerPurchases.length }}) </h3> <div v-if="buyerPurchases.length === 0" class="bg-gray-100 rounded p-4 text-gray-600 text-center"> <i class="fas fa-shopping-cart text-gray-400 text-2xl mb-2"></i> <p>You haven't made any purchases yet.</p> <button @click="switchPage('buyerAgriSell')" class="text-green-600 hover:text-green-700 underline mt-2 text-sm">Browse marketplace</button> </div> <div v-else> <div class="overflow-x-auto"> <table class="min-w-full border divide-y divide-gray-200"> <thead class="bg-gray-50"> <tr> <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Crop</th> <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Location</th> <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Pesticide Co.</th> <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Price Paid (SOL)</th> <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Purchase Date</th> <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Seller</th> <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Video/Tx</th> </tr> </thead> <tbody class="bg-white divide-y divide-gray-200"> <tr v-for="purchase in buyerPurchases" :key="purchase._id"> <td class="px-6 py-4 whitespace-nowrap"> <div class="text-sm font-medium text-gray-900">{{ purchase.crop }}</div> </td> <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500"> {{ purchase.location }} </td> <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500"> {{ purchase.pesticideCompany || 'N/A' }} </td> <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 font-mono"> {{ purchase.price }} </td> <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500"> {{ formatTimestamp(purchase.purchaseDate, true) }} </td> <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500"> {{ getSellerDisplayIdentifier(purchase.farmerWallet, 10) }} <button @click="showFarmerProfile(purchase.farmerWallet)" class="ml-1 text-blue-500 hover:text-blue-700 text-xs focus:outline-none" title="View Farmer Info"> <i class="fas fa-info-circle"></i> </button> <button @click="startOrGoToConversation(purchase.farmerWallet)" v-if="currentUserIdentifier !== purchase.farmerWallet" class="ml-1 text-green-600 hover:text-green-700 text-xs focus:outline-none" title="Message Seller"> <i class="fas fa-envelope"></i> </button> </td> <td class="px-6 py-4 whitespace-nowrap text-sm text-blue-600"> <a href="#" @click.prevent="viewPurchaseVideo(purchase)" class="hover:underline mr-2">Video ({{purchase.videoStorageType}})</a> <a :href="solanaExplorerUrl(purchase.txHash)" target="_blank" class="hover:underline" title="View Transaction (Demo Link)">Tx</a> </td> </tr> </tbody> </table> </div> </div> </div> </div>
                    <div v-if="role === 'investor'"> <div class="mb-8"> <h3 class="text-xl font-bold text-green-700 mb-4 border-b pb-2 flex items-center"> <i class="fas fa-chart-pie mr-2"></i>Investment Portfolio Summary </h3> <div v-if="investorInvestments.length === 0" class="bg-gray-100 rounded p-4 text-gray-600 text-center"> <i class="fas fa-coins text-gray-400 text-2xl mb-2"></i> <p>You haven't made any investments yet.</p> <button @click="switchPage('investorProjects')" class="text-green-600 hover:text-green-700 underline mt-2 text-sm">Browse investment opportunities</button> </div> <div v-else> <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6"> <div class="bg-gray-50 p-4 rounded-lg"> <div class="text-sm text-gray-500">Total Invested</div> <div class="text-xl font-bold text-green-700">{{ totalInvestedAmount }} SOL</div> </div> <div class="bg-gray-50 p-4 rounded-lg"> <div class="text-sm text-gray-500">Projects</div> <div class="text-xl font-bold">{{ investorInvestments.length }}</div> </div> <div class="bg-gray-50 p-4 rounded-lg"> <div class="text-sm text-gray-500">Avg. ROI</div> <div class="text-xl font-bold text-green-700">{{ investorAvgRoi }}%</div> </div> <div class="bg-gray-50 p-4 rounded-lg"> <div class="text-sm text-gray-500">Completed</div> <div class="text-xl font-bold">{{ investorCompletedProjects }}</div> </div> </div> <div class="overflow-x-auto mt-4"> <h4 class="text-lg font-semibold text-gray-800 mb-3">Your Investments</h4> <table class="min-w-full border divide-y divide-gray-200"> <thead class="bg-gray-50"> <tr> <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Project</th> <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Farmer</th> <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Amount (SOL)</th> <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date</th> <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th> <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Details</th> </tr> </thead> <tbody class="bg-white divide-y divide-gray-200"> <tr v-for="inv in investorInvestments" :key="inv._id"> <td class="px-6 py-4 whitespace-nowrap"> <div class="text-sm font-medium text-gray-900">{{ inv.projectTitle }}</div> <div class="text-xs text-gray-500">{{ inv.crop }}</div> </td> <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500"> {{ getFarmerDisplayIdentifier(inv.farmerWallet, 10) }} <button @click="showFarmerProfile(inv.farmerWallet)" class="ml-1 text-blue-500 hover:text-blue-700 text-xs focus:outline-none" title="View Farmer Info"> <i class="fas fa-info-circle"></i> </button> <button @click="startOrGoToConversation(inv.farmerWallet)" v-if="currentUserIdentifier !== inv.farmerWallet" class="ml-1 text-green-600 hover:text-green-700 text-xs focus:outline-none" title="Message Farmer"> <i class="fas fa-envelope"></i> </button> </td> <td class="px-6 py-4 whitespace-nowrap"> <div class="text-sm font-mono text-gray-900">{{ inv.amount }}</div> </td> <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500"> {{ formatTimestamp(inv.investmentDate, true) }} </td> <td class="px-6 py-4 whitespace-nowrap"> <span :class="{'px-2 inline-flex text-xs leading-5 font-semibold rounded-full': true, 'bg-blue-100 text-blue-800': inv.status === 'active', 'bg-green-100 text-green-800': inv.status === 'harvested', 'bg-yellow-100 text-yellow-800': inv.status === 'growing'}"> {{ inv.status.charAt(0).toUpperCase() + inv.status.slice(1) }} </span> </td> <td class="px-6 py-4 whitespace-nowrap text-sm text-blue-600"> <a href="#" @click.prevent="viewInvestmentDetails(inv)" class="hover:underline">View</a> </td> </tr> </tbody> </table> </div> <div class="mt-4 text-right"> <button @click="switchPage('investorPortfolio')" class="text-green-700 text-sm hover:underline">Go to Full Portfolio <i class="fas fa-arrow-right ml-1"></i></button> </div> </div> </div> <div> <h3 class="text-xl font-bold text-green-700 mb-4 border-b pb-2 flex items-center"> <i class="fas fa-link mr-2"></i>Platform Verification (Simulated) </h3> <div class="bg-gray-50 p-5 rounded-lg border"> <div class="flex items-center mb-4"> <i class="fas fa-shield-alt text-green-600 text-2xl mr-3"></i> <div> <h4 class="font-bold text-gray-800">PestiVid Platform Records</h4> <p class="text-sm text-gray-600">All your investment transactions are recorded on the PestiVid platform (Simulated Ledger).</p> </div> </div> <div v-if="investorTransactions.length > 0" class="mt-4"> <h5 class="font-medium text-sm mb-2">Recent Transactions</h5> <div class="space-y-2"> <div v-for="tx in investorTransactions.slice(0, 3)" :key="tx._id" class="flex flex-col sm:flex-row justify-between items-start sm:items-center p-2 bg-white rounded border text-sm"> <div class="flex items-center mb-1 sm:mb-0"> <span :class="{'px-2 py-0.5 text-xs rounded-full mr-2': true, 'bg-green-100 text-green-800': tx.type === 'investment', 'bg-blue-100 text-blue-800': tx.type === 'payout'}"> {{ tx.type === 'investment' ? 'Invest' : 'Payout' }} </span> <span class="font-mono text-xs text-gray-500 truncate" :title="tx.txHash">{{ tx.txHash.substring(0, 8) }}...{{ tx.txHash.substring(tx.txHash.length - 8) }}</span> <a :href="solanaExplorerUrl(tx.txHash)" target="_blank" class="text-blue-600 hover:underline whitespace-nowrap"> <i class="fas fa-external-link-alt"></i> View (Demo Link) </a> </div> <div class="text-right w-full sm:w-auto"> <div class="font-mono text-sm">{{ tx.amount }} SOL</div> <div class="text-xs text-gray-500">{{ formatTimestamp(tx.date, true) }}</div> </div> </div> </div> <div class="mt-3 text-right"> <button @click="switchPage('investorPortfolio')" class="text-green-700 text-sm hover:underline">View all transactions <i class="fas fa-arrow-right ml-1"></i></button> </div> </div> <div v-else class="bg-white p-4 rounded border text-center text-sm text-gray-600"> <p>No platform transactions recorded yet.</p> </div> </div> </div> </div>
                    </div>
                    </div>
                </section>
                <!-- Messaging Section -->
                <section v-if="current==='messaging'" class="max-w-6xl mx-auto mt-6">
                    <div class="bg-blue-100 border-l-4 border-blue-500 text-blue-700 p-4 mb-4" role="alert">
                        <p class="font-bold">User: {{ currentUser ? currentUser.name : 'User' }} - Messaging</p>
                        <p class="text-sm">Chat with other users on the platform. Messages are stored locally in your browser.</p>
                    </div>
                <div class="bg-white rounded-lg shadow-md flex" style="height: calc(100vh - 200px);">
                    <div class="w-full md:w-1/3 border-r flex flex-col bg-gray-50">
                        <div class="p-4 border-b"> <h2 class="text-xl font-semibold text-green-700">Conversations</h2> </div>
                        <div class="overflow-y-auto flex-1">
                            <div v-if="userConversations.length === 0" class="p-4 text-center text-gray-500 mt-10"> <i class="fas fa-comment-slash fa-3x mb-3 text-gray-300"></i> <p>No conversations yet.</p> <p class="text-xs mt-1">Start a chat from a user's profile or project.</p> </div>
                            <div v-for="conv in userConversations" :key="conv._id" @click="selectConversation(conv._id)" class="p-3 hover:bg-gray-100 cursor-pointer border-b flex items-center space-x-3" :class="{'bg-green-100 border-l-4 border-green-500': activeConversationId === conv._id, 'bg-white': activeConversationId !== conv._id}">
                                <div class="w-10 h-10 rounded-full bg-green-500 text-white flex items-center justify-center text-lg flex-shrink-0"> {{ getOtherParticipantInitial(conv) }} </div>
                                <div class="flex-1 overflow-hidden"> <div class="font-semibold text-gray-800 truncate">{{ getOtherParticipantDisplayAddress(conv) }}</div> <div class="text-xs text-gray-500 truncate">{{ conv.lastMessageSnippet }}</div> </div>
                                <div class="text-xs text-gray-400 self-start whitespace-nowrap">{{ formatTimestamp(conv.lastMessageTimestamp, true) }}</div>
                                <div v-if="getUnreadCountForConversation(conv._id) > 0" class="bg-red-500 text-white rounded-full w-5 h-5 flex items-center justify-center text-xs ml-auto flex-shrink-0"> {{ getUnreadCountForConversation(conv._id) }} </div>
                            </div>
                        </div>
                    </div>
                    <div class="w-full md:w-2/3 flex flex-col bg-white">
                        <div v-if="!activeConversationId" class="flex-1 flex flex-col items-center justify-center text-gray-400 p-10 text-center"> <i class="fas fa-comments fa-4x mb-4"></i> <h3 class="text-xl text-gray-600">Welcome to PestiVid Chat</h3> <p>Select a conversation from the left to view messages, or start a new chat from a user's profile or project page.</p> </div>
                        <template v-else>
                            <div class="p-4 border-b bg-gray-50 flex items-center sticky top-0 z-10"> <div class="w-8 h-8 rounded-full bg-green-600 text-white flex items-center justify-center text-sm mr-3 flex-shrink-0"> {{ activeConversationPartnerInitial ? activeConversationPartnerInitial : '?' }} </div> <h3 class="font-semibold text-lg text-green-800">{{ activeConversationPartnerDisplayAddress }}</h3> </div>
                            <div class="flex-1 overflow-y-auto p-4 space-y-3 message-view-container bg-gray-100" ref="messageContainer">
                                <div v-if="currentMessages.length === 0" class="text-center text-gray-500 py-10"> No messages in this conversation yet. Say hello! </div>
                                <div v-for="msg in currentMessages" :key="msg._id" class="flex" :class="msg.sender === currentUserIdentifier ? 'justify-end' : 'justify-start'">
                                    <div class="max-w-xs md:max-w-md lg:max-w-lg"> <div class="p-3 rounded-xl shadow" :class="msg.sender === currentUserIdentifier ? 'bg-green-600 text-white' : 'bg-white text-gray-800 border'"> <p class="text-sm leading-relaxed">{{ msg.text }}</p> </div> <p class="text-xs mt-1 px-1" :class="msg.sender === currentUserIdentifier ? 'text-gray-400 text-right' : 'text-gray-400 text-left'"> {{ formatTimestamp(msg.timestamp) }} <span v-if="msg.sender === currentUserIdentifier && msg.read"><i class="fas fa-check-double text-blue-400 ml-1" title="Read"></i></span> <span v-if="msg.sender === currentUserIdentifier && !msg.read"><i class="fas fa-check text-gray-400 ml-1" title="Sent"></i></span> </p> </div>
                                </div>
                            </div>
                            <div class="p-3 border-t bg-gray-50"> <form @submit.prevent="sendMessage" class="flex gap-3 items-center"> <input v-model="messageInputText" type="text" placeholder="Type your message..." class="flex-1 px-4 py-2 border border-gray-300 rounded-full focus:ring-green-500 focus:border-green-500 text-sm" required> <button type="submit" :disabled="!messageInputText.trim()" class="bg-green-600 hover:bg-green-700 text-white px-5 py-2 rounded-full text-sm font-semibold focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-opacity-50 disabled:opacity-50"> <i class="fas fa-paper-plane mr-1"></i> Send </button> </form> </div>
                        </template>
                    </div>
                </div>
                </section>
                <!-- Plant Recommendation Section -->
                <section v-if="current==='plantRecommendation'" class="max-w-3xl mx-auto mt-6">
                <h2 class="text-2xl font-bold text-green-700 mb-4"><i class="fas fa-leaf mr-2"></i>Plant Disease Detection & Recommendation</h2>
                <div class="bg-blue-100 border-l-4 border-blue-500 text-blue-700 p-4 mb-4" role="alert">
                    <p class="font-bold">User: {{ currentUser ? currentUser.name : 'Farmer' }} (Role: Farmer)</p>
                    <p class="text-sm">Upload a plant image for AI analysis. Requires a configured Gemini API key (check developer console/code for placeholder warning).</p>
                </div>
                <div class="bg-white rounded shadow-md p-6 space-y-6">
                    <p class="text-sm text-gray-600">Upload an image of an affected plant. It will attempt to identify the plant, detect diseases, and suggest treatments.</p>
                    <div class="bg-yellow-100 border-l-4 border-yellow-500 text-yellow-700 p-4" role="alert">
                    <p class="font-bold">Developer Note (Placeholder Feature):</p>
                    <p class="text-sm">This Plant Recommendation feature's AI analysis logic (using Gemini API via backend proxy) needs to be fully implemented and tested with a valid API key on your backend. The current description and placeholder API key mean the analysis will likely fail or be simulated if the backend proxy is not correctly set up.</p>
                    </div>
                    <div>
                    <label class="block text-gray-600 mb-1 text-sm">Upload Plant Image</label>
                    <input type="file" @change="handlePlantImageUpload" accept="image/*" class="w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-green-50 file:text-green-700 hover:file:bg-green-100">
                    </div>
                    <div v-if="plantImageUrl" class="mt-4">
                    <h4 class="text-md font-semibold text-gray-700 mb-2">Image Preview:</h4>
                    <img :src="plantImageUrl" alt="Plant Preview" class="max-w-xs md:max-w-sm rounded-md border shadow mx-auto">
                    </div>
                    <button @click="analyzePlant" :disabled="!plantImageFile || analysisInProgress" class="w-full bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded text-sm flex items-center justify-center" :class="{'opacity-50 cursor-not-allowed': !plantImageFile || analysisInProgress}">
                    <i :class="analysisInProgress ? 'fas fa-spinner fa-spin' : 'fas fa-search-plus'" class="mr-2"></i>
                    {{ analysisInProgress ? 'Analyzing...' : 'Analyze Plant with AI (Demo)' }}
                    </button>
                    <div v-if="analysisErrorText" class="mt-4 bg-red-100 border border-red-300 text-red-700 px-4 py-3 rounded text-sm">
                    <p class="font-bold">Analysis Error:</p>
                    <p>{{ analysisErrorText }}</p>
                    </div>
                    <div v-if="parsedAnalysis.plantName && !analysisInProgress && !analysisErrorText" class="mt-6 border-t pt-6 space-y-4">
                    <h3 class="text-xl font-semibold text-green-700">Analysis Results:</h3>
                    <div>
                        <p class="text-sm font-medium text-gray-500">Identified Plant:</p>
                        <p class="text-lg text-gray-800">{{ parsedAnalysis.plantName || 'Could not identify plant.' }}</p>
                    </div>
                    <div>
                        <p class="text-sm font-medium text-gray-500">Detected Disease:</p>
                        <p class="text-lg text-gray-800 font-semibold" :class="{'text-red-600': parsedAnalysis.diseaseName && parsedAnalysis.diseaseName.toLowerCase() !== 'healthy' && parsedAnalysis.diseaseName.toLowerCase() !== 'not apparent' && parsedAnalysis.diseaseName.toLowerCase() !== 'unknown', 'text-green-600': parsedAnalysis.diseaseName && (parsedAnalysis.diseaseName.toLowerCase() === 'healthy' || parsedAnalysis.diseaseName.toLowerCase() === 'not apparent')}">
                        {{ parsedAnalysis.diseaseName || 'Could not determine disease.' }}
                        </p>
                    </div>
                    <div>
                        <p class="text-sm font-medium text-gray-500">Recommended Treatment / Pesticides:</p>
                        <p class="text-md text-gray-700 whitespace-pre-wrap">{{ parsedAnalysis.treatmentRecommended || 'No specific treatment recommended.' }}</p>
                    </div>
                    <div v-if="analysisResultText && (!parsedAnalysis.plantName || parsedAnalysis.plantName === 'Unknown' || parsedAnalysis.plantName === '-')" class="mt-4 bg-gray-50 p-3 rounded border text-xs">
                            <p class="font-semibold mb-1">Raw Output (for debugging if parsing failed):</p>
                            <pre class="whitespace-pre-wrap overflow-x-auto">{{ analysisResultText }}</pre>
                        </div>
                    </div>
                </div>
                </section>

                <!-- Farmer Chatbot Section (AgriBot) -->
                <section v-if="current==='farmerChatbot'" class="max-w-3xl mx-auto mt-6">
                    <h2 class="text-2xl font-bold text-green-700 mb-4"><i class="fas fa-robot mr-2"></i>AgriBot - Your Farming Assistant</h2>
                    <div class="bg-blue-100 border-l-4 border-blue-500 text-blue-700 p-4 mb-4" role="alert">
                        <p class="font-bold">User: {{ currentUser ? currentUser.name : 'Farmer' }} (Role: Farmer)</p>
                        <p class="text-sm">Chat with AgriBot about farming questions. AI responses are simulated unless a Groq API key is configured on your backend.</p>
                    </div>
                    <div class="bg-white rounded shadow-md chatbot-container">
                        <div class="chatbot-messages" ref="chatbotMessagesContainer">
                            <div v-for="msg in chatMessages" :key="msg._id" :class="['chat-message', msg.sender]">
                                <div class="message-content">
                                    <div class="avatar">
                                        <i :class="msg.sender === 'user' ? 'fas fa-user' : 'fas fa-robot'"></i>
                                    </div>
                                    <div class="message-bubble" v-html="renderMarkdown(msg.text)"></div>
                                </div>
                            </div>
                            <div v-if="isGroqLoading" class="chat-message bot">
                                <div class="message-content">
                                    <div class="avatar"><i class="fas fa-robot"></i></div>
                                    <div class="message-bubble typing-indicator">
                                        <span></span><span></span><span></span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="chatbot-input-area">
                            <input type="text" v-model="chatInput" @keyup.enter="sendChatMessage" placeholder="Ask AgriBot about farming..." :disabled="isGroqLoading">
                            <button @click="sendChatMessage" :disabled="isGroqLoading || !chatInput.trim()">
                                <i class="fas fa-paper-plane mr-1"></i> Send
                            </button>
                        </div>
                    </div>
                </section>
            </div>

            <!-- Modals (Purchase Video, Buy Listing, Investment Details, Farmer Profile) -->
            <div v-if="selectedPurchase && showPurchaseVideo" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50 p-4">
            <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full modal-scrollable">
                <div class="p-4 border-b flex justify-between items-center sticky top-0 bg-white z-10"> <h3 class="font-bold text-lg text-green-700">{{ selectedPurchase.crop }} - Purchase Verification</h3> <button @click="showPurchaseVideo = false" class="text-gray-500 hover:text-gray-700"> <i class="fas fa-times"></i> </button> </div>
                <div class="p-4">
                    <video :src="getVideoUrl(selectedPurchase.cid, selectedPurchase.videoStorageType)" controls playsinline webkit-playsinline class="w-full rounded bg-black mb-4"></video>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                        <div> <p class="text-gray-600">Location</p> <p class="font-medium">{{ selectedPurchase.location }}</p> </div>
                        <div> <p class="text-gray-600">Pesticide Used</p> <p class="font-medium">{{ selectedPurchase.pesticide }}</p> </div>
                        <div> <p class="text-gray-600">Pesticide Company</p> <p class="font-medium">{{ selectedPurchase.pesticideCompany || 'N/A' }}</p> </div>
                        <div> <p class="text-gray-600">Purchase Price</p> <p class="font-medium font-mono">{{ selectedPurchase.price }} SOL</p> </div>
                        <div> <p class="text-gray-600">Purchase Date</p> <p class="font-medium">{{ formatTimestamp(selectedPurchase.purchaseDate, false) }}</p> </div>
                        <div> <p class="text-gray-600">Seller Identifier</p> <p class="font-medium font-mono text-xs">{{ selectedPurchase.farmerWallet }}</p> </div>
                        <div>
                            <p class="text-gray-600">Video File Hash (SHA256)</p>
                            <p class="font-medium font-mono text-xs break-all" :title="selectedPurchase.videoFileHash || 'N/A'">{{ selectedPurchase.videoFileHash || 'N/A' }}</p>
                        </div>
                    </div>
                    <div class="mt-4 bg-gray-100 p-3 rounded text-xs border">
                        <p class="font-bold mb-1">Platform Verification (Simulated):</p>
                        <p class="font-mono break-all mb-1">Video CID ({{selectedPurchase.videoStorageType}}): {{ selectedPurchase.cid }}</p>
                        <p class="font-mono break-all">Simulated Tx: {{ selectedPurchase.txHash }} <a :href="solanaExplorerUrl(selectedPurchase.txHash)" target="_blank" class="text-blue-500 hover:text-blue-700"><i class="fas fa-external-link-alt text-xs"></i></a> </p>
                        <p class="mt-1 text-gray-500">Video evidence on IPFS, linked on PestiVid platform (Simulated).</p>
                        <a :href="getVideoUrl(selectedPurchase.cid, selectedPurchase.videoStorageType)" target="_blank" class="text-blue-600 hover:underline mt-1 inline-block">View on IPFS Gateway <i class="fas fa-external-link-alt text-xs ml-1"></i></a>
                    </div>
                </div>
                <div class="bg-gray-50 p-4 flex justify-end rounded-b-lg sticky bottom-0 border-t"> <button @click="showPurchaseVideo = false" class="bg-gray-200 hover:bg-gray-300 text-gray-800 px-4 py-2 rounded text-sm"> Close </button> </div>
            </div>
            </div>
            <div v-if="showBuyModal && selectedListing" class="fixed inset-0 z-50 bg-black bg-opacity-60 flex justify-center items-center p-4">
            <div class="bg-white rounded shadow-lg w-full max-w-sm p-6 relative mx-2 modal-scrollable">
                <button class="absolute top-2 right-2 text-gray-400 hover:text-red-500" @click="closeBuyModal"><i class="fas fa-times"></i></button>
                <h3 class="font-bold text-green-700 text-lg mb-3">Purchase Crop Batch</h3>
                <video :src="getVideoUrl(selectedListing.cid, selectedListing.storageType)" controls playsinline webkit-playsinline class="rounded w-full mb-3 bg-black"></video>
                <div class="mb-1 font-bold">{{ selectedListing.crop }}</div>
                <div class="text-xs text-gray-600 mb-1">Location: <span class="font-mono">{{ selectedListing.location }}</span></div>
                <div class="text-xs text-gray-500 mb-1">Pesticide: <span class="font-mono">{{ selectedListing.pesticide }}</span></div>
                <div class="text-xs text-gray-500 mb-2">Pesticide Co.: <span class="font-mono">{{ selectedListing.pesticideCompany || 'N/A' }}</span></div>
                <div class="text-xs text-gray-400 mb-2">File Hash: <span class="font-mono break-all" :title="selectedListing.videoFileHash || 'N/A'">{{ selectedListing.videoFileHash ? selectedListing.videoFileHash.substring(0,10) + '...' : 'N/A' }}</span></div>
                <div class="text-sm my-2">Price Range: <br><span class="mx-1 font-mono font-semibold">{{ selectedListing.minPrice }}</span> - <span class="ml-1 font-mono font-semibold">{{ selectedListing.maxPrice }}</span> SOL</div>
                <form @submit.prevent="processPurchase"> <label class="text-sm block text-gray-600 mb-1">Your Offer (SOL)</label> <input type="number" v-model.number="purchaseAmount" :min="selectedListing.minPrice" :max="selectedListing.maxPrice" step="0.01" required :placeholder="`Enter amount (${selectedListing.minPrice}-${selectedListing.maxPrice})`" class="w-full px-3 py-2 border rounded mb-3 text-sm"> <button type="submit" class="bg-green-600 hover:bg-green-700 text-white w-full py-2 rounded text-sm" :disabled="role !== 'buyer'"> <i class="fas fa-check mr-1"></i>Confirm Purchase </button> </form>
                <div v-if="purchaseStatus" class="text-green-700 font-semibold mt-3 text-sm bg-green-50 p-2 rounded border border-green-200">{{purchaseStatus}}</div> <div v-if="purchaseError" class="text-red-600 font-semibold mt-3 text-sm bg-red-50 p-2 rounded border border-red-200">{{purchaseError}}</div>
            </div>
            </div>
            <div v-if="showInvestmentDetailsModal && selectedInvestment" class="fixed inset-0 z-50 bg-black bg-opacity-70 flex justify-center items-center p-4">
            <div class="bg-white rounded-lg shadow-xl w-full max-w-3xl relative mx-2 modal-scrollable">
                <div class="p-4 bg-green-50 border-b flex justify-between items-center sticky top-0 z-10"> <h3 class="font-bold text-lg text-green-800">{{ selectedInvestment.projectTitle }}</h3> <button class="text-gray-400 hover:text-red-500" @click="showInvestmentDetailsModal=false"><i class="fas fa-times"></i></button> </div>
                <div class="p-6"> <div class="flex flex-col md:flex-row gap-6"> <div class="md:w-1/3"> <video :src="getVideoUrl(selectedInvestment.cid, selectedInvestment.videoStorageType)" controls playsinline webkit-playsinline class="rounded w-full h-40 object-cover bg-black mb-3"></video> <div class="mt-3 space-y-2 text-sm"> <div> <div class="text-xs text-gray-500">Farmer Identifier</div> <div class="font-medium flex items-center font-mono text-xs"> <span>{{ getFarmerDisplayIdentifier(selectedInvestment.farmerWallet) }}</span> <button @click="showFarmerProfile(selectedInvestment.farmerWallet); showInvestmentDetailsModal=false;" class="ml-2 text-blue-500 hover:text-blue-700 text-xs focus:outline-none" title="View Farmer Info"> <i class="fas fa-info-circle"></i> </button> <button @click="startOrGoToConversation(selectedInvestment.farmerWallet); showInvestmentDetailsModal=false;" v-if="currentUserIdentifier !== selectedInvestment.farmerWallet" class="ml-2 text-green-600 hover:text-green-700 text-xs focus:outline-none" title="Message Farmer"> <i class="fas fa-envelope"></i> </button> </div> </div> <div> <div class="text-xs text-gray-500">Investment Date</div> <div class="font-medium">{{ formatTimestamp(selectedInvestment.investmentDate, false) }}</div> </div> <div> <div class="text-xs text-gray-500">Amount Invested</div> <div class="font-medium text-green-700 font-mono">{{ selectedInvestment.amount }} SOL</div> </div> <div> <div class="text-xs text-gray-500">Status</div> <span :class="{'px-2 inline-flex text-xs leading-5 font-semibold rounded-full': true, 'bg-blue-100 text-blue-800': selectedInvestment.status === 'active', 'bg-green-100 text-green-800': selectedInvestment.status === 'harvested', 'bg-yellow-100 text-yellow-800': selectedInvestment.status === 'growing'}"> {{ selectedInvestment.status.charAt(0).toUpperCase() + selectedInvestment.status.slice(1) }} </span> </div> </div> </div> <div class="md:w-2/3"> <div class="mb-4"> <div class="text-sm font-medium mb-1">{{ selectedInvestment.crop }} ({{ selectedInvestment.method }})</div> <p class="text-sm text-gray-700 max-h-24 overflow-y-auto border p-2 rounded bg-gray-50">{{ selectedInvestment.description }}</p> </div> <div class="mb-4"> <div class="text-xs text-gray-500 mb-1">Project Progress</div> <div class="progress-bar"> <div class="progress-fill bg-green-500" :style="{width: selectedInvestment.progress + '%'}"></div> </div> <div class="flex justify-between text-xs mt-1"> <span>{{ selectedInvestment.progress }}% Complete</span> <span>Est. {{ selectedInvestment.timeline }} months total</span> </div> </div>
                                <div v-if="selectedInvestment.updates && selectedInvestment.updates.length > 0" class="mb-4">
                                    <h4 class="text-sm font-semibold text-gray-700 mb-2">Farmer Updates</h4>
                                    <div class="project-updates-list text-xs">
                                        <div v-for="(update, index) in selectedInvestment.updates.slice().reverse()" :key="update._id || index" class="project-update-item">
                                            <span class="font-medium text-gray-500">{{ formatTimestamp(update.date, true) }}:</span> {{ update.text }}
                                        </div>
                                    </div>
                                </div>
                                <div v-else class="mb-4 text-xs text-gray-500"> No project updates posted by the farmer yet. </div>
                                <div class="grid grid-cols-2 gap-4 mb-4 text-sm"> <div> <div class="text-xs text-gray-500">Expected Return</div> <div class="font-medium text-green-700 font-mono">{{ calculateExpectedReturn(selectedInvestment) }} SOL</div> </div> <div> <div class="text-xs text-gray-500">ROI</div> <div class="font-medium text-green-700">{{ selectedInvestment.roi }}%</div> </div> <div> <div class="text-xs text-gray-500">Land Size</div> <div class="font-medium">{{ selectedInvestment.acres }} acres</div> </div> <div> <div class="text-xs text-gray-500">Your Share</div> <div class="font-medium">{{ selectedInvestment.investorShare }}%</div> </div> <div> <div class="text-xs text-gray-500">Video File Hash</div> <p class="font-medium font-mono text-xs break-all" :title="selectedInvestment.videoFileHash || 'N/A'">{{ selectedInvestment.videoFileHash ? selectedInvestment.videoFileHash.substring(0,10) + '...' : 'N/A' }}</p> </div> </div> <div class="bg-gray-100 p-3 rounded mb-4 border"> <div class="text-sm font-medium mb-1">Platform Transaction (Simulated)</div> <div class="flex items-center text-xs"> <span class="font-mono bg-white px-2 py-1 rounded border mr-2 truncate" :title="selectedInvestment.txHash">{{ selectedInvestment.txHash }}</span> <a :href="solanaExplorerUrl(selectedInvestment.txHash)" target="_blank" class="text-blue-600 hover:underline whitespace-nowrap"> <i class="fas fa-external-link-alt"></i> View (Demo Link) </a> </div> </div> <div v-if="selectedInvestment.status === 'harvested'" class="bg-green-100 p-3 rounded border border-green-200"> <div class="flex items-center"> <i class="fas fa-check-circle text-green-600 mr-2 text-lg"></i> <div> <div class="font-medium">Harvest Completed & Payout Processed</div> <div class="text-sm">Your return of {{ calculateExpectedReturn(selectedInvestment) }} SOL has been simulated.</div> </div> </div> </div> <div v-else-if="selectedInvestment.status === 'growing'" class="bg-yellow-50 p-3 rounded border border-yellow-200"> <div class="flex items-center"> <i class="fas fa-hourglass-half text-yellow-600 mr-2 text-lg"></i> <div> <div class="font-medium">Project Growing</div> <div class="text-sm">Harvest expected within {{ selectedInvestment.timeline }} months. Progress: {{selectedInvestment.progress}}%.</div> </div> </div> </div> </div> </div> </div>
                <div class="bg-gray-50 p-4 flex justify-end rounded-b-lg sticky bottom-0 border-t"> <button @click="showInvestmentDetailsModal=false" class="bg-gray-200 hover:bg-gray-300 text-gray-800 px-4 py-2 rounded text-sm"> Close </button> </div>
            </div>
            </div>
            <div v-if="showFarmerProfileModal && selectedFarmerProfile" class="fixed inset-0 z-50 bg-black bg-opacity-70 flex justify-center items-center p-4">
            <div class="bg-white rounded-lg shadow-xl w-full max-w-lg relative mx-2 modal-scrollable">
                <div class="p-4 bg-green-50 border-b flex justify-between items-center sticky top-0 z-10"> <h3 class="font-bold text-lg text-green-800 flex items-center"> <i class="fas fa-user-tie mr-2"></i> Farmer Profile </h3> <button class="text-gray-400 hover:text-red-500" @click="closeFarmerProfileModal"><i class="fas fa-times"></i></button> </div>
                <div class="p-6 space-y-5"> <div class="flex items-center space-x-4"> <div class="bg-green-100 rounded-full w-16 h-16 flex items-center justify-center text-green-600 text-2xl"> <i class="fas fa-tractor"></i> </div> <div> <p class="text-xs text-gray-500">Farmer Identifier (PestiVid ID)</p> <p class="font-semibold text-lg text-green-700 font-mono">{{ selectedFarmerProfile.walletAddress.substring(0,10) }}...</p> <p class="text-sm text-gray-600">Name: {{ selectedFarmerProfile.name || 'N/A' }}</p> </div> </div> <div class="border-t pt-4"> <p class="text-xs text-gray-500">Short Bio</p> <p class="text-sm text-gray-700 italic">{{ selectedFarmerProfile.bio || 'This farmer has not provided a bio yet.' }}</p> </div> <div class="grid grid-cols-1 md:grid-cols-2 gap-4 border-t pt-4"> <div> <p class="text-xs text-gray-500">PestiVid Email</p> <p class="text-sm">{{ selectedFarmerProfile.email }}</p> </div> <div> <p class="text-xs text-gray-500">PestiVid Member Since</p> <p class="text-sm">{{ formatTimestamp(selectedFarmerProfile.memberSince, false) }}</p> </div> </div> <div class="border-t pt-4"> <p class="text-sm font-medium text-gray-700 mb-2">Platform Activity:</p> <div class="grid grid-cols-1 md:grid-cols-2 gap-3 text-sm"> <div class="bg-gray-100 p-3 rounded-md"> <p class="font-semibold">{{ selectedFarmerProfile.fundingRequestCount }}</p> <p class="text-xs text-gray-500">Active Funding Request(s)</p> </div> <div class="bg-gray-100 p-3 rounded-md"> <p class="font-semibold">{{ selectedFarmerProfile.activeListingCount }}</p> <p class="text-xs text-gray-500">Active Marketplace Listing(s)</p> </div> </div> <p class="text-xs text-gray-400 mt-2">(Note: Activity based on currently visible items on the platform.)</p> </div> </div>
                <div class="bg-gray-50 p-4 flex justify-between items-center rounded-b-lg sticky bottom-0 border-t"> <button @click="messageFarmerFromProfile" v-if="selectedFarmerProfile && currentUserIdentifier !== selectedFarmerProfile.walletAddress" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded text-sm"> <i class="fas fa-paper-plane mr-1"></i> Send Message </button> <div v-else class="w-full"></div> <button @click="closeFarmerProfileModal" class="bg-gray-200 hover:bg-gray-300 text-gray-800 px-4 py-2 rounded text-sm"> Close </button> </div>
            </div>
            </div>

            <!-- Notification Toast Container -->
            <div class="notification-toast-container">
                <div v-for="n in recentNotifications" :key="n.id || n._id" class="notification-toast" :class="{'show': n.show}" :data-notif-id="n.id || n._id"> <span :class="['icon', 'icon-' + n.type]"> <i :class="n.type === 'success' ? 'fas fa-check-circle' : (n.type === 'info' ? 'fas fa-info-circle' : (n.type === 'warning' ? 'fas fa-exclamation-triangle' : 'fas fa-bug'))"></i> </span> <span class="message">{{ n.message }}</span> <button @click="dismissNotification(n.id || n._id)" class="close-btn">&times;</button> </div>
            </div>
            <!-- Loading/Transaction Modal -->
            <div v-if="showLoadingModal" class="loading-modal"> <div class="loading-content"> <i class="fas fa-spinner fa-spin"></i> <p class="text-gray-700">{{ loadingMessage }}</p> </div> </div>
        </main>
    </div> <!-- End .flex-grow -->
  </template> <!-- End v-if="isAuthenticated" template wrapper -->


  <!-- Footer -->
  <footer class="bg-white border-t py-6 mt-auto text-center text-sm text-gray-500">
    <span v-if="isAuthenticated"> {{ new Date().getFullYear() }} PestiVid  Blockchain Agricultural Platform (Role: {{ userRoleDisplay }})</span>
     <span v-else> {{ new Date().getFullYear() }} PestiVid  Blockchain Agricultural Platform</span>
  </footer>

  <!-- Interactive Avatar Assistant -->
  <div v-if="avatar.visible && isAuthenticated"
        :class="['fixed z-[9998] p-2 flex flex-col items-end', avatar.position === 'bottom-right' ? 'bottom-4 right-4' : 'bottom-4 left-4']"
        style="transition: all 0.3s ease;">

      <div v-show="avatar.expanded"
          class="bg-white w-80 md:w-96 h-96 max-h-[70vh] mb-2 rounded-xl shadow-2xl flex flex-col overflow-hidden border border-gray-200">
          <header class="bg-green-600 text-white p-3 flex items-center justify-between">
              <div class="flex items-center">
                  <img :src="avatar.images[avatar.character]?.[avatar.state] || avatar.images.farmer.idle" alt="Avatar" class="w-8 h-8 rounded-full mr-2 border-2 border-white">
                  <h3 class="font-semibold">PestiVid Helper</h3>
              </div>
              <button @click="toggleAvatarExpansion(false)" class="text-green-100 hover:text-white">
                  <i class="fas fa-times"></i>
              </button>
          </header>

          <div class="flex-grow p-3 space-y-3 overflow-y-auto" ref="avatarMessagesContainer" style="scroll-behavior: smooth;">
              <div v-for="msg in avatar.chatMessages" :key="msg._id"
                  :class="['flex', msg.sender === 'user' ? 'justify-end' : 'justify-start']">
                  <div :class="['max-w-[80%] p-2.5 rounded-lg shadow-sm text-sm', msg.sender === 'user' ? 'bg-blue-500 text-white rounded-br-none' : 'bg-gray-100 text-gray-800 rounded-bl-none']"
                      v-html="renderMarkdown(msg.text)">
                  </div>
              </div>
              <div v-if="avatar.isProcessing && avatar.state === 'thinking'" class="flex justify-start">
                    <div class="bg-gray-100 text-gray-800 p-2.5 rounded-lg shadow-sm text-sm rounded-bl-none typing-indicator">
                      <span></span><span></span><span></span>
                    </div>
              </div>
          </div>

          <div v-if="avatar.quickActions.length > 0 && !avatar.isProcessing && !avatar.isListening" class="p-2 border-t border-gray-200 flex flex-wrap gap-2 justify-center">
              <button v-for="action in avatar.quickActions" :key="action.id"
                      @click="handleAvatarQuickAction(action)"
                      class="bg-green-100 text-green-700 px-3 py-1.5 text-xs rounded-full hover:bg-green-200 transition-colors">
                  {{ action.label }}
              </button>
          </div>

          <div class="p-3 border-t border-gray-200 bg-gray-50">
              <div class="flex items-center gap-2">
                   <button @click="toggleAvatarListening"
                          :disabled="avatar.isProcessing"
                          title="Toggle Voice Input"
                          class="avatar-input-mic-btn text-gray-500 hover:text-green-600 p-2 rounded-full focus:outline-none"
                          :class="{'text-red-500 listening': avatar.isListening}">
                      <i class="fas fa-microphone text-lg"></i>
                  </button>
                  <input type="text" v-model="avatar.userInput"
                        @keyup.enter="sendAvatarMessage"
                        :placeholder="avatar.isListening ? 'Listening...' : (avatar.isProcessing ? 'Helper is thinking...' : 'Ask PestiVid Helper...')"
                        :disabled="avatar.isProcessing"
                        class="flex-grow px-3 py-2 border border-gray-300 rounded-full text-sm focus:ring-2 focus:ring-green-500 focus:border-green-500">
                  <button @click="sendAvatarMessage" :disabled="avatar.isProcessing || !avatar.userInput.trim()"
                          class="bg-green-600 hover:bg-green-700 text-white rounded-full w-10 h-10 flex items-center justify-center transition-opacity"
                          :class="{'opacity-50 cursor-not-allowed': avatar.isProcessing || !avatar.userInput.trim()}">
                      <i class="fas fa-paper-plane"></i>
                  </button>
              </div>
          </div>
      </div>

      <button @click="toggleAvatarExpansion()"
              class="w-16 h-16 rounded-full shadow-xl overflow-hidden focus:outline-none ring-4 ring-green-500/30 hover:ring-green-500/50 transition-all duration-300 relative"
              :class="[avatar.expanded ? 'transform scale-90 opacity-70' : 'transform scale-100 opacity-100', 'border-4 border-white']"
              :style="{ borderColor: avatar.expanded ? '#10B981' : 'white' }">
          <img :src="avatar.images[avatar.character]?.[avatar.state] || avatar.images.farmer.idle"
                alt="PestiVid Helper Avatar"
                class="w-full h-full object-cover transition-transform duration-500"
                :class="{'animate-pulse-slow': avatar.state === 'thinking'}">
            <span v-if="unreadAvatarMessagesCount > 0 && !avatar.expanded"
                class="absolute -top-1 -right-1 bg-red-500 text-white text-xs font-semibold rounded-full h-5 w-5 flex items-center justify-center shadow-md">
                {{ unreadAvatarMessagesCount }}
            </span>
      </button>
  </div>
</div> <!-- End #app -->
<script>
const app = new Vue({
el: "#app",
data: {
  // --- Backend API Configuration ---
  apiUrl: 'http://localhost:3000/api', // Ensure this matches your backend server
  token: null,

  // --- Authentication State ---
  isAuthenticated: false,
  showSignup: false,
  currentUser: null, // { _id, name, email, role, phone, memberSince, pestividId (simulated wallet) }
  loginForm: { email: '', password: '', remember: false },
  signupForm: { name: '', email: '', role: '', password: '', confirmPassword: '', acceptTerms: false },

  // --- User Data (Simulated, fetched from localStorage initially, or from backend) ---
  users: [ // Sample users for the demo, primarily for lookup by ID/pestividId
    { _id: 'user_farmer_1', pestividId: 'pestivid_farmer_alice', name: 'Alice Farmer', email: 'demo.farmer@example.com', role: 'farmer', phone: '123-456-0001', memberSince: new Date(Date.now() - 100 * 24 * 60 * 60 * 1000).toISOString(), passwordHash: 'password123' },
    { _id: 'user_buyer_1', pestividId: 'pestivid_buyer_bob', name: 'Bob Buyer', email: 'demo.buyer@example.com', role: 'buyer', phone: '123-456-0002', memberSince: new Date(Date.now() - 50 * 24 * 60 * 60 * 1000).toISOString(), passwordHash: 'password123'},
    { _id: 'user_investor_1', pestividId: 'pestivid_investor_charlie', name: 'Charlie Investor', email: 'demo.investor@example.com', role: 'investor', phone: '123-456-0003', memberSince: new Date(Date.now() - 20 * 24 * 60 * 60 * 1000).toISOString(), passwordHash: 'password123' }
  ],
  currentUserIdentifier: null,
  userName: '', userEmail: '', userPhone: '', memberSince: '',

  // --- Application Data (Simulated Backend Data, loaded from localStorage) ---
  farmerVideos: [],
  farmerListings: [],
  farmerFundingRequests: [],
  buyerPurchases: [],
  investorInvestments: [],
  investorTransactions: [],
  allListings: [],
  allFundingRequests: [],

  // --- Forms & Modals State ---
  recordForm: {crop:'', pesticide:'', location:'', pesticideCompany: '', purpose: 'agristream'},
  listingForm: {cid:'', minPrice:null, maxPrice:null, notifyBuyers: true},
  fundingForm: { title: '', crop: '', acres: null, amount: null, method: '', cid: '', description: '', timeline: null, roi: null, investorShare: null },
  buyerFilters: {crop:'', location:'', pesticideCompany: ''},
  investorFilters: {crop: '', method: '', minRoi: null, maxAmount: null},
  showBuyModal: false, selectedListing: null, purchaseAmount: null, purchaseStatus: '', purchaseError: '', createdListingId: null, listingNotificationSent: false,
  investmentAmounts: {}, investmentErrors: {},
  showInvestmentDetailsModal: false, selectedInvestment: null,
  showFarmerProfileModal: false, selectedFarmerProfile: null,
  showPurchaseVideo: false, selectedPurchase: null,
  createdFundingRequest: false,

  // --- Media & Upload State ---
  recordStream: null, recordMediaRecorder: null, recording: false, recordBlob: null, recordBlobUrl: '',
  showLive: false, uploadCid: '', uploading: false, uploadError: '',
  lastUploadedVideoPurpose: '', lastUploadedVideoFileHash: '',
  pinataGateway: 'gateway.pinata.cloud',

  // --- Messaging State ---
  conversations: [],
  messages: [],
  activeConversationId: null, messageInputText: '',

  // --- Notifications State ---
  notifications: [],
  recentNotifications: [],

  // --- Global UI State ---
  current: 'landing', showMobileMenu: false, showLoadingModal: false, loadingMessage: '',

  // --- Navigation/Highlighting ---
  targetAgriStreamVideoCid: null, highlightedAgriStreamVideoCid: null,

  // --- AI Features State ---
  plantImageFile: null, plantImageUrl: null, plantImageMimeType: null,
  analysisInProgress: false, analysisResultText: '',
  parsedAnalysis: { plantName: null, diseaseName: null, treatmentRecommended: null },
  analysisErrorText: '',
  chatMessages: [], chatInput: '', isGroqLoading: false,
  groqSystemPrompt: "You are AgriBot, a knowledgeable and friendly AI assistant for farmers. Your expertise includes crop management (like tomatoes, strawberries, lettuce, peppers), pest and disease control (organic and conventional methods), soil health, irrigation, farm-to-market advice, and general agricultural best practices. You can also help explain features of the PestiVid platform. Provide clear, concise, and actionable advice. If a question is outside your agricultural expertise, politely state that. Always remind the user that your advice is for informational purposes and they should consult with local agricultural experts or conduct their own research before making critical farming decisions.",

  // Avatar Helper
  avatar: {
      visible: true, expanded: false, state: 'idle', character: 'farmer', position: 'bottom-right',
      chatMessages: [], userInput: '', quickActions: [], currentContextText: '',
      images: {
          farmer: { idle: 'https://img.icons8.com/plasticine/100/farmer-male.png', talking: 'https://img.icons8.com/plasticine/100/farmer-male.png', thinking: 'https://img.icons8.com/plasticine/100/farmer-male.png', listening: 'https://img.icons8.com/plasticine/100/farmer-male.png' },
          buyer: { idle: 'https://img.icons8.com/plasticine/100/shopping-cart.png', talking: 'https://img.icons8.com/plasticine/100/shopping-cart.png', thinking: 'https://img.icons8.com/plasticine/100/shopping-cart.png', listening: 'https://img.icons8.com/plasticine/100/shopping-cart.png', },
          investor: { idle: 'https://img.icons8.com/plasticine/100/line-chart.png', talking: 'https://img.icons8.com/plasticine/100/line-chart.png', thinking: 'https://img.icons8.com/plasticine/100/line-chart.png', listening: 'https://img.icons8.com/plasticine/100/line-chart.png', }
      },
      systemPrompt: "You are PestiVid Helper, a friendly and knowledgeable AI assistant for the PestiVid platform. You are represented by a visual avatar. Your goal is to help users navigate the platform, understand its features (like PestiVid video uploads, AgriStream, Marketplace, Funding, PlantRecommend, Messaging, Investment Opportunities, Investor Portfolio, User Profile), and answer their questions. Be encouraging and clear. If asked about a specific page, try to provide relevant tips. When the user opens your chat, if you have context, offer a relevant quick action or greeting. Keep responses concise for a chat interface. Suggest navigating to relevant pages when appropriate, using the format: [action:Go to PageName].",
      isProcessing: false, isListening: false,
  },
  speechRecognition: null,
},
computed: {
  userRoleDisplay() { return this.role ? (this.role.charAt(0).toUpperCase() + this.role.slice(1)) : 'User'; },
  userNameDisplay() { return this.currentUser && this.currentUser.name ? this.currentUser.name.split(' ')[0] : 'User'; },
  userEmailDisplay() { return this.currentUser?.email || 'Not Provided'; },
  userPhoneDisplay() { return this.currentUser?.phone || 'Not Provided'; },
  memberSinceDisplay() {
        if (this.currentUser?.memberSince) {
             try { return new Date(this.currentUser.memberSince).toLocaleDateString(); }
             catch (e) { console.error("Error formatting memberSince date:", e, this.currentUser.memberSince); return this.currentUser.memberSince; }
        }
        return 'N/A';
   },
  role() { return this.currentUser?.role || 'Not Set'; },

  availableVideosForListing() {
       if (!this.isAuthenticated || this.role !== 'farmer' || !this.farmerVideos || !this.farmerListings) return [];
       const listedCids = new Set(this.farmerListings.filter(l => l.status === 'active').map(l => l.cid));
       return this.farmerVideos.filter(v => v.farmerWallet === this.currentUserIdentifier && (v.purpose === 'sell' || v.purpose === 'agristream') && !listedCids.has(v.cid));
  },
  availableVideosForFunding() {
       if (!this.isAuthenticated || this.role !== 'farmer' || !this.farmerVideos || !this.farmerFundingRequests) return [];
       const fundingCids = new Set(this.farmerFundingRequests.filter(r => r.farmerWallet === this.currentUserIdentifier && ['pending', 'partially_funded', 'funded', 'growing'].includes(r.status)).map(r => r.cid));
       return this.farmerVideos.filter(v => v.farmerWallet === this.currentUserIdentifier && (v.purpose === 'funding' || v.purpose === 'agristream') && !fundingCids.has(v.cid));
  },
  uniqueCrops() {
       const crops = this.allListings.filter(l => l.status === 'active').map(l=>l.crop).filter(Boolean);
       return [...new Set(crops)].sort();
  },
  filteredListings() {
       const oneDayAgo = Date.now() - (24*60*60*1000);
       return this.allListings.filter(l => l.status === 'active')
         .map(l => ({...l, isNew: new Date(l.createdAt) > oneDayAgo }))
         .filter(l => {
            const cropMatch = !this.buyerFilters.crop || (l.crop || '').toLowerCase() === this.buyerFilters.crop.toLowerCase();
            const locMatch = !this.buyerFilters.location || (l.location || '').toLowerCase().includes(this.buyerFilters.location.toLowerCase());
            const companyMatch = !this.buyerFilters.pesticideCompany || (l.pesticideCompany || '').toLowerCase().includes(this.buyerFilters.pesticideCompany.toLowerCase());
            return cropMatch && locMatch && companyMatch;
        }).sort((a,b) => new Date(b.createdAt) - new Date(a.createdAt));
  },
  uniqueFundingCrops() {
       const crops = this.allFundingRequests.filter(r => ['pending', 'partially_funded'].includes(r.status)).map(r=>r.crop).filter(Boolean);
       return [...new Set(crops)].sort();
  },
  filteredFundingRequests() {
       const oneDayAgo = Date.now() - (24*60*60*1000);
       return this.allFundingRequests.filter(r => ['pending', 'partially_funded'].includes(r.status))
         .map(r => ({ ...r, isNew: new Date(r.createdAt) > oneDayAgo }))
         .filter(r => {
            const cropMatch = !this.investorFilters.crop || (r.crop||'').toLowerCase() === this.investorFilters.crop.toLowerCase();
            const methodMatch = !this.investorFilters.method || (r.method||'').toLowerCase() === this.investorFilters.method.toLowerCase();
            const roiMatch = !this.investorFilters.minRoi || r.roi >= this.investorFilters.minRoi;
            const amountMatch = !this.investorFilters.maxAmount || r.amount <= this.investorFilters.maxAmount;
            return cropMatch && methodMatch && roiMatch && amountMatch;
        }).sort((a,b) => new Date(b.createdAt) - new Date(a.createdAt));
  },
  totalInvestedAmount() { if (!this.investorInvestments || this.investorInvestments.length === 0) return '0.00'; return this.investorInvestments.reduce((sum, inv) => sum + inv.amount, 0).toFixed(2); },
  investorActiveProjects() { if (!this.investorInvestments) return 0; return this.investorInvestments.filter(inv => inv.status === 'active' || inv.status === 'growing').length; },
  investorCompletedProjects() { if (!this.investorInvestments) return 0; return this.investorInvestments.filter(inv => inv.status === 'harvested').length; },
  investorAvgRoi() { if (!this.investorInvestments || this.investorInvestments.length === 0) return '0.0'; const totalRoi = this.investorInvestments.reduce((sum, inv) => sum + inv.roi, 0); return this.investorInvestments.length > 0 ? (totalRoi / this.investorInvestments.length).toFixed(1) : '0.0'; },

  userConversations() {
       if (!this.isAuthenticated || !this.currentUserIdentifier || !this.conversations) return [];
       return this.conversations.filter(c => c.participants.includes(this.currentUserIdentifier))
           .slice().sort((a, b) => new Date(b.lastMessageTimestamp) - new Date(a.lastMessageTimestamp));
  },
  currentMessages() {
       if (!this.activeConversationId || !this.isAuthenticated || !this.messages) return [];
       return this.messages.filter(msg => msg.conversationId === this.activeConversationId).slice().sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));
  },
  activeConversationPartnerIdentifier() {
       if (!this.activeConversationId || !this.isAuthenticated || !this.conversations || !this.currentUserIdentifier) return null;
       const conv = this.conversations.find(c => c._id === this.activeConversationId);
       if (!conv) return null;
       return conv.participants.find(p => p !== this.currentUserIdentifier);
  },
  activeConversationPartnerDisplayAddress() {
        const partnerId = this.activeConversationPartnerIdentifier;
        if (!partnerId) return 'Loading...';
        const partnerUser = this.users.find(u => u._id === partnerId);
        if (partnerUser && partnerUser.name) return partnerUser.name.split(" ")[0];
        return `User ${partnerId.toString().substring(partnerId.length-4)}`;
   },
  activeConversationPartnerInitial() {
       const partnerDisplay = this.activeConversationPartnerDisplayAddress;
       if (!partnerDisplay || partnerDisplay === 'Loading...') return '?';
       return partnerDisplay.charAt(0).toUpperCase();
  },
  unreadMessageCount() {
       if (!this.isAuthenticated || !this.currentUserIdentifier || !this.messages) return 0;
       let count = 0;
       this.conversations.forEach(conv => {
           if (conv.participants.includes(this.currentUserIdentifier)) {
               count += this.messages.filter(msg =>
                   msg.conversationId === conv._id &&
                   msg.receiver === this.currentUserIdentifier &&
                   !msg.read
               ).length;
           }
       });
       return count;
  },
  unreadAvatarMessagesCount() {
       if (!this.isAuthenticated || this.avatar.expanded || !this.avatar.chatMessages) return 0;
       return this.avatar.chatMessages.filter(msg => msg.sender === 'bot' && !msg.readByUser).length;
  },
},
watch: {
    current(newPage, oldPage) {
        window.scrollTo(0,0);
        if (newPage === 'farmerAgriStream' && this.targetAgriStreamVideoCid) {
             this.scrollToAndHighlightAgriStreamVideo();
         } else if (newPage !== 'farmerAgriStream') {
             this.highlightedAgriStreamVideoCid = null;
         }
        if (this.isAuthenticated) {
             if (newPage === 'messaging') {
                 this.loadUserConversations();
                 if (this.activeConversationId) {
                     this.$nextTick(() => {
                          this.scrollToMessageBottom();
                          this.markConversationAsRead(this.activeConversationId);
                     });
                 }
             }
             if (newPage === 'investorPortfolio' && this.role === 'investor') {
                  this.updateInvestmentProgress();
             }
            if (newPage === 'farmerChatbot' && this.role === 'farmer') {
                this.initializeChatbot();
                this.$nextTick(() => this.scrollToChatBottom());
            }
            if (this.avatar.visible && this.avatar.expanded) {
                this.updateAvatarContextAndQuickActions();
            }
        }
        if (oldPage === 'plantRecommendation' && newPage !== 'plantRecommendation') {
            this.plantImageFile = null; this.plantImageUrl = null; this.plantImageMimeType = null;
            this.analysisResultText = ''; this.parsedAnalysis = { plantName: null, diseaseName: null, treatmentRecommended: null };
            this.analysisErrorText = '';
        }
    },
    chatMessages: {
        handler() { if (this.current === 'farmerChatbot') this.$nextTick(() => this.scrollToChatBottom()); },
        deep: true
    },
    messages: {
         handler() { if (this.current === 'messaging' && this.activeConversationId) this.$nextTick(() => this.scrollToMessageBottom()); },
         deep: true
     },
    activeConversationId(newConvId, oldConvId) {
         if (newConvId && this.current === 'messaging') {
             this.loadMessagesForConversation(newConvId);
             this.$nextTick(() => {
                  this.scrollToMessageBottom();
                  this.markConversationAsRead(newConvId);
              });
         }
    },
    'avatar.chatMessages': {
        handler(newMessages, oldMessages) { if (newMessages.length > (oldMessages ? oldMessages.length : 0) ) this.$nextTick(() => this.scrollToAvatarMessagesBottom()); },
        deep: true
    },
     'avatar.isListening'(isListening) {
         if (isListening) { if ('speechSynthesis' in window && speechSynthesis.speaking) { speechSynthesis.cancel(); this.avatar.state = 'listening'; }}
         else { if (this.avatar.state === 'listening') this.avatar.state = 'idle'; }
     },
     role(newRole, oldRole) {
         if (this.isAuthenticated) {
             this.avatar.character = newRole || 'farmer';
             this.updateAvatarContextAndQuickActions();
         }
     },
    isAuthenticated(isAuth, wasAuth) {
         if (isAuth) {
             console.log("isAuthenticated changed to true. User:", this.currentUserIdentifier);
             this.avatar.character = this.role || 'farmer';
             if (!this.speechRecognition && ('speechSynthesis' in window && ('SpeechRecognition' in window || 'webkitSpeechRecognition' in window))) {
                this.initializeSpeechRecognition();
             } else if (!('speechSynthesis'in window) || !('SpeechRecognition'in window || 'webkitSpeechRecognition'in window)) {
                console.warn("Avatar voice features (TTS/STT) not fully supported by this browser.");
                this.avatar.visible = false;
             }
             this.loadUserAppData();
         } else {
             console.log("isAuthenticated changed to false. Clearing session data.");
             if ('speechSynthesis' in window && speechSynthesis.speaking) { speechSynthesis.cancel(); }
             if (this.speechRecognition && this.avatar.isListening) { this.speechRecognition.stop(); }
             this.avatar.isListening = false; this.avatar.isProcessing = false; this.avatar.state = 'idle';
             this.avatar.expanded = false; this.avatar.chatMessages = [];
             this.clearUserSpecificData();
         }
    }
},
methods: {
    // --- Utility ---
    generateId(prefix = 'id_') { return prefix + Date.now().toString(36) + Math.random().toString(36).substring(2, 10); },
    generateSimulatedTxHash(prefix = 'sim_tx') { return this.generateId(prefix); },

    switchPage(page) { this.current = page; this.showMobileMenu = false; },
    navigateToPageWithParam(page, paramName, paramValue) {
         if (page === 'farmerSell' && paramName === 'cid') this.listingForm.cid = paramValue;
         else if (page === 'farmerFunding' && paramName === 'cid') this.fundingForm.cid = paramValue;
         else if (page === 'farmerAgriStream' && paramName === 'highlightCid') this.targetAgriStreamVideoCid = paramValue;
         this.switchPage(page);
    },
    getStarted() {
        if (!this.isAuthenticated) { this.addNotification("Please sign up or log in to get started.", "info"); return; }
        if (this.role === 'farmer') { this.switchPage('farmerPestiVid'); }
        else if (this.role === 'buyer') { this.switchPage('buyerAgriSell'); }
        else if (this.role === 'investor') { this.switchPage('investorProjects'); }
        else { this.switchPage('userProfile'); }
    },
    getFarmerDisplayIdentifier(userId, length = 8) {
         if (!userId) return 'N/A';
         const user = this.users.find(u => u._id === userId || u.pestividId === userId);
         if (user && user.name) return user.name.split(' ')[0];
         if (typeof userId === 'string') return `${userId.substring(0, length)}...`;
         return 'Unknown User';
     },
     getSellerDisplayIdentifier(userId, length = 8) { return this.getFarmerDisplayIdentifier(userId, length); },
     getVideoUrl(cid, storageType) {
          if (storageType === 'ipfs' && cid && this.pinataGateway) {
              return `https://${this.pinataGateway}/ipfs/${cid}`;
          }
         console.warn(`Cannot generate video URL for CID: ${cid} (Storage: ${storageType}). Check config.`);
         return "https://www.w3schools.com/html/mov_bbb.mp4"; // Fallback
     },
    async calculateFileHash(fileBlob) {
         if (!fileBlob) return null;
         try {
             const buffer = await fileBlob.arrayBuffer();
             const hashBuffer = await crypto.subtle.digest('SHA-256', buffer);
             const hashArray = Array.from(new Uint8Array(hashBuffer));
             return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
         } catch (error) { console.error("Error calculating file hash:", error); this.addNotification("Error calculating video integrity hash.", "error"); return null; }
     },

    // --- Authentication Methods (Client-Side Simulated) ---
    login() {
        this.loadingMessage = "Signing in..."; this.showLoadingModal = true;

        // --- START OF CLIENT-SIDE SIMULATION ---
        const email = this.loginForm.email.toLowerCase();
        const password = this.loginForm.password;
        const foundUser = this.users.find(u => u.email.toLowerCase() === email);

        setTimeout(() => { // Simulate network delay
            if (foundUser && foundUser.passwordHash === password) { // In demo, passwordHash is plain password
                this.token = 'simulated_token_' + Date.now(); // Generate a dummy token
                this.currentUser = { ...foundUser }; // Create a copy
                this.isAuthenticated = true;
                this.currentUserIdentifier = this.currentUser._id;
                this.userName = this.currentUser.name;
                this.userEmail = this.currentUser.email;
                this.userPhone = this.currentUser.phone;
                this.memberSince = this.currentUser.memberSince;
                axios.defaults.headers.common['Authorization'] = `Bearer ${this.token}`; // Still good practice

                if (this.loginForm.remember) {
                    localStorage.setItem('pestivid_token', this.token);
                    localStorage.setItem('pestivid_user_id', this.currentUser._id);
                    localStorage.setItem('pestivid_email', this.loginForm.email);
                }
                this.addNotification(`Welcome back, ${this.userNameDisplay}! (Simulated Login)`, 'success');
                this.current = 'landing';
                // this.loadUserAppData(); // This will be called by isAuthenticated watcher
            } else {
                this.addNotification("Login failed. Invalid email or password (Simulated).", "error");
            }
            this.showLoadingModal = false; this.loadingMessage = "";
        }, 1000);
        // --- END OF CLIENT-SIDE SIMULATION ---
    },

    signup() {
        if (this.signupForm.password !== this.signupForm.confirmPassword) { this.addNotification("Passwords do not match.", "error"); return; }
        if (!this.signupForm.acceptTerms) { this.addNotification("You must agree to the terms and conditions.", "warning"); return; }

        this.loadingMessage = "Creating account..."; this.showLoadingModal = true;

        // --- START OF CLIENT-SIDE SIMULATION ---
        const email = this.signupForm.email.toLowerCase();
        const existingUser = this.users.find(u => u.email.toLowerCase() === email);

        setTimeout(() => { // Simulate network delay
            if (existingUser) {
                this.addNotification("Signup failed. Email already exists (Simulated).", "error");
            } else {
                const newUser = {
                    _id: this.generateId('user_'),
                    pestividId: this.generateId('pestivid_'), // Simulate a blockchain-like ID
                    name: this.signupForm.name,
                    email: this.signupForm.email,
                    role: this.signupForm.role,
                    phone: '', // Placeholder
                    memberSince: new Date().toISOString(),
                    passwordHash: this.signupForm.password // Store plain password for demo login
                };
                this.users.push(newUser);
                localStorage.setItem('pestivid_users', JSON.stringify(this.users)); // Update users in localStorage

                this.addNotification("Signup successful! Please log in. (Simulated)", "success");
                this.showSignup = false;
                this.loginForm.email = this.signupForm.email;
                this.loginForm.password = ''; // Clear password field
                this.signupForm = { name: '', email: '', role: '', password: '', confirmPassword: '', acceptTerms: false };
            }
            this.showLoadingModal = false; this.loadingMessage = "";
        }, 1000);
        // --- END OF CLIENT-SIDE SIMULATION ---
    },
    logout() {
        this.addNotification("You have been logged out.", "info");
        this.token = null; this.currentUser = null; this.isAuthenticated = false; this.currentUserIdentifier = null;
        this.userName = ''; this.userEmail = ''; this.userPhone = ''; this.memberSince = '';
        localStorage.removeItem('pestivid_token'); localStorage.removeItem('pestivid_user_id');
        // Optionally keep email: localStorage.removeItem('pestivid_email');
        delete axios.defaults.headers.common['Authorization'];
        this.current = 'landing'; this.showMobileMenu = false;
    },
    forgotPassword() { this.addNotification("Password reset is not available in this demo.", "info"); },

    loadPublicPlatformData() {
        // Load from localStorage for demo persistence
        try { this.allListings = JSON.parse(localStorage.getItem('pestivid_allListings') || '[]').filter(l => l.status === 'active'); }
        catch (e) { console.error("Error parsing allListings:",e); this.allListings = []; localStorage.removeItem('pestivid_allListings');}

        try { this.allFundingRequests = JSON.parse(localStorage.getItem('pestivid_allFundingRequests') || '[]').filter(r => ['pending', 'partially_funded'].includes(r.status)); }
        catch (e) { console.error("Error parsing allFundingRequests:",e); this.allFundingRequests = []; localStorage.removeItem('pestivid_allFundingRequests');}
    },
    loadUserAppData() {
        if (!this.isAuthenticated || !this.currentUserIdentifier) return;
        // For demo, data is filtered from global arrays. In real app, it's fetched.
        try { this.farmerVideos = JSON.parse(localStorage.getItem('pestivid_farmerVideos') || '[]').filter(v => v.farmerWallet === this.currentUserIdentifier); }
        catch (e) { console.error("Error parsing farmerVideos:",e); this.farmerVideos = []; localStorage.removeItem('pestivid_farmerVideos');}

        try { this.farmerListings = JSON.parse(localStorage.getItem('pestivid_farmerListings') || '[]').filter(l => l.farmerWallet === this.currentUserIdentifier); }
        catch (e) { console.error("Error parsing farmerListings:",e); this.farmerListings = []; localStorage.removeItem('pestivid_farmerListings');}

        try { this.farmerFundingRequests = JSON.parse(localStorage.getItem('pestivid_farmerFundingRequests') || '[]').filter(r => r.farmerWallet === this.currentUserIdentifier); }
        catch (e) { console.error("Error parsing farmerFundingRequests:",e); this.farmerFundingRequests = []; localStorage.removeItem('pestivid_farmerFundingRequests');}

        try { this.buyerPurchases = JSON.parse(localStorage.getItem('pestivid_buyerPurchases') || '[]').filter(p => p.buyerWallet === this.currentUserIdentifier); }
        catch (e) { console.error("Error parsing buyerPurchases:",e); this.buyerPurchases = []; localStorage.removeItem('pestivid_buyerPurchases');}

        try { this.investorInvestments = JSON.parse(localStorage.getItem('pestivid_investorInvestments') || '[]').filter(i => i.investorWallet === this.currentUserIdentifier); }
        catch (e) { console.error("Error parsing investorInvestments:",e); this.investorInvestments = []; localStorage.removeItem('pestivid_investorInvestments');}

        try { this.investorTransactions = JSON.parse(localStorage.getItem('pestivid_investorTransactions') || '[]').filter(t => t.userId === this.currentUserIdentifier); }
        catch (e) { console.error("Error parsing investorTransactions:",e); this.investorTransactions = []; localStorage.removeItem('pestivid_investorTransactions');}


        this.loadUserConversations();
        this.loadUserNotifications();
        this.loadAvatarChatHistory();
        try {
            const storedAgriBotChat = localStorage.getItem(`pestivid_agribot_chat_${this.currentUserIdentifier}`);
            if (storedAgriBotChat) this.chatMessages = JSON.parse(storedAgriBotChat); else this.chatMessages = [];
        } catch(e) {
            console.error("Error parsing AgriBot chat:", e); this.chatMessages = []; localStorage.removeItem(`pestivid_agribot_chat_${this.currentUserIdentifier}`);
        }
    },
    clearUserSpecificData() {
        this.farmerVideos = []; this.farmerListings = []; this.farmerFundingRequests = [];
        this.buyerPurchases = []; this.investorInvestments = []; this.investorTransactions = [];
        this.conversations = []; this.messages = []; this.notifications = [];
        this.chatMessages = [];
        this.avatar.chatMessages = [];
    },

    // --- Farmer PestiVid ---
    async startVideo() {
        if (!this.isAuthenticated || this.role !== 'farmer') { this.addNotification("Log in as Farmer.", "info"); return; }
        if (this.recording || this.uploading) return;
        if (window.location.protocol !== 'https:' && !['localhost', '127.0.0.1'].includes(window.location.hostname) ) {
             console.warn("HTTPS is highly recommended for camera access.");
         }
        this.recordBlob = null; if (this.recordBlobUrl) URL.revokeObjectURL(this.recordBlobUrl); this.recordBlobUrl = '';
        this.uploadCid = ''; this.uploadError = ''; this.lastUploadedVideoFileHash = '';
        this.showLive = true; this.recording = true;
        try {
            const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" }, audio: false });
            this.recordStream = stream; this.$refs.liveVideo.srcObject = stream; this.$refs.liveVideo.play(); let chunks = [];
            const mimeTypes = ['video/webm;codecs=vp9,opus', 'video/webm;codecs=vp8,opus', 'video/webm', 'video/mp4'];
            let selectedMimeType = mimeTypes.find(type => MediaRecorder.isTypeSupported(type)) || undefined;
            this.recordMediaRecorder = new MediaRecorder(stream, { mimeType: selectedMimeType });
            this.recordMediaRecorder.ondataavailable = (e) => { if (e.data.size > 0) chunks.push(e.data); };
            this.recordMediaRecorder.onstop = () => {
                const blobType = this.recordMediaRecorder.mimeType || 'video/webm';
                this.recordBlob = new Blob(chunks, { type: blobType });
                if (this.recordBlobUrl) URL.revokeObjectURL(this.recordBlobUrl); this.recordBlobUrl = URL.createObjectURL(this.recordBlob);
                this.showLive = false; stream.getTracks().forEach(t => t.stop()); this.recordStream = null; this.recording = false; chunks = [];
            };
            this.recordMediaRecorder.onerror = (e) => { console.error("MediaRecorder error:", e); this.uploadError = "Recording error: " + (e.error ? e.error.name : "Unknown"); this.addNotification(this.uploadError, "error"); this.stopVideo(); };
            this.recordMediaRecorder.start(1000);
        } catch (e) {
            console.error("Error starting video recording:", e);
            let userErrorMessage = "Could not start video. ";
            if (e.name === 'NotAllowedError' || e.name === 'PermissionDeniedError') userErrorMessage += "Camera access denied."; else if (e.name === 'NotFoundError' || e.name === 'DevicesNotFoundError') userErrorMessage += "No camera found."; else userErrorMessage += `Error: ${e.name || e.message}.`;
            if (window.location.protocol !== 'https:') userErrorMessage += " Using HTTPS is recommended.";
            this.addNotification(userErrorMessage, "error"); this.uploadError = userErrorMessage; this.showLive = false; this.recording = false;
            if (this.recordStream) { this.recordStream.getTracks().forEach(t => t.stop()); this.recordStream = null; }
        }
    },
    stopVideo() {
        if (this.recordMediaRecorder && this.recordMediaRecorder.state === "recording") this.recordMediaRecorder.stop();
        if (this.recordStream) { this.recordStream.getTracks().forEach(t => t.stop()); this.recordStream = null; }
        this.recording = false;
    },
    async uploadVideo() {
        if (!this.isAuthenticated || this.role !== 'farmer') { this.addNotification("Log in as Farmer.", "info"); return; }
        if (!this.recordBlob || this.recordBlob.size === 0) { this.addNotification("No video or empty video.", "warning"); return; }
        if (!this.recordForm.crop || !this.recordForm.location || !this.recordForm.purpose) { this.addNotification("Fill video details.", "warning"); return; }

        this.uploading = true; this.uploadCid = ''; this.uploadError = ''; this.lastUploadedVideoFileHash = '';
        this.loadingMessage = "Calculating hash and simulating upload..."; this.showLoadingModal = true;
        
        try {
            const videoFileHash = await this.calculateFileHash(this.recordBlob);
            if (!videoFileHash) {
                this.uploadError = "Hash calculation failed."; this.addNotification(this.uploadError, "error");
                this.uploading = false; this.showLoadingModal = false; return;
            }
            this.lastUploadedVideoFileHash = videoFileHash;

            // Simulate IPFS upload by generating a fake CID
            // A real implementation would POST the file to a backend, which then uses a service like Pinata's API.
            const simulatedCID = 'Qm' + this.generateId('').replace(/id_/, '').substring(0, 44);
            
            // Simulate delay for upload process
            await new Promise(resolve => setTimeout(resolve, 1500)); 

            this.saveVideoMetadata(simulatedCID, 'ipfs', videoFileHash);

        } catch (e) {
            console.error("IPFS Upload Simulation Error:", e);
            this.uploadError = "IPFS upload simulation failed. See console for details.";
            this.addNotification(this.uploadError, "error");
        } finally {
            this.uploading = false;
            this.showLoadingModal = false;
            this.loadingMessage = '';
        }
    },
    saveVideoMetadata(cid, storageType, videoFileHash) {
        const newVideoData = {
            _id: this.generateId('vid_'), cid: cid, storageType: storageType, videoFileHash: videoFileHash,
            crop: this.recordForm.crop.trim(), pesticide: (this.recordForm.pesticide || '').trim(),
            location: this.recordForm.location.trim(), pesticideCompany: (this.recordForm.pesticideCompany || '').trim(),
            purpose: this.recordForm.purpose, farmerWallet: this.currentUserIdentifier, createdAt: new Date().toISOString(),
        };
        this.farmerVideos.unshift(newVideoData);
        localStorage.setItem('pestivid_farmerVideos', JSON.stringify(this.farmerVideos)); // Update global store for demo
        this.uploadCid = newVideoData.cid; this.lastUploadedVideoPurpose = newVideoData.purpose; this.lastUploadedVideoFileHash = newVideoData.videoFileHash;
        this.recordForm = { crop: '', pesticide: '', location: '', pesticideCompany: '', purpose: 'agristream' };
        if (this.recordBlobUrl) URL.revokeObjectURL(this.recordBlobUrl); this.recordBlob = null; this.recordBlobUrl = '';

        if (newVideoData.purpose === 'sell') { this.addNotification(`Video for "${newVideoData.crop}" uploaded. Redirecting...`, 'info'); this.navigateToPageWithParam('farmerSell', 'cid', newVideoData.cid); }
        else if (newVideoData.purpose === 'funding') { this.addNotification(`Video for "${newVideoData.crop}" uploaded. Redirecting...`, 'info'); this.navigateToPageWithParam('farmerFunding', 'cid', newVideoData.cid); }
        else { this.addNotification(`Video for "${newVideoData.crop}" added to AgriStream!`, 'success');
             if (this.current === 'farmerAgriStream') { this.targetAgriStreamVideoCid = newVideoData.cid; this.$nextTick(() => this.scrollToAndHighlightAgriStreamVideo()); }
        }
    },

    // --- Farmer AgriStream ---
    isListed(cid) { return this.farmerListings.some(l => l.cid === cid && l.farmerWallet === this.currentUserIdentifier && l.status === 'active'); },
    isUsedInFunding(cid) { return this.farmerFundingRequests.some(req => req.cid === cid && req.farmerWallet === this.currentUserIdentifier && ['pending', 'partially_funded', 'funded', 'growing'].includes(req.status)); },
    goToListing(cid) { this.navigateToPageWithParam('farmerSell', 'cid', cid); },
    scrollToAndHighlightAgriStreamVideo() {
        if (this.targetAgriStreamVideoCid) {
            this.highlightedAgriStreamVideoCid = this.targetAgriStreamVideoCid;
            this.$nextTick(() => {
                const videoCardRef = this.$refs['videoCard-' + this.targetAgriStreamVideoCid];
                if (videoCardRef && videoCardRef[0]) {
                    videoCardRef[0].scrollIntoView({ behavior: 'smooth', block: 'center' });
                    setTimeout(() => { this.highlightedAgriStreamVideoCid = null; this.targetAgriStreamVideoCid = null; }, 3000);
                } else {
                    setTimeout(() => {
                        const videoCardRefRetry = this.$refs['videoCard-' + this.targetAgriStreamVideoCid];
                        if (videoCardRefRetry && videoCardRefRetry[0]) videoCardRefRetry[0].scrollIntoView({ behavior: 'smooth', block: 'center' });
                        setTimeout(() => { this.highlightedAgriStreamVideoCid = null; this.targetAgriStreamVideoCid = null; }, 3000);
                    }, 500);
                }
            });
        }
    },

    // --- Farmer Sell ---
    createListing() {
        if (!this.isAuthenticated || this.role !== 'farmer') { this.addNotification("Log in as Farmer.", "info"); return; }
        if (!this.listingForm.cid || this.listingForm.minPrice === null || this.listingForm.maxPrice === null) { this.addNotification("Select video and price range.", "warning"); return; }
        const minP = parseFloat(this.listingForm.minPrice); const maxP = parseFloat(this.listingForm.maxPrice);
        if (isNaN(minP) || isNaN(maxP) || minP <= 0 || maxP <= 0 || minP > maxP) { this.addNotification("Valid prices required.", "warning"); return; }

        const vid = this.farmerVideos.find(v => v.cid === this.listingForm.cid && v.farmerWallet === this.currentUserIdentifier);
        if (!vid) { this.addNotification("Video not found or invalid.", "error"); return; }
        if (this.isListed(vid.cid)) { this.addNotification("Video already listed.", "warning"); return; }

        this.loadingMessage = "Creating listing..."; this.showLoadingModal = true;
        this.createdListingId = null; this.listingNotificationSent = false;
        const newListing = {
            _id: this.generateId('list_'), cid: vid.cid, storageType: vid.storageType, videoFileHash: vid.videoFileHash,
            crop: vid.crop, pesticide: vid.pesticide, location: vid.location, pesticideCompany: vid.pesticideCompany,
            minPrice: minP, maxPrice: maxP, farmerWallet: this.currentUserIdentifier, status: 'active',
            txHash: this.generateSimulatedTxHash('list_tx_'), createdAt: new Date().toISOString(),
            notificationSent: this.listingForm.notifyBuyers,
        };
        this.farmerListings.unshift(newListing);
        this.allListings.unshift(newListing);
        localStorage.setItem('pestivid_farmerListings', JSON.stringify(this.farmerListings));
        localStorage.setItem('pestivid_allListings', JSON.stringify(this.allListings)); // For demo persistence
        this.createdListingId = newListing.txHash; this.listingNotificationSent = newListing.notificationSent;
        this.addNotification('Listing created!', 'success');
        if (newListing.notificationSent) { this.addNotification('Potential buyers will be notified (simulated).', 'info', null, true); }
        this.listingForm = { cid: '', minPrice: null, maxPrice: null, notifyBuyers: true };
        setTimeout(() => { this.createdListingId = null; this.uploadError = ''; }, 5000);
        this.showLoadingModal = false; this.loadingMessage = '';
    },
    notifyBuyersAboutListing(listing, isResend = false) {
         if (!listing.notificationSent || isResend) {
             this.addNotification(`Simulating notification to buyers for "${listing.crop}".`, "success", null, true);
             const lIdx = this.farmerListings.findIndex(l => l._id === listing._id);
             if (lIdx > -1) this.$set(this.farmerListings[lIdx], 'notificationSent', true);
             const allLIdx = this.allListings.findIndex(l => l._id === listing._id);
             if (allLIdx > -1) this.$set(this.allListings[allLIdx], 'notificationSent', true);
              localStorage.setItem('pestivid_farmerListings', JSON.stringify(this.farmerListings));
              localStorage.setItem('pestivid_allListings', JSON.stringify(this.allListings));
         } else { this.addNotification("Buyers already notified for this listing.", "info"); }
    },

    // --- Farmer Funding ---
    fundingProgressPercent(req) {
        if (!req || typeof req.fundedAmount !== 'number' || typeof req.amount !== 'number' || req.amount === 0) return 0;
        return Math.min(100, Math.round((req.fundedAmount / req.amount) * 100));
    },
    createFundingRequest_V1() {
        if (!this.isAuthenticated || this.role !== 'farmer') { this.addNotification("Log in as Farmer.", "info"); return; }
        const form = this.fundingForm;
        const required = ['title', 'crop', 'acres', 'amount', 'method', 'cid', 'description', 'timeline', 'roi', 'investorShare'];
        if (required.some(field => form[field] === null || form[field] === undefined || (typeof form[field] === 'string' && form[field].trim() === ''))) { this.addNotification("Fill all required fields.", "warning"); return; }
        const parsedAcres = parseFloat(form.acres); const parsedAmount = parseFloat(form.amount);
        const parsedTimeline = parseInt(form.timeline, 10); const parsedRoi = parseFloat(form.roi);
        const parsedInvestorShare = parseFloat(form.investorShare);
        if (isNaN(parsedAcres) || parsedAcres <= 0 || isNaN(parsedAmount) || parsedAmount <= 0 || isNaN(parsedTimeline) || parsedTimeline <= 0 || isNaN(parsedRoi) || parsedRoi < 0 || parsedRoi > 100 || isNaN(parsedInvestorShare) || parsedInvestorShare < 0 || parsedInvestorShare > 100) { this.addNotification("Valid numeric values required.", "warning"); return; }
        if (parsedInvestorShare > 80 && this.role !== 'admin') { this.addNotification("Investor Share cannot exceed 80%.", "warning"); return;}

        const vid = this.farmerVideos.find(v => v.cid === form.cid && v.farmerWallet === this.currentUserIdentifier);
        if (!vid) { this.addNotification("Selected video not found for funding.", "error"); return; }
        if (this.isUsedInFunding(vid.cid)) { this.addNotification("Video already used for a funding request.", "warning"); return; }

        this.loadingMessage = "Creating funding request..."; this.showLoadingModal = true; this.createdFundingRequest = false;
        const newRequest = {
            _id: this.generateId('fundreq_'), title: form.title.trim(), crop: form.crop.trim(), acres: parsedAcres, amount: parsedAmount, fundedAmount: 0,
            method: form.method, cid: form.cid, videoStorageType: vid.storageType, videoFileHash: vid.videoFileHash,
            description: form.description.trim(), timeline: parsedTimeline, roi: parsedRoi, investorShare: parsedInvestorShare,
            farmerWallet: this.currentUserIdentifier, status: 'pending', investors: [], updates: [], createdAt: new Date().toISOString(),
        };
        this.farmerFundingRequests.unshift(newRequest);
        this.allFundingRequests.unshift(newRequest);
        localStorage.setItem('pestivid_farmerFundingRequests', JSON.stringify(this.farmerFundingRequests));
        localStorage.setItem('pestivid_allFundingRequests', JSON.stringify(this.allFundingRequests));
        this.createdFundingRequest = true;
        this.addNotification(`Investment Opportunity: "${newRequest.title}" by ${this.getFarmerDisplayIdentifier(newRequest.farmerWallet)}. Investors will be notified (simulated).`, 'info', null, true);
        this.fundingForm = { title: '', crop: '', acres: null, amount: null, method: '', cid: '', description: '', timeline: null, roi: null, investorShare: null };
        setTimeout(() => { this.createdFundingRequest = false; }, 3000);
        this.showLoadingModal = false; this.loadingMessage = '';
    },
    cancelFundingRequest_V1(requestId) {
        if (!this.isAuthenticated || this.role !== 'farmer') { this.addNotification("Log in as Farmer.", "info"); return; }
        const reqIndex = this.farmerFundingRequests.findIndex(r => r._id === requestId && r.farmerWallet === this.currentUserIdentifier);
        if (reqIndex === -1) { this.addNotification("Request not found.", "error"); return; }
        const req = this.farmerFundingRequests[reqIndex];
        if (req.fundedAmount > 0) { if (!confirm(`Request has ${req.fundedAmount} SOL funding. Cancelling simulates refund. Cancel "${req.title}"?`)) return; }
        else { if (!confirm(`Cancel funding request "${req.title}"?`)) return; }

        this.loadingMessage = "Cancelling request..."; this.showLoadingModal = true;
        this.farmerFundingRequests.splice(reqIndex, 1);
        const allReqIndex = this.allFundingRequests.findIndex(r => r._id === requestId);
        if (allReqIndex > -1) this.allFundingRequests.splice(allReqIndex, 1);
        localStorage.setItem('pestivid_farmerFundingRequests', JSON.stringify(this.farmerFundingRequests));
        localStorage.setItem('pestivid_allFundingRequests', JSON.stringify(this.allFundingRequests));
        this.addNotification(`Request "${req.title}" cancelled. Investors refunded (simulated).`, 'success');
        this.showLoadingModal = false; this.loadingMessage = '';
    },

    // --- Buyer AgriSell ---
    resetBuyerFilters() { this.buyerFilters = {crop:'', location:'', pesticideCompany: ''}; },
    buyListing(listing) {
        if (!this.isAuthenticated || this.role !== 'buyer') { this.addNotification("Log in as Buyer.", "info"); return; }
        if (this.currentUserIdentifier === listing.farmerWallet) { this.addNotification("Cannot buy your own listing.", "warning"); return; }
        this.selectedListing = listing; this.purchaseAmount = parseFloat(listing.minPrice.toFixed(2));
        this.purchaseStatus = ''; this.purchaseError = ''; this.showBuyModal = true;
    },
    closeBuyModal() { this.showBuyModal = false; this.selectedListing = null; this.purchaseAmount = null; },
    processPurchase() {
        if (!this.selectedListing || this.purchaseAmount === null) return;
        const amount = parseFloat(this.purchaseAmount);
        if (isNaN(amount) || amount < this.selectedListing.minPrice || amount > this.selectedListing.maxPrice) { this.purchaseError = `Offer must be between ${this.selectedListing.minPrice} and ${this.selectedListing.maxPrice} SOL.`; return; }

        this.purchaseError = ''; this.purchaseStatus = 'Processing purchase...'; this.loadingMessage = "Processing purchase..."; this.showLoadingModal = true;
        const newPurchase = {
            _id: this.generateId('purch_'), listingId: this.selectedListing._id,
            cid: this.selectedListing.cid, videoStorageType: this.selectedListing.storageType, videoFileHash: this.selectedListing.videoFileHash,
            crop: this.selectedListing.crop, pesticide: this.selectedListing.pesticide, location: this.selectedListing.location, pesticideCompany: this.selectedListing.pesticideCompany,
            price: amount, buyerWallet: this.currentUserIdentifier, farmerWallet: this.selectedListing.farmerWallet,
            purchaseDate: new Date().toISOString(), txHash: this.generateSimulatedTxHash('purch_tx_'),
        };
        this.buyerPurchases.unshift(newPurchase);
        const listingIndexAll = this.allListings.findIndex(l => l._id === this.selectedListing._id);
        if (listingIndexAll > -1) this.allListings.splice(listingIndexAll, 1);
        const listingIndexFarmer = this.farmerListings.findIndex(l => l._id === this.selectedListing._id);
        if (listingIndexFarmer > -1) this.farmerListings[listingIndexFarmer].status = 'sold';

        localStorage.setItem('pestivid_buyerPurchases', JSON.stringify(this.buyerPurchases));
        localStorage.setItem('pestivid_allListings', JSON.stringify(this.allListings));
        localStorage.setItem('pestivid_farmerListings', JSON.stringify(this.farmerListings));

        this.purchaseStatus = `Purchase successful! Tx: ${newPurchase.txHash.substring(0,10)}...`;
        this.addNotification('Purchase successful!', 'success');
        this.addNotification(`Seller ${this.getFarmerDisplayIdentifier(newPurchase.farmerWallet)} notified of sale (simulated).`, 'info', newPurchase.farmerWallet);

        setTimeout(() => { this.closeBuyModal(); }, 2000);
        this.showLoadingModal = false; this.loadingMessage = "";
    },

    // --- Investor Projects ---
    resetInvestorFilters() { this.investorFilters = {crop: '', method: '', minRoi: null, maxAmount: null}; },
    maxInvestmentAmount(project) {
        if (!project || typeof project.amount !== 'number' || typeof project.fundedAmount !== 'number') return 0;
        const remaining = project.amount - project.fundedAmount;
        return Math.max(0, parseFloat(remaining.toFixed(2)));
    },
    investInProject(project) {
        if (!this.isAuthenticated || this.role !== 'investor') { this.addNotification("Log in as Investor.", "info"); return; }
        const amount = this.investmentAmounts[project._id]; this.$set(this.investmentErrors, project._id, '');
        if (!amount || isNaN(amount) || amount <= 0) { this.$set(this.investmentErrors, project._id, 'Invalid amount.'); return; }
        const maxInvest = parseFloat(this.maxInvestmentAmount(project));
        if (amount > maxInvest + 0.001) { this.$set(this.investmentErrors, project._id, `Max ${maxInvest.toFixed(2)} SOL.`); return; }
        const preciseAmount = parseFloat(amount.toFixed(2));

        this.loadingMessage = `Investing ${preciseAmount} SOL...`; this.showLoadingModal = true;
        const newInvestment = {
            _id: this.generateId('invest_'), projectId: project._id, projectTitle: project.title,
            crop: project.crop, method: project.method, acres: project.acres, timeline: project.timeline, roi: project.roi, investorShare: project.investorShare,
            cid: project.cid, videoStorageType: project.videoStorageType, videoFileHash: project.videoFileHash, description: project.description,
            amount: preciseAmount, investorWallet: this.currentUserIdentifier, farmerWallet: project.farmerWallet,
            investmentDate: new Date().toISOString(), status: 'active', progress: 0,
            txHash: this.generateSimulatedTxHash('invest_tx_'), updates: project.updates || []
        };
        this.investorInvestments.unshift(newInvestment);
        const projectIndexAll = this.allFundingRequests.findIndex(r => r._id === project._id);
        if (projectIndexAll > -1) {
            this.allFundingRequests[projectIndexAll].fundedAmount += preciseAmount;
            if (this.allFundingRequests[projectIndexAll].fundedAmount >= this.allFundingRequests[projectIndexAll].amount) {
                this.allFundingRequests[projectIndexAll].status = 'funded';
                this.addNotification(`Project "${project.title}" is now fully funded!`, 'success', project.farmerWallet);
            } else {
                this.allFundingRequests[projectIndexAll].status = 'partially_funded';
            }
             if (!this.allFundingRequests[projectIndexAll].investors) this.allFundingRequests[projectIndexAll].investors = [];
             this.allFundingRequests[projectIndexAll].investors.push({ investorId: this.currentUserIdentifier, amount: preciseAmount });
        }
        const projectIndexFarmer = this.farmerFundingRequests.findIndex(r => r._id === project._id);
        if (projectIndexFarmer > -1) {
            this.farmerFundingRequests[projectIndexFarmer].fundedAmount += preciseAmount;
            this.farmerFundingRequests[projectIndexFarmer].status = this.allFundingRequests[projectIndexAll]?.status || 'partially_funded';
             if (!this.farmerFundingRequests[projectIndexFarmer].investors) this.farmerFundingRequests[projectIndexFarmer].investors = [];
             this.farmerFundingRequests[projectIndexFarmer].investors.push({ investorId: this.currentUserIdentifier, amount: preciseAmount });
        }
        this.investorTransactions.unshift({
            _id: this.generateId('tx_'), userId: this.currentUserIdentifier, txHash: newInvestment.txHash,
            type: 'investment', amount: preciseAmount, projectId: project._id, date: newInvestment.investmentDate, status: 'confirmed'
        });

        localStorage.setItem('pestivid_investorInvestments', JSON.stringify(this.investorInvestments));
        localStorage.setItem('pestivid_allFundingRequests', JSON.stringify(this.allFundingRequests));
        localStorage.setItem('pestivid_farmerFundingRequests', JSON.stringify(this.farmerFundingRequests));
        localStorage.setItem('pestivid_investorTransactions', JSON.stringify(this.investorTransactions));

        this.addNotification(`Investment of ${preciseAmount} SOL successful!`, 'success');
        this.addNotification(`Farmer ${this.getFarmerDisplayIdentifier(project.farmerWallet)} notified of your investment (simulated).`, 'info', project.farmerWallet);
        this.$set(this.investmentAmounts, project._id, null);
        this.showLoadingModal = false; this.loadingMessage = '';
    },

    // --- Investor Portfolio ---
    updateInvestmentProgress() {
        if (!this.isAuthenticated || this.role !== 'investor' || !this.investorInvestments) return;
        const now = new Date();
        this.investorInvestments.forEach(inv => {
            if (inv.status === 'active' || inv.status === 'growing') {
                const investmentDate = new Date(inv.investmentDate);
                const totalDurationMs = (inv.timeline || 1) * 30 * 24 * 60 * 60 * 1000;
                const elapsedMs = now - investmentDate;
                let simulatedProgress = (totalDurationMs > 0) ? Math.min(100, Math.max(0, Math.round((elapsedMs / totalDurationMs) * 100))) : 0;
                let seed = 0; if (inv._id) { for (let i = 0; i < inv._id.length; i++) seed = (seed << 5) - seed + inv._id.charCodeAt(i); seed = Math.abs(seed); }
                const randomIncrement = (seed % 15) + 5;
                simulatedProgress = Math.min(100, Math.max(inv.progress || 0, simulatedProgress + ( (elapsedMs / totalDurationMs > 0.1) ? randomIncrement : 0 ) ) );

                if(simulatedProgress > (inv.progress || 0)){
                    inv.progress = simulatedProgress;
                    if(inv.progress > 0 && inv.status === 'active') inv.status = 'growing';
                }

                if (inv.progress >= 100 && inv.status !== 'harvested' && !inv.payoutNotified) {
                    inv.status = 'harvested';
                    inv.payoutAmount = parseFloat(this.calculateExpectedReturn(inv));
                    inv.payoutDate = new Date().toISOString();
                    inv.payoutTxHash = this.generateSimulatedTxHash('payout_tx_');
                    inv.payoutNotified = true;
                    this.investorTransactions.unshift({
                        _id: this.generateId('tx_'), userId: this.currentUserIdentifier, txHash: inv.payoutTxHash,
                        type: 'payout', amount: inv.payoutAmount, projectId: inv.projectId, date: inv.payoutDate, status: 'confirmed'
                    });
                    this.addNotification(`Harvest Payout for "${inv.projectTitle}": ${inv.payoutAmount.toFixed(2)} SOL processed (simulated).`, 'success', this.currentUserIdentifier);
                    const project = this.allFundingRequests.find(p => p._id === inv.projectId);
                    if (project && project.status !== 'completed') {
                        project.status = 'completed';
                        this.addNotification(`Project "${project.title}" is now completed!`, 'info', project.farmerWallet);
                    }
                }
            }
        });
        localStorage.setItem('pestivid_investorInvestments', JSON.stringify(this.investorInvestments));
        localStorage.setItem('pestivid_investorTransactions', JSON.stringify(this.investorTransactions));
        localStorage.setItem('pestivid_allFundingRequests', JSON.stringify(this.allFundingRequests));
    },
    calculateExpectedReturn(investment) {
         if (!investment || investment.amount === undefined || investment.roi === undefined) return '0.00';
         return (investment.amount * (investment.roi / 100)).toFixed(2);
     },
    viewInvestmentDetails(investment) {
        const projectDetails = this.allFundingRequests.find(p => p._id === investment.projectId) || this.farmerFundingRequests.find(p => p._id === investment.projectId);
        this.selectedInvestment = {
            ...investment,
            description: projectDetails ? projectDetails.description : (investment.description || 'N/A'),
            updates: projectDetails ? (projectDetails.updates || []) : (investment.updates || []),
            cid: projectDetails ? projectDetails.cid : investment.cid,
            videoStorageType: projectDetails ? projectDetails.videoStorageType : investment.videoStorageType,
            videoFileHash: projectDetails ? projectDetails.videoFileHash : investment.videoFileHash,
            investmentDate: investment.investmentDate ? new Date(investment.investmentDate) : null,
            payoutDate: investment.payoutDate ? new Date(investment.payoutDate) : null,
        };
        this.showInvestmentDetailsModal = true;
    },
    solanaExplorerUrl(txHash) { return `https://explorer.solana.com/tx/${txHash}?cluster=devnet`; },

    // --- User Profile & Farmer Profile Modal ---
    async showFarmerProfile(farmerId) {
         if (!farmerId) return;
         this.loadingMessage = "Loading farmer profile..."; this.showLoadingModal = true;
         const farmer = this.users.find(u => u._id === farmerId || u.pestividId === farmerId);
         if (farmer) {
             this.selectedFarmerProfile = {
                 ...farmer, walletAddress: farmer.pestividId,
                 fundingRequestCount: this.allFundingRequests.filter(r => r.farmerWallet === farmer._id && ['pending', 'partially_funded'].includes(r.status)).length,
                 activeListingCount: this.allListings.filter(l => l.farmerWallet === farmer._id && l.status === 'active').length,
                 bio: `${farmer.name} is a dedicated agricultural producer on PestiVid, committed to quality and transparency. (Demo Bio)`,
             };
             this.showFarmerProfileModal = true;
         } else {
             this.addNotification("Farmer profile not found.", "error");
         }
         this.showLoadingModal = false; this.loadingMessage = '';
     },
     closeFarmerProfileModal() { this.showFarmerProfileModal = false; this.selectedFarmerProfile = null; },
     messageFarmerFromProfile() {
        if (this.selectedFarmerProfile && (this.selectedFarmerProfile._id || this.selectedFarmerProfile.walletAddress)) {
            this.startOrGoToConversation(this.selectedFarmerProfile._id || this.selectedFarmerProfile.walletAddress);
            this.closeFarmerProfileModal();
        }
     },
    viewPurchaseVideo(purchase) { this.selectedPurchase = purchase; this.showPurchaseVideo = true; },

    // --- Messaging ---
    loadUserConversations() {
        if (!this.isAuthenticated || !this.currentUserIdentifier) return;
        try {
            this.conversations = JSON.parse(localStorage.getItem('pestivid_conversations') || '[]')
                .filter(c => c.participants.includes(this.currentUserIdentifier))
                .sort((a, b) => new Date(b.lastMessageTimestamp) - new Date(a.lastMessageTimestamp));
        } catch(e) { console.error("Error parsing conversations:", e); this.conversations = []; localStorage.removeItem('pestivid_conversations');}
        try {
            this.messages = JSON.parse(localStorage.getItem('pestivid_messages') || '[]');
        } catch(e) { console.error("Error parsing messages:", e); this.messages = []; localStorage.removeItem('pestivid_messages');}
    },
    loadMessagesForConversation(conversationId) {
        if (!conversationId || !this.isAuthenticated || !this.currentUserIdentifier) return;
        console.log(`Switched to conversation ${conversationId}. Messages should re-filter.`);
    },
    startOrGoToConversation(targetUserId) {
        if (!this.isAuthenticated || !this.currentUserIdentifier || !targetUserId) { this.addNotification("Log in to chat.", "info"); return; }
        if (targetUserId === this.currentUserIdentifier) { this.addNotification("Cannot message yourself.", "warning"); return; }

        let conversation = this.conversations.find(c =>
            c.participants.includes(this.currentUserIdentifier) && c.participants.includes(targetUserId)
        );
        if (!conversation) {
            conversation = {
                _id: this.generateId('conv_'),
                participants: [this.currentUserIdentifier, targetUserId],
                lastMessageSnippet: 'Started a new conversation.',
                lastMessageTimestamp: new Date().toISOString(),
                createdBy: this.currentUserIdentifier,
            };
            this.conversations.unshift(conversation);
            localStorage.setItem('pestivid_conversations', JSON.stringify(this.conversations));
        } else {
            const index = this.conversations.findIndex(c => c._id === conversation._id);
            if (index > 0) { const [movedConv] = this.conversations.splice(index, 1); this.conversations.unshift(movedConv); localStorage.setItem('pestivid_conversations', JSON.stringify(this.conversations));}
        }
        this.addNotification(`Chat with ${this.getFarmerDisplayIdentifier(targetUserId)} ready.`, 'info');
        this.switchPage('messaging');
        this.$nextTick(() => {
             this.activeConversationId = conversation._id;
             this.scrollToMessageBottom();
             this.markConversationAsRead(conversation._id);
        });
    },
    selectConversation(convId) { this.activeConversationId = convId; },
    sendMessage() {
        if (!this.messageInputText.trim() || !this.activeConversationId || !this.isAuthenticated || !this.currentUserIdentifier) return;
        const messageText = this.messageInputText.trim();
        const conversation = this.conversations.find(c => c._id === this.activeConversationId);
        if (!conversation) { this.addNotification("Invalid conversation.", "error"); return; }
        const receiverId = conversation.participants.find(p => p !== this.currentUserIdentifier);
        if (!receiverId) { this.addNotification("Error sending: receiver not found.", "error"); return; }

        const newMessage = {
            _id: this.generateId('msg_'), conversationId: this.activeConversationId,
            sender: this.currentUserIdentifier, receiver: receiverId, text: messageText,
            timestamp: new Date().toISOString(), read: false,
        };
        this.messages.push(newMessage);
        conversation.lastMessageSnippet = messageText.substring(0, 30) + (messageText.length > 30 ? '...' : '');
        conversation.lastMessageTimestamp = newMessage.timestamp;
        const index = this.conversations.findIndex(c => c._id === conversation._id);
        if (index > 0) { const [movedConv] = this.conversations.splice(index, 1); this.conversations.unshift(movedConv); }
        localStorage.setItem('pestivid_messages', JSON.stringify(this.messages));
        localStorage.setItem('pestivid_conversations', JSON.stringify(this.conversations));

        this.messageInputText = '';
        this.$nextTick(() => this.scrollToMessageBottom());
    },
    scrollToMessageBottom() { const el = this.$refs.messageContainer; if (el) setTimeout(() => { el.scrollTop = el.scrollHeight; }, 50); },
    getUnreadCountForConversation(convId) {
        if (!this.isAuthenticated || !this.currentUserIdentifier || !this.messages) return 0;
        return this.messages.filter(msg => msg.conversationId === convId && msg.receiver === this.currentUserIdentifier && !msg.read).length;
    },
    markConversationAsRead(convId) {
        if (!this.isAuthenticated || !this.currentUserIdentifier || !convId) return;
        let changed = false;
        this.messages.forEach(msg => {
            if (msg.conversationId === convId && msg.receiver === this.currentUserIdentifier && !msg.read) {
                msg.read = true; changed = true;
            }
        });
        if(changed) localStorage.setItem('pestivid_messages', JSON.stringify(this.messages));
    },
    getOtherParticipantInitial(conv) {
        const partnerId = conv.participants.find(p => p !== this.currentUserIdentifier);
        const partnerUser = this.users.find(u => u._id === partnerId);
        return partnerUser && partnerUser.name ? partnerUser.name.charAt(0).toUpperCase() : '?';
    },
    getOtherParticipantDisplayAddress(conv) {
        const partnerId = conv.participants.find(p => p !== this.currentUserIdentifier);
        return this.getFarmerDisplayIdentifier(partnerId);
    },

    // --- Notifications ---
    loadUserNotifications() {
        if (!this.isAuthenticated || !this.currentUserIdentifier) return;
        try {
            this.notifications = JSON.parse(localStorage.getItem('pestivid_notifications') || '[]')
                .filter(n => n.recipient === this.currentUserIdentifier || n.global)
                .sort((a,b) => new Date(b.timestamp) - new Date(a.timestamp));
        } catch(e) { console.error("Error parsing notifications:", e); this.notifications = []; localStorage.removeItem('pestivid_notifications');}


        this.notifications.forEach(n => {
            if (!n.read && !this.recentNotifications.some(rn => rn._id === n._id || rn.temp_id === n._id )) {
                this.recentNotifications.push({ ...n, show: false, isTemp: false, temp_id: n._id });
            }
        });
        this.showNextToastNotification();
    },
    addNotification(message, type = 'info', recipientId = null, globalBroadcast = false) {
        const newNotif = {
            _id: this.generateId('notif_'), recipient: recipientId || (globalBroadcast ? null : this.currentUserIdentifier),
            type: type, message: message, timestamp: new Date().toISOString(), read: false,
            global: globalBroadcast, isTemp: true,
        };
        if (recipientId === this.currentUserIdentifier || globalBroadcast || (recipientId === null && !globalBroadcast && this.isAuthenticated)) {
             this.recentNotifications.push({...newNotif, show: false});
             this.showNextToastNotification();
        }
        this.notifications.unshift(newNotif);
        localStorage.setItem('pestivid_notifications', JSON.stringify(this.notifications));
    },
    showNextToastNotification() {
        if (this.recentNotifications.filter(n => n.show).length >= 3) return;
        const nextToastCandidate = this.recentNotifications.find(n => !n.show);
        if (nextToastCandidate) {
            setTimeout(() => {
                const idx = this.recentNotifications.findIndex(n => (n._id === nextToastCandidate._id) || (n.temp_id === nextToastCandidate.temp_id));
                if(idx > -1) {
                     this.$set(this.recentNotifications[idx], 'show', true);
                     const autoDismissDuration = nextToastCandidate.type === 'error' ? 6000 : 4500;
                     this.recentNotifications[idx].timeoutId = setTimeout(() => this.dismissNotification(nextToastCandidate._id || nextToastCandidate.temp_id), autoDismissDuration);
                }
            }, 50);
        }
    },
    dismissNotification(id) {
        const index = this.recentNotifications.findIndex(n => (n._id === id) || (n.temp_id === id));
        if (index > -1) {
            if (this.recentNotifications[index].timeoutId) clearTimeout(this.recentNotifications[index].timeoutId);
            const notificationToDismiss = this.recentNotifications[index];
            this.$set(this.recentNotifications[index], 'show', false);

            const mainNotifIdx = this.notifications.findIndex(n => n._id === (notificationToDismiss._id || notificationToDismiss.temp_id));
            if (mainNotifIdx > -1) {
                 this.$set(this.notifications[mainNotifIdx], 'read', true);
                 localStorage.setItem('pestivid_notifications', JSON.stringify(this.notifications));
            }

            setTimeout(() => {
                const removeIndex = this.recentNotifications.findIndex(n => (n._id === id) || (n.temp_id === id));
                if (removeIndex > -1) {
                    this.recentNotifications.splice(removeIndex, 1);
                    this.$nextTick(() => this.showNextToastNotification());
                }
            }, 400);
        }
    },
    formatTimestamp(isoString, short = false) {
        if (!isoString) return ''; try { const date = new Date(isoString);
        if (short) { const now = new Date(); const diffMs = now - date; const diffMins = Math.round(diffMs / 60000); const diffHours = Math.round(diffMins / 60); const diffDays = Math.round(diffHours / 24);
        if (diffMins < 1) return 'now'; if (diffMins < 60) return `${diffMins}m`; if (diffHours < 24) return `${diffHours}h`; if (diffDays < 7) return `${diffDays}d`; return date.toLocaleDateString(undefined, { month: 'short', day: 'numeric' }); }
        return date.toLocaleString(undefined, { year: 'numeric', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' });
        } catch (e) { console.error("Error formatting timestamp:", e, isoString); return isoString; }
    },

    // --- Plant Recommendation (AI Simulated) ---
    handlePlantImageUpload(event) {
        const file = event.target.files[0];
        if (file) {
            this.plantImageFile = file; if (this.plantImageUrl) URL.revokeObjectURL(this.plantImageUrl);
            this.plantImageUrl = URL.createObjectURL(file); this.plantImageMimeType = file.type;
            this.analysisResultText = ''; this.parsedAnalysis = { plantName: null, diseaseName: null, treatmentRecommended: null }; this.analysisErrorText = '';
        } else { this.plantImageFile = null; if (this.plantImageUrl) URL.revokeObjectURL(this.plantImageUrl); this.plantImageUrl = null; this.plantImageMimeType = null; this.analysisResultText = ''; this.parsedAnalysis = { plantName: null, diseaseName: null, treatmentRecommended: null }; this.analysisErrorText = ''; }
    },
    async analyzePlant() {
        if (!this.plantImageFile) { this.addNotification("Upload plant image first.", "warning"); return; }
        this.analysisInProgress = true; this.analysisResultText = ''; this.parsedAnalysis = { plantName: null, diseaseName: null, treatmentRecommended: null }; this.analysisErrorText = '';
        this.loadingMessage = "Analyzing plant image (simulated)..."; this.showLoadingModal = true;
        await new Promise(resolve => setTimeout(resolve, 1500));

        const fileName = this.plantImageFile.name.toLowerCase();
        let plant = "Unknown Plant", disease = "Unknown Disease", treatment = "General plant care advice: ensure proper watering, sunlight, and soil nutrients. Consult a local expert for specific issues.";
        if (fileName.includes("tomato")) { plant = "Tomato Plant"; if (fileName.includes("blight")) { disease = "Late Blight"; treatment = "Apply copper-based fungicides. Improve air circulation. Remove infected leaves."; } else if (fileName.includes("healthy")) { disease = "Healthy"; treatment = "Maintain good watering and fertilization schedule."; } }
        else if (fileName.includes("rose")) { plant = "Rose Bush"; if (fileName.includes("spot")) { disease = "Black Spot"; treatment = "Use fungicide. Remove fallen leaves. Water at base."; } }
        else { plant = "Generic Leaf"; disease = "Nutrient Deficiency (Potassium)"; treatment = "Apply potassium-rich fertilizer. Check soil pH.";}

        this.analysisResultText = `PLANT: ${plant};\nDISEASE: ${disease};\nTREATMENT: ${treatment}`;
        this.parseAnalysisResult(this.analysisResultText);
        this.addNotification("Plant analysis complete (simulated)!", "success");
        this.analysisInProgress = false; this.showLoadingModal = false; this.loadingMessage = "";
    },
    parseAnalysisResult(text) {
        this.parsedAnalysis = { plantName: null, diseaseName: null, treatmentRecommended: null };
        if (!text || typeof text !== 'string') return;
        const plantMatch = text.match(/PLANT:\s*([^;]+)/i); const diseaseMatch = text.match(/DISEASE:\s*([^;]+)/i); const treatmentMatch = text.match(/TREATMENT:\s*(.+)/is);
        if (plantMatch && plantMatch[1]) this.parsedAnalysis.plantName = plantMatch[1].trim();
        if (diseaseMatch && diseaseMatch[1]) this.parsedAnalysis.diseaseName = diseaseMatch[1].trim();
        if (treatmentMatch && treatmentMatch[1]) this.parsedAnalysis.treatmentRecommended = treatmentMatch[1].trim();
        if (!this.parsedAnalysis.diseaseName || ['Unknown', '-'].includes(this.parsedAnalysis.diseaseName)) { const lowerText = text.toLowerCase(); if (lowerText.includes('healthy')) this.parsedAnalysis.diseaseName = 'Healthy'; else if (lowerText.includes('not apparent')) this.parsedAnalysis.diseaseName = 'Not Apparent'; else if (lowerText.includes('no disease')) this.parsedAnalysis.diseaseName = 'Healthy / Not Apparent';}
    },

    // --- Farmer Chatbot (AgriBot - AI Simulated) ---
    renderMarkdown(text) { if (window.marked) return marked.parse(text || ''); return text || ''; },
    initializeChatbot() {
        if (this.current === 'farmerChatbot' && this.isAuthenticated && this.role === 'farmer') {
            try {
                const storedAgriBotChat = localStorage.getItem(`pestivid_agribot_chat_${this.currentUserIdentifier}`);
                if (storedAgriBotChat) {
                    this.chatMessages = JSON.parse(storedAgriBotChat);
                } else if (this.chatMessages.length === 0) {
                    this.chatMessages.push({ _id: this.generateId('bot_init_'), sender: 'bot', text: "Hello! I'm AgriBot. Ask about tomato blight or strawberry planting.", timestamp: new Date().toISOString() });
                }
            } catch(e) {
                console.error("Error parsing AgriBot chat from localStorage:", e);
                this.chatMessages = [{ _id: this.generateId('bot_init_err_'), sender: 'bot', text: "Hello! I'm AgriBot. Ask about tomato blight or strawberry planting.", timestamp: new Date().toISOString() }];
                localStorage.removeItem(`pestivid_agribot_chat_${this.currentUserIdentifier}`);
            }
        } else if (this.current === 'farmerChatbot' && (!this.isAuthenticated || this.role !== 'farmer')) {
            this.chatMessages = [{ _id: this.generateId('bot_access_'), sender: 'bot', text: "Please log in as a Farmer to use AgriBot." }];
        }
        this.$nextTick(() => this.scrollToChatBottom());
    },
    async sendChatMessage() {
        if (!this.chatInput.trim() || this.isGroqLoading || !this.isAuthenticated || this.role !== 'farmer') return;
        const userMessageText = this.chatInput.trim();
        this.chatMessages.push({ _id: this.generateId('user_'), sender: 'user', text: userMessageText, timestamp: new Date().toISOString() });
        this.chatInput = ''; this.$nextTick(() => this.scrollToChatBottom());
        this.isGroqLoading = true;
        await new Promise(resolve => setTimeout(resolve, 1000));
        let botResponse = "I'm sorry, I can only provide simulated responses in this demo. ";
        if (userMessageText.toLowerCase().includes("tomato blight")) botResponse = "For tomato blight, ensure good air circulation, water at the base of plants, and consider using copper-based fungicides preventatively. Remove and destroy infected plant parts.";
        else if (userMessageText.toLowerCase().includes("strawberry planting")) botResponse = "Plant strawberries in well-drained soil with plenty of organic matter. Space them about 12-18 inches apart. Ensure they get full sun.";
        else if (userMessageText.toLowerCase().includes("hello") || userMessageText.toLowerCase().includes("hi")) botResponse = "Hello there! How can I help you with your farming questions today?";
        else botResponse += `You asked about: "${userMessageText}". For real advice, integrate with a live AI.`;
        this.chatMessages.push({ _id: this.generateId('bot_'), sender: 'bot', text: botResponse, timestamp: new Date().toISOString() });
        if (this.isAuthenticated && this.currentUserIdentifier) {
            localStorage.setItem(`pestivid_agribot_chat_${this.currentUserIdentifier}`, JSON.stringify(this.chatMessages));
        }
        this.isGroqLoading = false; this.$nextTick(() => this.scrollToChatBottom());
    },
    scrollToChatBottom() { const container = this.$refs.chatbotMessagesContainer; if (container) setTimeout(() => { container.scrollTop = container.scrollHeight; }, 50); },

    // --- Avatar Assistant (AI Simulated) ---
    toggleAvatarExpansion(forceState = null) {
        if (!this.isAuthenticated) return; const newState = forceState !== null ? forceState : !this.avatar.expanded; this.avatar.expanded = newState;
        if (this.avatar.expanded) { this.avatar.state = 'listening'; this.markAvatarMessagesAsRead(); this.$nextTick(() => this.scrollToAvatarMessagesBottom()); this.updateAvatarContextAndQuickActions();
            if ('SpeechRecognition' in window || 'webkitSpeechRecognition' in window) { if (!this.speechRecognition) this.initializeSpeechRecognition(); if (this.speechRecognition && !this.avatar.isListening) { try { this.speechRecognition.start(); } catch (e) { console.error("Error starting speech recognition:", e); this.addAvatarMessage("Could not start voice input.", 'bot'); this.avatar.isListening = false; this.avatar.state = 'idle'; }}
            } else { this.addAvatarMessage("Voice input not supported by your browser.", 'bot'); this.avatar.isListening = false;}
        } else { this.avatar.state = 'idle'; if (this.speechRecognition && this.avatar.isListening) this.speechRecognition.stop(); if ('speechSynthesis' in window && speechSynthesis.speaking) { speechSynthesis.cancel(); this.avatar.state = 'idle'; }}
    },
    addAvatarMessage(text, sender, isRead = false) {
        if (!this.isAuthenticated || !this.currentUserIdentifier) return;
        const newMessage = { _id: this.generateId('avatar_msg_'), text: text, sender: sender, timestamp: new Date().toISOString(), readByUser: sender === 'user' ? true : isRead, };
        this.avatar.chatMessages.push(newMessage); this.$nextTick(() => this.scrollToAvatarMessagesBottom());
        localStorage.setItem(`pestivid_avatar_chat_${this.currentUserIdentifier}`, JSON.stringify(this.avatar.chatMessages));
        if (sender === 'bot' && !this.avatar.expanded && 'speechSynthesis' in window) this.speakAvatarResponse(text);
    },
    async sendAvatarMessage() {
        if (!this.avatar.userInput.trim() || this.avatar.isProcessing || !this.isAuthenticated || !this.currentUserIdentifier) return;
        const userText = this.avatar.userInput.trim(); this.addAvatarMessage(userText, 'user');
        this.avatar.userInput = ''; this.avatar.isProcessing = true; this.avatar.state = 'thinking'; this.avatar.quickActions = [];
        await new Promise(resolve => setTimeout(resolve, 1200));

        let botText = `Okay, you said: "${userText}". `;
        if (userText.toLowerCase().includes("help")) botText += "I can help you navigate PestiVid. What would you like to do? Try asking about 'uploading a video' or 'finding investments'. [action:Go to Home]";
        else if (userText.toLowerCase().includes("upload video")) botText += "To upload a video, go to the PestiVid page. [action:Go to PestiVid]";
        else if (userText.toLowerCase().includes("buy crops")) botText += "You can browse and buy crops on the AgriSell Marketplace. [action:Go to Marketplace]";
        else if (userText.toLowerCase().includes("invest")) botText += "Looking for investment opportunities? Check out the Projects page. [action:Go to Projects]";
        else botText += "This is a simulated response. For real assistance, I'd connect to an AI model. How else can I assist? [action:Close Helper]";

        this.addAvatarMessage(botText, 'bot', this.avatar.expanded); this.parseAvatarResponseForActions(botText); this.speakAvatarResponse(botText);
        this.avatar.isProcessing = false; this.avatar.state = this.avatar.isListening ? 'listening' : 'idle';
    },
    parseAvatarResponseForActions(responseText) {
        const actionRegex = /\[action:([^\]]+)\]/gi; let match; const newQuickActions = []; const seenActions = new Set(); let cleanedResponseText = responseText;
        while ((match = actionRegex.exec(responseText)) !== null) {
            const actionTagContent = match[1].trim(); let actionLabel = actionTagContent; let actionTargetPage = null; let isSwitchRoleAction = false; let targetRole = null;
            if (actionTagContent.toLowerCase().startsWith('go to ')) {
                const pageName = actionTagContent.substring('go to '.length).trim();
                actionLabel = `Go to ${pageName}`; const pageNameLower = pageName.toLowerCase();
                if (pageNameLower.includes('pestivid') || pageNameLower.includes('upload')) actionTargetPage = 'farmerPestiVid';
                else if (pageNameLower.includes('marketplace') || pageNameLower.includes('agrisell') || pageNameLower.includes('buy')) actionTargetPage = 'buyerAgriSell';
                else if (pageNameLower.includes('funding') || pageNameLower.includes('get funding')) actionTargetPage = 'farmerFunding';
                else if (pageNameLower.includes('invest') || pageNameLower.includes('projects') || pageNameLower.includes('opportunities')) actionTargetPage = 'investorProjects';
                else if (pageNameLower.includes('portfolio')) actionTargetPage = 'investorPortfolio';
                else if (pageNameLower.includes('profile') || pageNameLower.includes('my account')) actionTargetPage = 'userProfile';
                else if (pageNameLower.includes('messaging') || pageNameLower.includes('chat')) actionTargetPage = 'messaging';
                else if (pageNameLower.includes('plantrecommend') || pageNameLower.includes('plant analysis')) actionTargetPage = 'plantRecommendation';
                else if (pageNameLower.includes('agribot')) actionTargetPage = 'farmerChatbot';
                else if (pageNameLower.includes('home') || pageNameLower.includes('landing')) actionTargetPage = 'landing';
                if (actionTargetPage) { const requiredRole = this.getRoleForPage(actionTargetPage); if (requiredRole && requiredRole !== this.role) { isSwitchRoleAction = true; targetRole = requiredRole; actionLabel = `Switch to ${targetRole.charAt(0).toUpperCase() + targetRole.slice(1)} Role`; }}
            } else if (actionTagContent.toLowerCase() === 'close helper') { actionLabel = 'Close Helper'; actionTargetPage = 'custom_close';}
            if (actionTargetPage && !seenActions.has(actionLabel)) {
                if (isSwitchRoleAction) newQuickActions.push({ id: this.generateId('qa_'), label: actionLabel, customHandler: () => this.switchDemoRoleAndLogin(targetRole) });
                else if (actionTargetPage === 'custom_close') newQuickActions.push({ id: this.generateId('qa_'), label: actionLabel, customHandler: () => this.toggleAvatarExpansion(false) });
                else newQuickActions.push({ id: this.generateId('qa_'), label: actionLabel, targetPage: actionTargetPage });
                seenActions.add(actionLabel);
            }
            cleanedResponseText = cleanedResponseText.replace(match[0], '').trim();
        }
        cleanedResponseText = cleanedResponseText.replace(/\[action:\s*\]/gi, '').trim();
        if (this.avatar.chatMessages.length > 0) { const lastBotMsgIndex = this.avatar.chatMessages.map(msg => msg.sender).lastIndexOf('bot'); if (lastBotMsgIndex !== -1) this.$set(this.avatar.chatMessages[lastBotMsgIndex], 'text', cleanedResponseText); }
        this.avatar.quickActions = newQuickActions.slice(0, 3);
        if (this.avatar.quickActions.length < 3 && !seenActions.has("Close Helper")) this.avatar.quickActions.push({ id: 'qa_close_default', label: "Close Helper", customHandler: () => this.toggleAvatarExpansion(false) });
        if (this.avatar.quickActions.length < 3 && !seenActions.has("Go to Home") && this.current !== 'landing') this.avatar.quickActions.push({ id: 'qa_home_default', label: "Go to Home", targetPage: 'landing' });
        this.avatar.quickActions = this.avatar.quickActions.slice(0, 3);
    },
    switchDemoRoleAndLogin(targetRole) {
         if (!targetRole || !['farmer', 'buyer', 'investor'].includes(targetRole)) return;
          const demoUserForRole = this.users.find(u => u.role === targetRole && u.email.startsWith('demo.'));
          if (!demoUserForRole) { this.addNotification(`Demo user for "${targetRole}" not found.`, 'error'); return; }
         this.addNotification(`Switching to Demo ${targetRole.charAt(0).toUpperCase() + targetRole.slice(1)}... Log in.`, 'info');
         this.logout();
          this.loginForm.email = demoUserForRole.email; this.loginForm.password = demoUserForRole.passwordHash;
          this.loginForm.remember = true; this.showSignup = false;
         this.$nextTick(() => {
               this.addAvatarMessage(`Login form ready for Demo ${targetRole.charAt(0).toUpperCase() + targetRole.slice(1)}. Sign in as "${demoUserForRole.email}".`, 'bot');
               this.speakAvatarResponse(`Login form ready for Demo ${targetRole.charAt(0).toUpperCase() + targetRole.slice(1)}. Sign in.`);
         });
         this.toggleAvatarExpansion(false);
    },
    handleAvatarQuickAction(action) {
          if (action.targetPage) { this.addAvatarMessage(`Okay, going to ${action.label.replace('Go to ','')}...`, 'bot'); this.speakAvatarResponse(`Okay, going to ${action.label.replace('Go to ','')}.`); this.switchPage(action.targetPage); this.toggleAvatarExpansion(false); }
          else if (action.customHandler) action.customHandler();
          this.avatar.quickActions = [];
    },
    getRoleForPage(page) {
         if (page.startsWith('farmerPestiVid') || page.startsWith('farmerAgriStream') || page.startsWith('farmerSell') || page.startsWith('farmerFunding') || page === 'plantRecommendation' || page === 'farmerChatbot') return 'farmer';
         if (page.startsWith('buyerAgriSell')) return 'buyer';
         if (page.startsWith('investorProjects') || page.startsWith('investorPortfolio')) return 'investor';
         if (page === 'userProfile' || page === 'messaging' || page === 'landing') return this.role;
         return null;
    },
    scrollToAvatarMessagesBottom() { const el = this.$refs.avatarMessagesContainer; if (el) setTimeout(() => { el.scrollTop = el.scrollHeight; }, 50); },
    markAvatarMessagesAsRead() {
        if (!this.isAuthenticated || !this.currentUserIdentifier || !this.avatar.chatMessages) return;
        let changed = false;
        this.avatar.chatMessages.forEach(msg => { if (msg.sender === 'bot' && !msg.readByUser) { msg.readByUser = true; changed = true; } });
        if (changed) localStorage.setItem(`pestivid_avatar_chat_${this.currentUserIdentifier}`, JSON.stringify(this.avatar.chatMessages));
    },
    loadAvatarChatHistory() {
        if (!this.isAuthenticated || !this.currentUserIdentifier) return;
        try {
            const storedChat = localStorage.getItem(`pestivid_avatar_chat_${this.currentUserIdentifier}`);
            if (storedChat) { this.avatar.chatMessages = JSON.parse(storedChat); }
            else { this.avatar.chatMessages = []; }
        } catch(e) {
            console.error("Error parsing Avatar chat from localStorage:", e);
            this.avatar.chatMessages = [];
            localStorage.removeItem(`pestivid_avatar_chat_${this.currentUserIdentifier}`);
        }
    },
    speakAvatarResponse(textToSpeak) {
        if (!('speechSynthesis' in window) || !this.avatar.expanded) { this.avatar.state = this.avatar.isListening ? 'listening' : 'idle'; return; }
        speechSynthesis.cancel(); let cleanText = textToSpeak;
        cleanText = cleanText.replace(/[*_~`#\-+\d.\s]+(?=\s)/g, '').trim();
        cleanText = cleanText.replace(/\[action:[^\]]+\]/gi, '').trim();
        cleanText = cleanText.replace(/\s{2,}/g, ' ');
        if (!cleanText) { this.avatar.state = this.avatar.isListening ? 'listening' : 'idle'; return; }
        const utterance = new SpeechSynthesisUtterance(cleanText); utterance.lang = 'en-US'; utterance.pitch = 1.1; utterance.rate = 1.0;
        utterance.onstart = () => { this.avatar.state = 'talking'; };
        utterance.onend = () => { this.$nextTick(() => { this.avatar.state = this.avatar.expanded && this.speechRecognition && this.avatar.isListening ? 'listening' : 'idle'; }); };
        utterance.onerror = (event) => { console.error('SpeechSynthesis Error:', event.error); this.$nextTick(() => { this.avatar.state = this.avatar.expanded && this.speechRecognition && this.avatar.isListening ? 'listening' : 'idle'; this.addNotification(`TTS error: ${event.error}`, 'error'); }); };
        speechSynthesis.speak(utterance);
    },
    initializeSpeechRecognition() {
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        if (!SpeechRecognition) { console.warn("Speech Recognition API not supported."); this.avatar.visible = false; this.addNotification("Voice input not supported by your browser.", 'warning'); return; }
        if (this.speechRecognition) return; console.log("Initializing Speech Recognition..."); this.speechRecognition = new SpeechRecognition();
        this.speechRecognition.continuous = false; this.speechRecognition.lang = 'en-US'; this.speechRecognition.interimResults = false; this.speechRecognition.maxAlternatives = 1;
        this.speechRecognition.onresult = (event) => { const speechResult = event.results[0][0].transcript; console.log("Speech recognized:", speechResult); this.avatar.userInput = speechResult; this.avatar.isListening = false; this.avatar.state = 'idle'; this.sendAvatarMessage(); };
        this.speechRecognition.onspeechend = () => { if (this.avatar.isListening) this.speechRecognition.stop(); };
        this.speechRecognition.onend = () => { this.avatar.isListening = false; if (this.avatar.state === 'listening') this.avatar.state = 'idle'; };
        this.speechRecognition.onnomatch = () => { this.addAvatarMessage("Sorry, I didn't catch that.", 'bot'); this.speakAvatarResponse("Sorry, I didn't catch that."); };
        this.speechRecognition.onerror = (event) => { console.error('Speech recognition error:', event.error); let errorMsg = "Speech error: " + event.error; if (event.error === 'not-allowed' || event.error === 'service-not-allowed') errorMsg = "Mic access denied."; else if (event.error === 'no-speech') errorMsg = "No speech detected."; else if (event.error === 'aborted') return; else if (event.error === 'network') errorMsg = "Network error during speech recognition."; this.addAvatarMessage(`Voice input error: ${errorMsg}`, 'bot'); this.addNotification(`Voice input error: ${errorMsg}`, 'error'); this.avatar.isListening = false; this.avatar.state = 'idle'; };
        this.speechRecognition.onstart = () => { this.avatar.isListening = true; this.avatar.state = 'listening'; };
    },
    toggleAvatarListening() {
        if (!this.isAuthenticated || !this.speechRecognition) { if(!this.speechRecognition) this.addNotification("Voice input not available.", "warning"); return; }
        if (this.avatar.isProcessing) { this.addNotification("Helper is processing. Wait.", "info"); return; }
        if ('speechSynthesis' in window && speechSynthesis.speaking) { speechSynthesis.cancel(); this.avatar.state = 'idle'; }
        if (this.avatar.isListening) { this.speechRecognition.stop(); }
        else { try { this.speechRecognition.start(); } catch (e) { console.error("Error starting speech recognition:", e); let errorMsg = "Could not start voice input. "; if (e.message.includes('already started')) errorMsg = "Voice input already active."; else errorMsg += e.message; this.addNotification(errorMsg, "error"); this.avatar.isListening = false; this.avatar.state = 'idle'; }}
    },
    updateAvatarContextAndQuickActions() {
        let context = ""; let actions = []; const page = this.current; const userRole = this.role;
        if (!this.isAuthenticated) { this.avatar.quickActions = []; this.avatar.currentContextText = "User is not logged in."; return; }
        context += `User role: ${userRole}. Current page: ${page}. `;
        switch(page) {
            case 'landing': context += "Main landing page."; actions.push({ id: 'qa_explore_marketplace', label: "Explore Marketplace", targetPage: 'buyerAgriSell'}); if (userRole === 'farmer') actions.push({ id: 'qa_upload_video', label: "Upload PestiVid", targetPage: 'farmerPestiVid'}); if (userRole === 'investor') actions.push({ id: 'qa_view_projects', label: "View Projects", targetPage: 'investorProjects'}); break;
            case 'farmerPestiVid': context += "PestiVid page for recording/uploading crop videos."; actions.push({ id: 'qa_how_to_record', label: "How to record?", customHandler: () => {this.addAvatarMessage("To record, fill in crop details, then click 'Start Recording'. Allow camera access. After recording, click 'Upload to IPFS (Simulated)'.", "bot"); this.speakAvatarResponse("To record, fill in crop details, then click Start Recording. Allow camera access. After recording, click Upload to IPFS.");} }); actions.push({ id: 'qa_view_my_videos', label: "View My Videos", targetPage: 'farmerAgriStream'}); break;
            case 'farmerAgriStream': context += "Farmer's AgriStream (uploaded videos)."; actions.push({ id: 'qa_create_listing_from_video', label: "Create Listing?", customHandler: () => {this.addAvatarMessage("You can create a listing for sale from any video here. Click 'Create Listing' on a video card.", "bot"); this.speakAvatarResponse("You can create a listing for sale from any video here. Click Create Listing on a video card.");} }); actions.push({ id: 'qa_upload_new_video', label: "Upload New Video", targetPage: 'farmerPestiVid'}); break;
             case 'farmerSell': context += "Farmer is on the page to create a new marketplace listing."; actions.push({ id: 'qa_select_video_for_listing', label: "How to list?", customHandler: () => {this.addAvatarMessage("Select an unlisted video from the dropdown, set your price range, and click 'Create Listing'.", "bot"); this.speakAvatarResponse("Select an unlisted video from the dropdown, set your price range, and click Create Listing.");} }); actions.push({ id: 'qa_view_marketplace', label: "View Marketplace", targetPage: 'buyerAgriSell'}); break;
            case 'farmerFunding': context += "Farmer is on the page to request funding for a project."; actions.push({ id: 'qa_how_to_request_funding', label: "How to request funding?", customHandler: () => {this.addAvatarMessage("Fill in project details, select a relevant video, and submit. Your request will be visible to investors.", "bot"); this.speakAvatarResponse("Fill in project details, select a relevant video, and submit. Your request will be visible to investors.");} }); actions.push({ id: 'qa_view_investor_projects', label: "See Investor View", targetPage: 'investorProjects'}); break;
            case 'plantRecommendation': context += "Farmer is on the Plant Disease Detection & Recommendation page."; actions.push({ id: 'qa_how_plant_analysis_works', label: "How plant analysis works?", customHandler: () => {this.addAvatarMessage("Upload an image of an affected plant. The AI will try to identify it, detect diseases, and suggest treatments. This is simulated for the demo.", "bot");this.speakAvatarResponse("Upload an image of an affected plant. The AI will try to identify it, detect diseases, and suggest treatments. This is simulated for the demo.");} }); break;
            case 'farmerChatbot': context += "Farmer is using the AgriBot assistant."; actions.push({ id: 'qa_ask_about_pests', label: "Ask about pests", customHandler: () => {this.avatar.userInput = "How to control aphids on tomatoes?"; this.sendAvatarMessage();} }); break;
            case 'buyerAgriSell': context += "User (likely Buyer) is browsing the AgriSell marketplace."; actions.push({ id: 'qa_how_to_buy', label: "How to buy?", customHandler: () => {this.addAvatarMessage("Click 'Initiate Purchase' on a listing, enter your offer within the price range, and confirm. This is a simulation.", "bot"); this.speakAvatarResponse("Click Initiate Purchase on a listing, enter your offer within the price range, and confirm. This is a simulation.");} }); if (userRole !== 'buyer') actions.push({ id: 'qa_switch_to_buyer', label: "Switch to Buyer Role", customHandler: () => this.switchDemoRoleAndLogin('buyer') }); break;
            case 'investorProjects': context += "User (likely Investor) is browsing investment opportunities."; actions.push({ id: 'qa_how_to_invest', label: "How to invest?", customHandler: () => {this.addAvatarMessage("Enter your investment amount for a project and click 'Invest Now'. Returns are based on ROI and profit share. This is a simulation.", "bot");this.speakAvatarResponse("Enter your investment amount for a project and click Invest Now. Returns are based on ROI and profit share. This is a simulation.");} }); actions.push({ id: 'qa_view_my_portfolio', label: "My Portfolio", targetPage: 'investorPortfolio'}); if (userRole !== 'investor') actions.push({ id: 'qa_switch_to_investor', label: "Switch to Investor Role", customHandler: () => this.switchDemoRoleAndLogin('investor') }); break;
            case 'investorPortfolio': context += "Investor is viewing their investment portfolio."; actions.push({ id: 'qa_browse_more_projects', label: "Browse More Projects", targetPage: 'investorProjects'}); break;
            case 'userProfile': context += "User is viewing their PestiVid profile."; actions.push({ id: 'qa_edit_profile_info', label: "Edit Profile?", customHandler: () => {this.addAvatarMessage("Profile editing is a planned feature. For now, your info is based on signup details.", "bot");this.speakAvatarResponse("Profile editing is a planned feature. For now, your info is based on signup details.");} }); break;
            case 'messaging': context += "User is on the PestiVid messaging page."; actions.push({ id: 'qa_how_to_start_chat', label: "How to start a chat?", customHandler: () => {this.addAvatarMessage("You can start a new chat from a user's profile, a marketplace listing, or an investment project page by clicking the message icon.", "bot");this.speakAvatarResponse("You can start a new chat from a user's profile, a marketplace listing, or an investment project page by clicking the message icon.");} }); break;
            default: context += "User is on an unspecified page.";
        }
        if (page !== 'landing' && !actions.some(a => a.targetPage === 'landing')) actions.push({ id: 'qa_go_home_generic', label: "Go to Home", targetPage: 'landing'});
        if (!actions.some(a => a.customHandler && a.label.includes("Close Helper"))) actions.push({ id: 'qa_close_helper_generic', label: "Close Helper", customHandler: () => this.toggleAvatarExpansion(false) });
        const uniqueActions = []; const seenLabels = new Set();
        for (const action of actions) { if (!seenLabels.has(action.label)) { uniqueActions.push(action); seenLabels.add(action.label); } if (uniqueActions.length >=3) break; }
        this.avatar.quickActions = uniqueActions.slice(0, 3); this.avatar.currentContextText = context;
        if(this.avatar.expanded && !this.avatar.userInput && !this.avatar.isProcessing) {
            let greeting = `Welcome to the ${page.replace(/([A-Z])/g, ' $1').trim()} page! `;
            if (uniqueActions.length > 0 && uniqueActions[0].label !== "Close Helper" && uniqueActions[0].label !== "Go to Home") { greeting += `You can ${uniqueActions[0].label.toLowerCase().replace('go to ', 'explore the ')}. How can I help?`; }
            else { greeting += "How can I assist you here?"; }
            const lastBotMsg = this.avatar.chatMessages.length > 0 ? this.avatar.chatMessages[this.avatar.chatMessages.length -1] : null;
            if (!lastBotMsg || lastBotMsg.sender === 'user' || !lastBotMsg.text.startsWith("Welcome to the")) { this.addAvatarMessage(greeting, 'bot'); this.speakAvatarResponse(greeting); }
        }
    },

    // --- Lifecycle Hook ---
    async mounted() {
        try {
            const storedUsers = localStorage.getItem('pestivid_users');
            if (storedUsers) this.users = JSON.parse(storedUsers); else localStorage.setItem('pestivid_users', JSON.stringify(this.users));
        } catch (e) { console.error("Error parsing users from localStorage:", e); this.users = []; localStorage.removeItem('pestivid_users');}

        try { this.farmerVideos = JSON.parse(localStorage.getItem('pestivid_farmerVideos') || '[]'); }
        catch (e) { console.error("Error parsing farmerVideos:",e); this.farmerVideos = []; localStorage.removeItem('pestivid_farmerVideos');}
        try { this.farmerListings = JSON.parse(localStorage.getItem('pestivid_farmerListings') || '[]'); }
        catch (e) { console.error("Error parsing farmerListings:",e); this.farmerListings = []; localStorage.removeItem('pestivid_farmerListings');}
        try { this.farmerFundingRequests = JSON.parse(localStorage.getItem('pestivid_farmerFundingRequests') || '[]'); }
        catch (e) { console.error("Error parsing farmerFundingRequests:",e); this.farmerFundingRequests = []; localStorage.removeItem('pestivid_farmerFundingRequests');}
        try { this.buyerPurchases = JSON.parse(localStorage.getItem('pestivid_buyerPurchases') || '[]'); }
        catch (e) { console.error("Error parsing buyerPurchases:",e); this.buyerPurchases = []; localStorage.removeItem('pestivid_buyerPurchases');}
        try { this.investorInvestments = JSON.parse(localStorage.getItem('pestivid_investorInvestments') || '[]'); }
        catch (e) { console.error("Error parsing investorInvestments:",e); this.investorInvestments = []; localStorage.removeItem('pestivid_investorInvestments');}
        try { this.investorTransactions = JSON.parse(localStorage.getItem('pestivid_investorTransactions') || '[]'); }
        catch (e) { console.error("Error parsing investorTransactions:",e); this.investorTransactions = []; localStorage.removeItem('pestivid_investorTransactions');}
        try { this.conversations = JSON.parse(localStorage.getItem('pestivid_conversations') || '[]'); }
        catch (e) { console.error("Error parsing conversations:",e); this.conversations = []; localStorage.removeItem('pestivid_conversations');}
        try { this.messages = JSON.parse(localStorage.getItem('pestivid_messages') || '[]'); }
        catch (e) { console.error("Error parsing messages:",e); this.messages = []; localStorage.removeItem('pestivid_messages');}
        try { this.notifications = JSON.parse(localStorage.getItem('pestivid_notifications') || '[]'); }
        catch (e) { console.error("Error parsing notifications:",e); this.notifications = []; localStorage.removeItem('pestivid_notifications');}

        try {
            this.allListings = JSON.parse(localStorage.getItem('pestivid_allListings') || JSON.stringify(this.farmerListings.filter(l => l.status === 'active')));
        } catch(e) { console.error("Error parsing allListings:",e); this.allListings = []; localStorage.removeItem('pestivid_allListings');}
        try {
            this.allFundingRequests = JSON.parse(localStorage.getItem('pestivid_allFundingRequests') || JSON.stringify(this.farmerFundingRequests.filter(r => ['pending', 'partially_funded'].includes(r.status))));
        } catch(e) { console.error("Error parsing allFundingRequests:",e); this.allFundingRequests = []; localStorage.removeItem('pestivid_allFundingRequests');}


        const rememberedEmail = localStorage.getItem('pestivid_email'); if (rememberedEmail) this.loginForm.email = rememberedEmail;
        const storedToken = localStorage.getItem('pestivid_token');
        const storedUserId = localStorage.getItem('pestivid_user_id'); // This should be the internal _id

        if (storedToken && storedUserId) {
            const user = this.users.find(u => u._id === storedUserId); // Find user by internal _id
            if (user) {
                this.token = storedToken; this.currentUser = { ...user }; this.isAuthenticated = true; this.currentUserIdentifier = user._id;
                this.userName = user.name; this.userEmail = user.email; this.userPhone = user.phone; this.memberSince = user.memberSince;
                axios.defaults.headers.common['Authorization'] = `Bearer ${this.token}`;
                this.addNotification(`Welcome back, ${this.userNameDisplay}! (Session Restored)`, 'success');

                // this.loadUserAppData(); // Will be called by isAuthenticated watcher
                this.avatar.character = this.role || 'farmer';
                if ('speechSynthesis' in window && ('SpeechRecognition' in window || 'webkitSpeechRecognition' in window)) { if (!this.speechRecognition) this.initializeSpeechRecognition(); }
                else { console.warn("Avatar voice features not supported."); this.avatar.visible = false; }
                this.current = 'landing'; this.$nextTick(() => this.getStarted());
            } else { this.logout(); /* Invalid stored user ID */ }
        } else { console.log("No stored session. User not authenticated."); }

        window.addEventListener('beforeunload', () => {
            // Persist all global lists, not just user-filtered ones, to simulate a shared backend for the demo
            localStorage.setItem('pestivid_farmerVideos', JSON.stringify(this.farmerVideos)); // Contains all farmer videos
            localStorage.setItem('pestivid_farmerListings', JSON.stringify(this.farmerListings)); // All farmer listings
            localStorage.setItem('pestivid_farmerFundingRequests', JSON.stringify(this.farmerFundingRequests)); // All funding requests
            localStorage.setItem('pestivid_buyerPurchases', JSON.stringify(this.buyerPurchases)); // All purchases
            localStorage.setItem('pestivid_investorInvestments', JSON.stringify(this.investorInvestments)); // All investments
            localStorage.setItem('pestivid_investorTransactions', JSON.stringify(this.investorTransactions)); // All transactions
            localStorage.setItem('pestivid_conversations', JSON.stringify(this.conversations));
            localStorage.setItem('pestivid_messages', JSON.stringify(this.messages));
            localStorage.setItem('pestivid_notifications', JSON.stringify(this.notifications));
            // Persist public marketplace views as well
            localStorage.setItem('pestivid_allListings', JSON.stringify(this.allListings));
            localStorage.setItem('pestivid_allFundingRequests', JSON.stringify(this.allFundingRequests));

            if(this.isAuthenticated && this.currentUserIdentifier){
                localStorage.setItem(`pestivid_avatar_chat_${this.currentUserIdentifier}`, JSON.stringify(this.avatar.chatMessages));
                localStorage.setItem(`pestivid_agribot_chat_${this.currentUserIdentifier}`, JSON.stringify(this.chatMessages));
            }
        });
    }
}
});
</script>
</body>
</html>